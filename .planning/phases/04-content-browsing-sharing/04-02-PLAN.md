---
phase: 04-content-browsing-sharing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(browse)/series/[slug]/page.tsx
  - src/components/series/series-detail.tsx
  - src/components/series/season-tabs.tsx
  - src/components/series/episode-list-item.tsx
  - src/components/series/creator-info.tsx
  - src/components/share/share-button.tsx
  - src/modules/content/queries/get-series-by-slug.ts
  - src/components/ui/tabs.tsx
  - src/components/ui/avatar.tsx
autonomous: true

must_haves:
  truths:
    - "User can view a series page with full description, creator info, and season/episode listing"
    - "User can switch between seasons via tabs to see different episode lists"
    - "Each episode in the list shows episode number, title, duration, and a link to watch"
    - "Free episodes (1-3) are visually distinguishable from locked episodes in the episode list"
    - "User can share a series via a share button that uses Web Share API on mobile or copies to clipboard on desktop"
  artifacts:
    - path: "src/modules/content/queries/get-series-by-slug.ts"
      provides: "React.cache-wrapped Supabase query for series detail with seasons, episodes, and creator"
      contains: "getSeriesBySlug"
    - path: "src/app/(browse)/series/[slug]/page.tsx"
      provides: "Series detail page as Server Component"
      contains: "getSeriesBySlug"
    - path: "src/components/series/series-detail.tsx"
      provides: "Series header component with title, description, genre, creator info"
      contains: "SeriesDetail"
    - path: "src/components/series/season-tabs.tsx"
      provides: "Season switcher tabs with episode lists"
      contains: "SeasonTabs"
    - path: "src/components/series/episode-list-item.tsx"
      provides: "Episode row with number, title, duration, free/locked indicator"
      contains: "EpisodeListItem"
    - path: "src/components/series/creator-info.tsx"
      provides: "Creator avatar, name, and bio display"
      contains: "CreatorInfo"
    - path: "src/components/share/share-button.tsx"
      provides: "Share button with Web Share API and clipboard fallback"
      contains: "ShareButton"
  key_links:
    - from: "src/app/(browse)/series/[slug]/page.tsx"
      to: "src/modules/content/queries/get-series-by-slug.ts"
      via: "Server Component calls cached getSeriesBySlug"
      pattern: "getSeriesBySlug"
    - from: "src/components/series/season-tabs.tsx"
      to: "src/components/series/episode-list-item.tsx"
      via: "SeasonTabs maps episodes to EpisodeListItem"
      pattern: "EpisodeListItem"
    - from: "src/components/series/episode-list-item.tsx"
      to: "/series/{slug}/episode/{n}"
      via: "Link to episode page for watchable episodes"
      pattern: "href.*episode"
---

<objective>
Build the series detail page with season/episode browsing, creator info, and share functionality. Users landing on /series/{slug} see everything they need to decide whether to watch.

Purpose: Converts browsers into viewers by presenting series content attractively with clear episode navigation and social sharing.
Output: Functional series page at /series/{slug} with seasons, episodes, creator info, and share button.
</objective>

<execution_context>
@/Users/solofilms/.claude/get-shit-done/workflows/execute-plan.md
@/Users/solofilms/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-content-browsing-sharing/04-RESEARCH.md

# Current files to modify
@src/app/(browse)/series/[slug]/page.tsx
@src/db/types.ts
@src/lib/access.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create series data query, install shadcn components, and build share button with sonner</name>
  <files>
    src/modules/content/queries/get-series-by-slug.ts
    src/components/share/share-button.tsx
    src/components/ui/tabs.tsx
    src/components/ui/avatar.tsx
  </files>
  <action>
    1. Install sonner for toast notifications: `pnpm add sonner`
    2. Add shadcn components: `pnpm dlx shadcn@latest add tabs avatar`
    3. Create `src/modules/content/queries/get-series-by-slug.ts`:
       - Import `cache` from `"react"` for request-level deduplication
       - Import `createClient` from `@/lib/supabase/server`
       - Export `getSeriesBySlug = cache(async (slug: string) => { ... })`
       - Query: `supabase.from("series").select("*, profiles!inner(id, display_name, username, avatar_url, bio), seasons(*, episodes(id, episode_number, title, description, duration_seconds, thumbnail_url, status))")`
       - Filter: `.eq("slug", slug).eq("status", "published")`
       - Order: `.order("season_number", { referencedTable: "seasons", ascending: true }).order("episode_number", { referencedTable: "seasons.episodes", ascending: true })`
       - Call `.single()` and return data (or null)
       - This query is cached per request so generateMetadata (Plan 04-03) and page component share the same data without double-fetching
    4. Create `src/components/share/share-button.tsx` (Client Component):
       - `"use client"` directive
       - Import `Share2` from `lucide-react`, `Button` from `@/components/ui/button`, `toast` from `sonner`
       - Props: `{ title: string; text: string; url: string }`
       - handleShare: if `navigator.share && navigator.canShare?.({title, text, url})`, use `navigator.share()` with try/catch (ignore AbortError). Else fallback to `navigator.clipboard.writeText(url)` and show `toast.success("Link copied to clipboard")`
       - Render: `<Button variant="outline" size="sm">` with Share2 icon and "Share" text
    5. Add `<Toaster />` from sonner to `src/app/layout.tsx`:
       - Import `Toaster` from `sonner`
       - Place `<Toaster theme="dark" richColors position="bottom-center" />` inside the ThemeProvider, after NuqsAdapter children (if NuqsAdapter from Plan 04-01 is already there) or after SerwistProvider children
       - Note: This file is also modified by Plan 04-01 (NuqsAdapter). If 04-01 runs first, add Toaster after NuqsAdapter. If 04-02 runs first, add Toaster after SerwistProvider and 04-01 will wrap with NuqsAdapter later. Either order works since they nest independently.
  </action>
  <verify>
    - `pnpm build` passes
    - `src/modules/content/queries/get-series-by-slug.ts` exports getSeriesBySlug wrapped in React.cache
    - `src/components/share/share-button.tsx` exports ShareButton component
    - shadcn tabs and avatar components exist in `src/components/ui/`
    - Sonner Toaster is in root layout
  </verify>
  <done>Data query layer with React.cache deduplication, share button with Web Share API + clipboard fallback, and UI components are ready for the series page.</done>
</task>

<task type="auto">
  <name>Task 2: Build series detail components and rewrite the series page</name>
  <files>
    src/components/series/creator-info.tsx
    src/components/series/episode-list-item.tsx
    src/components/series/season-tabs.tsx
    src/components/series/series-detail.tsx
    src/app/(browse)/series/[slug]/page.tsx
  </files>
  <action>
    1. Create `src/components/series/creator-info.tsx`:
       - Props: `{ displayName: string; username?: string | null; avatarUrl?: string | null; bio?: string | null }`
       - Render: Avatar (using shadcn Avatar with AvatarFallback showing first letter of displayName), display name, and bio snippet (line-clamp-2)
       - Style: horizontal flex layout with avatar on left, text on right
    2. Create `src/components/series/episode-list-item.tsx`:
       - Props: `{ episodeNumber: number; title: string; durationSeconds: number | null; seriesSlug: string; isFree: boolean; isPublished: boolean }`
       - Import `FREE_EPISODE_LIMIT` from `@/lib/access` to determine free status (or accept isFree prop)
       - Render a row with: episode number (padded, e.g., "01"), title, duration formatted as "Xm Ys", and a free/locked indicator
       - Free episodes: show "Free" badge in green. Locked episodes: show lock icon from lucide-react
       - Entire row is a Link to `/series/{seriesSlug}/episode/{episodeNumber}` if published
       - Unpublished episodes: show as disabled/muted (no link, reduced opacity)
       - Hover state: bg-muted/50 transition for interactive feel
    3. Create `src/components/series/season-tabs.tsx` (Client Component):
       - `"use client"` directive (Tabs from shadcn requires client-side interaction)
       - Props: `{ seasons: Array<{ id: string; season_number: number; title: string | null; episodes: Array<...> }>; seriesSlug: string }`
       - Import `FREE_EPISODE_LIMIT` from `@/lib/access`
       - Use shadcn Tabs component: TabsList with TabsTrigger for each season (label: season.title or "Season N"), TabsContent with EpisodeListItem for each episode
       - Default to first season's tab
       - If only one season, still show tab but without the tab switcher row (just show the episode list directly)
    4. Create `src/components/series/series-detail.tsx`:
       - Props: the full series detail data (title, description, genre, thumbnail, view_count, plus creator and season data)
       - Import `getGenreLabel` from `@/config/genres` (shared config created in Plan 04-01 -- if not available yet, import Genre type from db/types and do a simple capitalize fallback)
       - Import `ShareButton` from `@/components/share/share-button`
       - Import `Badge` from `@/components/ui/badge`
       - Layout:
         - Hero area: series thumbnail (or bg-cinema-surface placeholder) at 16:9 aspect ratio
         - Title (text-3xl font-bold), genre badge, view count
         - Description paragraph (text-muted-foreground)
         - Share button (passing series title, description snippet, and URL)
         - CreatorInfo section
         - SeasonTabs section
    5. Rewrite `src/app/(browse)/series/[slug]/page.tsx` (Server Component):
       - Import `getSeriesBySlug` from `@/modules/content/queries/get-series-by-slug`
       - Import `SeriesDetail` from `@/components/series/series-detail`
       - Import `notFound` from `next/navigation` for missing series
       - Fetch series data using `getSeriesBySlug(slug)`
       - If no data, call `notFound()` to trigger the 404 page
       - Render `<SeriesDetail>` with the fetched data in the max-w-7xl container
       - Remove the old placeholder content entirely
       - Note: generateMetadata will be added in Plan 04-03, not here
  </action>
  <verify>
    - `pnpm build` passes with no TypeScript errors
    - Series page at /series/{slug} renders with title, description, genre, creator info, season tabs, and episode list
    - Episode list items show episode number, title, duration, and free/locked indicator
    - Share button is visible and functional (clipboard copy on desktop)
    - Missing series shows 404 via notFound()
  </verify>
  <done>Series detail page displays full series information with season/episode navigation, creator info, free/locked indicators, and a share button. Deep links to episodes work from the episode list.</done>
</task>

</tasks>

<verification>
1. `pnpm build` completes without errors
2. Series page at /series/{slug} shows series detail with description, creator, and seasons
3. Season tabs allow switching between seasons
4. Episode list shows episode numbers, titles, durations, and free/locked status
5. Free episodes (1-3) display "Free" badge; locked episodes show lock icon
6. Episodes link to /series/{slug}/episode/{n}
7. Share button works (clipboard fallback shows toast)
8. Missing series slug triggers 404 page
9. React.cache ensures getSeriesBySlug is deduplicated per request
</verification>

<success_criteria>
- Series detail page fetches data via React.cache-wrapped query
- Seasons are navigable via tabs, episodes listed with free/locked indicators
- Creator info displays avatar, name, and bio
- Share button uses Web Share API with clipboard fallback
- Sonner toast confirms clipboard copy
- Missing series returns 404
</success_criteria>

<output>
After completion, create `.planning/phases/04-content-browsing-sharing/04-02-SUMMARY.md`
</output>
