---
phase: 04-content-browsing-sharing
plan: 03
type: execute
wave: 2
depends_on: ["04-02"]
files_modified:
  - src/app/(browse)/series/[slug]/page.tsx
  - src/app/(browse)/series/[slug]/opengraph-image.tsx
  - src/lib/seo/structured-data.ts
  - src/lib/seo/share.ts
  - src/config/env.ts
autonomous: true

must_haves:
  truths:
    - "Sharing a series link on iMessage, WhatsApp, X, or Facebook renders a rich preview with title, description, and image"
    - "Series pages are indexable by search engines with JSON-LD structured data (TVSeries schema)"
    - "Each series page generates a unique Open Graph image with series title, genre, and creator name"
    - "Series pages use ISR (Incremental Static Regeneration) for fast loading and SEO crawlability"
    - "Free episodes are accessible directly via shared deep links without auth barriers"
  artifacts:
    - path: "src/app/(browse)/series/[slug]/page.tsx"
      provides: "generateMetadata for OG tags + generateStaticParams for ISR + JSON-LD script tag"
      exports: ["generateMetadata", "generateStaticParams", "revalidate"]
    - path: "src/app/(browse)/series/[slug]/opengraph-image.tsx"
      provides: "Dynamic OG image (1200x630 PNG) with series title, genre, creator"
      exports: ["default", "size", "contentType"]
    - path: "src/lib/seo/structured-data.ts"
      provides: "JSON-LD generator for TVSeries schema with nested seasons and episodes"
      contains: "generateSeriesJsonLd"
    - path: "src/lib/seo/share.ts"
      provides: "Smart share link generator with UTM parameters"
      contains: "generateShareUrl"
    - path: "src/config/env.ts"
      provides: "NEXT_PUBLIC_APP_URL environment variable"
      contains: "NEXT_PUBLIC_APP_URL"
  key_links:
    - from: "src/app/(browse)/series/[slug]/page.tsx"
      to: "src/modules/content/queries/get-series-by-slug.ts"
      via: "generateMetadata calls same cached getSeriesBySlug as page component"
      pattern: "getSeriesBySlug"
    - from: "src/app/(browse)/series/[slug]/page.tsx"
      to: "src/lib/seo/structured-data.ts"
      via: "Page renders JSON-LD script tag using generateSeriesJsonLd"
      pattern: "generateSeriesJsonLd"
    - from: "src/app/(browse)/series/[slug]/opengraph-image.tsx"
      to: "Supabase"
      via: "Fetches series data for OG image generation"
      pattern: "createClient"
---

<objective>
Add SEO metadata, Open Graph tags, dynamic OG images, JSON-LD structured data, ISR, and smart share links to series pages. This makes shared links render rich previews on all social platforms and makes series pages discoverable by search engines.

Purpose: Rich social previews drive organic traffic when users share content. SEO indexability enables search engine discovery. Together these are the primary growth channels for a content platform.
Output: Series pages with full OG tags, dynamic OG images, JSON-LD, ISR pre-rendering, and UTM-tracked share links.
</objective>

<execution_context>
@/Users/solofilms/.claude/get-shit-done/workflows/execute-plan.md
@/Users/solofilms/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-content-browsing-sharing/04-RESEARCH.md
@.planning/phases/04-content-browsing-sharing/04-02-SUMMARY.md

# Files modified by this plan (series page from Plan 04-02)
@src/app/(browse)/series/[slug]/page.tsx
@src/modules/content/queries/get-series-by-slug.ts
@src/config/env.ts
@src/db/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SEO utilities, add NEXT_PUBLIC_APP_URL, and build OG image generator</name>
  <files>
    src/config/env.ts
    src/lib/seo/structured-data.ts
    src/lib/seo/share.ts
    src/app/(browse)/series/[slug]/opengraph-image.tsx
  </files>
  <action>
    1. Update `src/config/env.ts`:
       - Add `NEXT_PUBLIC_APP_URL` to the public env vars (not to requiredEnvVars -- it should have a fallback of `http://localhost:3000`)
       - Export via `env.app.url` using `process.env.NEXT_PUBLIC_APP_URL || "http://localhost:3000"`
       - This env var is used in OG tags, canonical URLs, and share links where absolute URLs are required
    2. Create `src/lib/seo/structured-data.ts`:
       - Export `generateSeriesJsonLd(props)` function
       - Props: `{ series, creator, seasons, siteUrl }` where series/creator/seasons match the shape from getSeriesBySlug
       - Returns a JSON-LD object with:
         - `@context: "https://schema.org"`, `@type: "TVSeries"`
         - `name`, `description`, `url` (absolute), `image`, `genre`
         - `creator: { @type: "Person", name }`
         - `containsSeason`: array of `TVSeason` objects, each with `seasonNumber`, `name`, `numberOfEpisodes`, and nested `episode` array of `TVEpisode` objects with `episodeNumber`, `name`, `description`, `url` (absolute), `duration` (ISO 8601: `PT{M}M{S}S`), `thumbnailUrl`
         - `numberOfSeasons`
       - See research Pattern 4 for exact structure
    3. Create `src/lib/seo/share.ts`:
       - Export `generateShareUrl(options)` function
       - Options: `{ slug, episodeNumber?, source?, medium?, campaign? }`
       - Constructs absolute URL using `process.env.NEXT_PUBLIC_APP_URL || "http://localhost:3000"`
       - Appends UTM parameters: `utm_source` (default "share"), `utm_medium` (default "social"), optional `utm_campaign`
       - Returns the full URL string
    4. Create `src/app/(browse)/series/[slug]/opengraph-image.tsx`:
       - Import `ImageResponse` from `next/og`
       - Import `createClient` from `@/lib/supabase/server`
       - Export `const size = { width: 1200, height: 630 }`
       - Export `const contentType = "image/png"`
       - Default export: async function that takes `{ params: { slug: string } }`
       - Fetch series data (title, genre, creator display_name) from Supabase -- use a simple direct query here (NOT the React.cache one, since this is a route handler not a page render)
       - Return `new ImageResponse(JSX)` with:
         - Full-size div with dark gradient background (linear-gradient 135deg from #141414 to #1a1a1a)
         - Series title in large white text (64px, font-weight 700)
         - Genre (uppercased) + "by {creator}" in brand-yellow (#facc15) text (28px)
         - "microshort.tv" in muted gray (#a3a3a3) text (22px)
         - Bottom-right corner: subtle MicroShort branding
       - Handle missing series gracefully: show "MicroShort" default image
       - Do NOT use edge runtime (use default Node.js runtime to avoid Supabase client issues)
  </action>
  <verify>
    - `pnpm build` passes
    - `src/config/env.ts` exports `env.app.url`
    - `src/lib/seo/structured-data.ts` exports `generateSeriesJsonLd`
    - `src/lib/seo/share.ts` exports `generateShareUrl`
    - `src/app/(browse)/series/[slug]/opengraph-image.tsx` exports default, size, contentType
  </verify>
  <done>SEO utilities (JSON-LD generator, share URL builder), NEXT_PUBLIC_APP_URL config, and dynamic OG image generator are ready for series page integration.</done>
</task>

<task type="auto">
  <name>Task 2: Add generateMetadata, JSON-LD, ISR, and generateStaticParams to series page</name>
  <files>
    src/app/(browse)/series/[slug]/page.tsx
  </files>
  <action>
    1. Add `generateMetadata` to `src/app/(browse)/series/[slug]/page.tsx`:
       - Import `Metadata`, `ResolvingMetadata` from `next`
       - Import `getSeriesBySlug` from `@/modules/content/queries/get-series-by-slug`
       - Export async `generateMetadata({ params }, parent)` function
       - Fetch series using the same cached `getSeriesBySlug(slug)` (React.cache ensures single request)
       - Return Metadata object with:
         - `title`: series.title (uses root layout template `%s | MicroShort`)
         - `description`: series.description or fallback `"Watch {title} on MicroShort"`
         - `openGraph.title`, `openGraph.description`, `openGraph.url` (absolute), `openGraph.siteName: "MicroShort"`, `openGraph.type: "video.tv_show"`, `openGraph.locale: "en_US"`
         - `openGraph.images`: if series.thumbnail_url, include with width/height. The opengraph-image.tsx route is auto-linked by Next.js
         - `twitter.card: "summary_large_image"`, `twitter.title`, `twitter.description`
         - `alternates.canonical`: absolute series URL
       - Handle missing series: return `{ title: "Series Not Found" }`
       - Use `process.env.NEXT_PUBLIC_APP_URL || "http://localhost:3000"` for absolute URLs (or import from env config)
    2. Add `generateStaticParams` for ISR:
       - Export async `generateStaticParams()` function
       - Fetch all published series slugs from Supabase: `.from("series").select("slug").eq("status", "published")`
       - Return array of `{ slug }` objects
       - Export `const revalidate = 60` for ISR (revalidate every 60 seconds)
    3. Add JSON-LD structured data to the page component body:
       - Import `generateSeriesJsonLd` from `@/lib/seo/structured-data`
       - After fetching series data (already done in the page component), generate the JSON-LD object
       - Render `<script type="application/ld+json" dangerouslySetInnerHTML={{ __html: JSON.stringify(jsonLd).replace(/</g, "\u003c") }} />` at the top of the returned JSX (before SeriesDetail)
       - Pass siteUrl from env config
    4. Update the ShareButton usage in SeriesDetail (or in the page directly) to use `generateShareUrl` from `@/lib/seo/share` for UTM-tracked share links instead of raw URLs
  </action>
  <verify>
    - `pnpm build` passes with no TypeScript errors
    - View page source at /series/{slug}: `<meta property="og:title">`, `<meta property="og:description">`, `<meta property="og:type" content="video.tv_show">`, `<meta property="og:image">`, `<meta name="twitter:card" content="summary_large_image">` are present
    - View page source: `<script type="application/ld+json">` contains TVSeries structured data
    - The OG image route at /series/{slug}/opengraph-image responds with a PNG image
    - Build output shows series pages as pre-rendered static pages (ISR)
    - `revalidate = 60` is exported
  </verify>
  <done>Series pages have full SEO metadata (OG tags, Twitter cards, JSON-LD structured data), dynamic OG images for social sharing, ISR for performance, and UTM-tracked share links.</done>
</task>

</tasks>

<verification>
1. `pnpm build` completes without errors
2. Series pages have `og:title`, `og:description`, `og:type`, `og:image`, `og:url` meta tags in page source
3. Twitter card meta tags (`twitter:card`, `twitter:title`, `twitter:description`) present
4. JSON-LD `<script>` tag contains `@type: "TVSeries"` with nested seasons and episodes
5. OG image route generates a 1200x630 PNG with series title, genre, and creator name
6. `generateStaticParams` pre-renders published series pages
7. ISR revalidation is set to 60 seconds
8. Share links include UTM parameters (utm_source, utm_medium)
9. Sharing a series URL on social platforms shows rich preview (manual verification)
</verification>

<success_criteria>
- generateMetadata exports full OG + Twitter card metadata for each series page
- opengraph-image.tsx generates unique branded OG images per series
- JSON-LD structured data uses Schema.org TVSeries type with nested seasons/episodes
- ISR with generateStaticParams pre-renders published series for SEO
- Share links include UTM tracking parameters
- Free episode deep links remain accessible without auth barriers (no regression from Phase 2)
</success_criteria>

<output>
After completion, create `.planning/phases/04-content-browsing-sharing/04-03-SUMMARY.md`
</output>
