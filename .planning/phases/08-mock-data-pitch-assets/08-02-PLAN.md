---
phase: 08-mock-data-pitch-assets
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - scripts/seed/index.ts
  - scripts/seed/clear.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Running `pnpm seed` populates the database with 15-25 mock series, creator profiles, seasons, episodes, thumbnails, video assets, and engagement metrics"
    - "Running `pnpm seed:clear` removes all mock data (series, profiles, auth users, storage files, Mux assets) leaving the database clean"
    - "The hero series (SIGNAL LOST) has actual royalty-free stock video clips ingested into Mux for every episode"
    - "All other series have a single branded MicroShort loop clip as their video placeholder"
    - "Pre-generated AI thumbnails are uploaded from local files to Supabase Storage for all series"
    - "Seed script is idempotent -- running it twice does not create duplicate data"
  artifacts:
    - path: "scripts/seed/index.ts"
      provides: "Main seed entry point orchestrating full data population"
      contains: "seedCreators.*seedSeries.*seedEngagement"
    - path: "scripts/seed/clear.ts"
      provides: "Clear script removing all mock data from database, storage, and Mux"
      contains: "mock-.*delete"
    - path: "package.json"
      provides: "pnpm seed, seed:clear, and seed:thumbnails commands"
      contains: "seed.*tsx.*scripts/seed"
  key_links:
    - from: "scripts/seed/index.ts"
      to: "scripts/seed/data/creators.ts"
      via: "Import MOCK_CREATORS for auth user + profile creation"
      pattern: "import.*creators"
    - from: "scripts/seed/index.ts"
      to: "scripts/seed/data/series.ts"
      via: "Import MOCK_SERIES for series/season/episode hierarchy creation"
      pattern: "import.*series"
    - from: "scripts/seed/index.ts"
      to: "Supabase auth.admin.createUser"
      via: "Creates auth users for each mock creator"
      pattern: "auth\\.admin\\.createUser"
    - from: "scripts/seed/index.ts"
      to: "Mux video.assets.create"
      via: "Ingests video URLs into Mux for episodes"
      pattern: "mux\\.video\\.assets\\.create"
    - from: "scripts/seed/clear.ts"
      to: "Supabase + Mux cleanup"
      via: "Deletes mock- prefixed series, mock_ prefixed profiles/auth users, Mux assets"
      pattern: "delete.*mock"
---

<objective>
Wire the seed execution script that transforms mock data definitions into a fully populated platform, and build the clear script for resetting to clean state.

Purpose: With all data definitions and helpers ready from 08-01, this plan orchestrates the actual database population -- creating auth users, profiles, series hierarchies, uploading thumbnails, ingesting video into Mux, and seeding engagement metrics. The clear script enables the "clear and replace with real content" requirement.

Output: Working `pnpm seed` and `pnpm seed:clear` commands that populate and clean the platform.
</objective>

<execution_context>
@/Users/solofilms/.claude/get-shit-done/workflows/execute-plan.md
@/Users/solofilms/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-mock-data-pitch-assets/08-RESEARCH.md
@.planning/phases/08-mock-data-pitch-assets/08-01-SUMMARY.md
@src/db/schema.sql
@src/db/types.ts
@src/app/api/webhooks/mux/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create main seed script with full orchestration</name>
  <files>
    scripts/seed/index.ts
    package.json
  </files>
  <action>
    **Create scripts/seed/index.ts:**
    Main seed entry point that orchestrates the full population sequence. The ordering is CRITICAL due to FK constraints (see pitfall 3 in research):

    **Step 1: Create auth users + profiles (strict FK ordering)**
    - For each MOCK_CREATOR, call `adminDb.auth.admin.createUser({ email, password, email_confirm: true, user_metadata: { display_name, username } })`
    - Then upsert the profile row: `adminDb.from("profiles").upsert({ id: authUser.id, username, display_name, bio, avatar_url, role: "creator", social_links })` with `onConflict: "id"`
    - Store the mapping of creatorIndex -> actual UUID for FK references
    - Use `email_confirm: true` to skip email verification (per research pattern 2)
    - Handle existing users gracefully: if createUser fails with "already registered", look up the existing user by email via `adminDb.auth.admin.listUsers()` and use their ID

    **Step 2: Upload thumbnails from local files**
    - For each series in MOCK_SERIES, upload the pre-generated thumbnail from `scripts/seed/assets/thumbnails/{slug}.png` to Supabase Storage
    - Use the storage helper from lib/storage.ts: `uploadThumbnail(adminDb, localPath, "{creatorId}/{slug}-thumbnail.png")`
    - Store the returned public URLs for series creation
    - If local thumbnail file doesn't exist, log a warning and skip (thumbnails may not be generated yet)

    **Step 3: Create series -> seasons -> episodes hierarchy**
    - For each MOCK_SERIES:
      - Insert series row with creator_id (from Step 1 mapping), thumbnail_url (from Step 2), status: "published", and all metadata
      - For each season: insert with price_cents, status initially "draft" (will update to published after episodes)
      - For each episode in season: insert with title, description, episode_number, status: "draft"
      - Batch-update all episodes in the season to status: "published"
      - Then update the season to status: "published" (MUST happen AFTER episodes are published -- see pitfall 1 in research: `check_season_episode_count` trigger requires 8+ published episodes)
    - Use `upsert` with `onConflict: "slug"` for series to handle idempotent re-runs (see pitfall 6)

    **Step 4: Ingest video into Mux**
    - For the hero series (isHeroSeries: true): source 8+ royalty-free sci-fi stock video URLs from Pixabay (research says 1,400+ free clips available). Use direct MP4 download URLs. Create one Mux asset per episode:
      ```typescript
      const asset = await mux.video.assets.create({
        input: [{ url: videoUrl }],
        playback_policies: ["signed"],
        passthrough: episodeId,
        video_quality: "basic",
      });
      ```
    - For all other series: use a SINGLE branded MicroShort placeholder video URL (host a short loop clip in Supabase Storage or use a placeholder from a public URL). Create one Mux asset and reuse the same `playback_id` for all episodes of that series, OR create one per episode all pointing to the same source URL.
    - IMPORTANT: Don't rely on webhooks for setting playback_id. Instead, poll `mux.video.assets.retrieve(asset.id)` until status is "ready", then extract `playback_ids[0].id` and directly update the episode row:
      ```typescript
      await adminDb.from("episodes").update({
        mux_asset_id: asset.id,
        mux_playback_id: asset.playback_ids?.[0]?.id,
        duration_seconds: null, // Leave NULL -- avoids CHECK constraint issues with stock footage
      }).eq("id", episodeId);
      ```
    - Add a polling helper with timeout (max 60s per asset, poll every 3s)
    - For non-hero series, consider creating assets in batches and polling in parallel to save time

    **Step 5: Seed engagement metrics**
    - Import engagement generators from data/engagement.ts
    - Update series.view_count for each series
    - Seed purchase records for some series/seasons (create mock purchase rows with mock user IDs -- or skip if purchase table requires real Stripe session IDs that can't be mocked)
    - Update profiles.follower_count for each creator
    - Insert follower relationship rows (from mock "viewer" users to creators) -- create a few mock viewer users if needed

    **Step 6: Set featured flags**
    - Mark 3-5 series as featured (is_featured: true) for homepage display
    - The hero series should be featured

    **Add package.json scripts:**
    ```json
    "seed": "tsx --env-file=.env.local scripts/seed/index.ts",
    "seed:clear": "tsx --env-file=.env.local scripts/seed/clear.ts",
    "seed:thumbnails": "tsx --env-file=.env.local scripts/seed/generate-thumbnails.ts"
    ```

    Log progress throughout with console.log for each major step.
  </action>
  <verify>
    - `grep "seed" package.json` -- shows seed, seed:clear, seed:thumbnails scripts
    - `ls scripts/seed/index.ts` -- main seed script exists
    - `grep "auth.admin.createUser" scripts/seed/index.ts` -- creates auth users
    - `grep "mux.video.assets.create" scripts/seed/index.ts` -- ingests video
    - `grep "uploadThumbnail" scripts/seed/index.ts` -- uploads thumbnails
    - `grep "upsert\|onConflict" scripts/seed/index.ts` -- idempotent operations
  </verify>
  <done>
    Main seed script at scripts/seed/index.ts orchestrates full platform population: auth users, profiles, series/season/episode hierarchy, thumbnail uploads, Mux video ingestion, engagement metrics, and featured flags. Package.json has pnpm seed/seed:clear/seed:thumbnails commands. Script respects FK ordering and DB trigger constraints.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create clear script for mock data removal</name>
  <files>
    scripts/seed/clear.ts
  </files>
  <action>
    **Create scripts/seed/clear.ts:**
    Complete cleanup script that removes all mock data, enabling the "clear and replace with real content" requirement (PTCH-03).

    **Cleanup ordering (reverse of creation to respect FK constraints):**

    **Step 1: Identify all mock content**
    - Query all series with `slug LIKE 'mock-%'` to get series IDs
    - Query all profiles with `username LIKE 'mock_%'` to get profile/user IDs
    - Query all episodes with mux_asset_id that belong to mock series

    **Step 2: Clean up Mux assets**
    - For each episode with a mux_asset_id, call `mux.video.assets.delete(assetId)`
    - Wrap each deletion in try/catch -- asset may already be deleted
    - Log count of deleted vs skipped assets

    **Step 3: Clean up Supabase Storage**
    - For each mock creator, list and remove files in their storage path: `adminDb.storage.from("thumbnails").list(creatorId)`
    - Then remove each file: `adminDb.storage.from("thumbnails").remove([paths])`

    **Step 4: Delete database records**
    - Delete mock series: `adminDb.from("series").delete().like("slug", "mock-%")` -- CASCADE handles seasons and episodes
    - Delete follower rows referencing mock creators
    - Delete mock purchase records if any were created
    - Delete engagement/community data tied to mock content

    **Step 5: Delete mock auth users**
    - For each mock profile, call `adminDb.auth.admin.deleteUser(profileId)` -- this also cascades to delete the profile row
    - Handle errors gracefully (user may already be deleted)

    **Step 6: Summary logging**
    - Log total items deleted per category (users, series, Mux assets, storage files)
    - Log "Clear complete!" at the end

    The script must be safe to run multiple times (idempotent cleanup). Running `pnpm seed:clear` on an already-clean database should complete without errors.
  </action>
  <verify>
    - `ls scripts/seed/clear.ts` -- clear script exists
    - `grep "mock-" scripts/seed/clear.ts` -- targets mock- prefixed series
    - `grep "mock_" scripts/seed/clear.ts` -- targets mock_ prefixed profiles
    - `grep "mux.video.assets.delete" scripts/seed/clear.ts` -- cleans up Mux assets
    - `grep "auth.admin.deleteUser" scripts/seed/clear.ts` -- removes auth users
    - `grep "storage" scripts/seed/clear.ts` -- cleans up storage files
  </verify>
  <done>
    Clear script at scripts/seed/clear.ts safely removes all mock data: Mux assets, Supabase Storage files, database records (series cascade), and auth users. Running `pnpm seed:clear` on an empty database completes without errors. The platform can be cleared and repopulated with real content.
  </done>
</task>

</tasks>

<verification>
- `pnpm seed` script is defined in package.json and references scripts/seed/index.ts
- `pnpm seed:clear` script is defined in package.json and references scripts/seed/clear.ts
- Seed script creates auth users before profiles before series (FK ordering)
- Seed script publishes episodes before seasons (trigger constraint)
- Seed script uses upsert for idempotent re-runs
- Hero series uses real video URLs, other series use branded placeholder
- Clear script removes Mux assets, Storage files, DB records, and auth users
- Both scripts handle errors gracefully and log progress
</verification>

<success_criteria>
Running `pnpm seed` populates the platform with 15-25 series across all genres, complete with creator profiles, thumbnails, video, and engagement data. Running `pnpm seed:clear` removes all mock data cleanly. Running seed twice does not create duplicates.
</success_criteria>

<output>
After completion, create `.planning/phases/08-mock-data-pitch-assets/08-02-SUMMARY.md`
</output>
