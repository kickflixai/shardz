---
phase: 07-admin-panel
plan: 04
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/modules/admin/queries/get-platform-metrics.ts
  - src/app/(admin)/admin/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin dashboard shows total users, active creators, published series, and total revenue"
    - "Admin dashboard shows recent activity (latest signups, purchases, applications)"
    - "Platform metrics are computed from real database data, not placeholders"
  artifacts:
    - path: "src/modules/admin/queries/get-platform-metrics.ts"
      provides: "Aggregate platform metrics from all tables"
      exports: ["getPlatformMetrics", "getRecentActivity"]
    - path: "src/app/(admin)/admin/page.tsx"
      provides: "Admin dashboard with live platform metrics"
      min_lines: 40
  key_links:
    - from: "src/app/(admin)/admin/page.tsx"
      to: "src/modules/admin/queries/get-platform-metrics.ts"
      via: "getPlatformMetrics and getRecentActivity queries"
      pattern: "getPlatformMetrics|getRecentActivity"
    - from: "src/modules/admin/queries/get-platform-metrics.ts"
      to: "src/lib/supabase/admin.ts"
      via: "createAdminClient() for cross-user aggregate queries"
      pattern: "createAdminClient"
---

<objective>
Build the platform metrics dashboard that replaces the admin placeholder page, giving operators real-time visibility into platform health (ADMN-04, ADMN-05).

Purpose: Platform operators need to monitor key health metrics at a glance -- user growth, content volume, revenue, and creator activity. This is essential for business decisions and pitch readiness.
Output: Live admin dashboard with metric cards, recent activity feed, and content moderation capability.
</objective>

<execution_context>
@/Users/solofilms/.claude/get-shit-done/workflows/execute-plan.md
@/Users/solofilms/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-admin-panel/07-RESEARCH.md
@.planning/phases/07-admin-panel/07-01-SUMMARY.md

Reference patterns from:
@src/modules/creator/queries/get-creator-analytics.ts (aggregate query pattern)
@src/app/(admin)/admin/page.tsx (existing placeholder to replace)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Platform metrics queries and admin dashboard page</name>
  <files>
    src/modules/admin/queries/get-platform-metrics.ts
    src/app/(admin)/admin/page.tsx
  </files>
  <action>
    1. Create `src/modules/admin/queries/get-platform-metrics.ts`:
       - Import `cache` from `react`
       - Import `createAdminClient` from `@/lib/supabase/admin`

       - Export `getPlatformMetrics = cache(async () => { ... })`:
         - Create admin client
         - Run parallel queries using `Promise.all`:
           a. Total users: `adminDb.from("profiles").select("id", { count: "exact", head: true })`
           b. Active creators: `adminDb.from("profiles").select("id", { count: "exact", head: true }).eq("role", "creator")`
           c. Admin count: `adminDb.from("profiles").select("id", { count: "exact", head: true }).eq("role", "admin")`
           d. Published series: `adminDb.from("series").select("id", { count: "exact", head: true }).eq("status", "published")`
           e. Draft series: `adminDb.from("series").select("id", { count: "exact", head: true }).eq("status", "draft")`
           f. Total episodes: `adminDb.from("episodes").select("id", { count: "exact", head: true })`
           g. Completed purchases: `adminDb.from("purchases").select("amount_cents, creator_share_cents, platform_fee_cents").eq("status", "completed")`
           h. Pending applications: `adminDb.from("creator_applications").select("id", { count: "exact", head: true }).eq("status", "pending")`
         - Compute from purchases data:
           - `totalRevenueCents`: sum of `amount_cents`
           - `platformFeeCents`: sum of `platform_fee_cents`
           - `creatorPayoutsCents`: sum of `creator_share_cents`
           - `totalPurchases`: length of purchases array
         - Return typed object with all metrics

       - Export `getRecentActivity = cache(async () => { ... })`:
         - Create admin client
         - Run parallel queries:
           a. Recent signups: `adminDb.from("profiles").select("id, username, display_name, role, created_at").order("created_at", { ascending: false }).limit(5)`
           b. Recent purchases: `adminDb.from("purchases").select("id, amount_cents, created_at, seasons!inner(series!inner(title))").eq("status", "completed").order("created_at", { ascending: false }).limit(5)`
           c. Recent applications: `adminDb.from("creator_applications").select("id, display_name, status, created_at").order("created_at", { ascending: false }).limit(5)`
         - Return typed object with `{ recentSignups, recentPurchases, recentApplications }`

    2. Replace `src/app/(admin)/admin/page.tsx` (the existing placeholder):
       - Server component, call `requireAdmin()` at top
       - Call `getPlatformMetrics()` and `getRecentActivity()`

       - Page layout:

       **Heading**: "Admin Dashboard"

       **Metric Cards Row** (grid: 1 col mobile, 2 md, 4 lg):
       Format cents as dollars where applicable using `(cents / 100).toFixed(2)`.
       - Card 1: "Total Users" -- `totalUsers` count, with icon (users icon)
       - Card 2: "Active Creators" -- `activeCreators` count, with icon (star icon)
       - Card 3: "Published Series" -- `publishedSeries` count, with icon (film icon)
       - Card 4: "Total Revenue" -- `$XX.XX` formatted from `totalRevenueCents`, with icon (dollar icon)

       **Secondary Stats Row** (grid: 1 col mobile, 2 md, 4 lg):
       - "Platform Fees": `$XX.XX` from platformFeeCents
       - "Creator Payouts": `$XX.XX` from creatorPayoutsCents
       - "Total Purchases": count
       - "Pending Applications": count (link to /admin/applications)

       **Quick Links Row** (grid of action cards):
       - "Review Applications" -> `/admin/applications` (show pending count badge)
       - "Manage Content" -> `/admin/content`
       - "Curate Homepage" -> `/admin/homepage`
       - "View Revenue" -> `/admin/revenue`

       **Recent Activity** (three columns on desktop, stacked on mobile):
       - Column 1: "Recent Signups" -- list of 5 most recent users (username, role badge, relative time)
       - Column 2: "Recent Purchases" -- list of 5 most recent purchases (series title, amount formatted, relative time)
       - Column 3: "Recent Applications" -- list of 5 most recent applications (display_name, status badge, relative time)

       - Use a helper function `formatRelativeTime(dateString: string)` that returns "2m ago", "1h ago", "3d ago" etc.
         Simple implementation: compute diff in seconds, then format as minutes/hours/days.

       - Use lucide-react icons for metric cards: `Users`, `Star`, `Film`, `DollarSign` (or similar)

       - Styling: match existing metric card pattern from creator dashboard
         - Cards: `rounded-lg border border-border bg-card p-6`
         - Metric value: `text-2xl font-bold text-foreground`
         - Label: `text-sm text-muted-foreground`
  </action>
  <verify>
    - `npx biome check --no-errors-on-unmatched src/modules/admin/queries/get-platform-metrics.ts "src/app/(admin)/admin/page.tsx"` passes
    - `pnpm tsc --noEmit` passes
    - Navigate to `/admin` as admin user -- shows real metric data (not placeholder dashes)
    - Metric cards show correct counts from database
  </verify>
  <done>
    Admin dashboard displays live platform metrics (users, creators, series, revenue, fees, payouts, purchases, pending applications), quick action links, and recent activity feeds for signups, purchases, and applications. Content moderation is handled via the archive/restore actions in Plan 07-02.
  </done>
</task>

</tasks>

<verification>
- Admin dashboard at `/admin` shows real metric values instead of `--` placeholders
- Total users, active creators, published series, and revenue are computed from actual database data
- Recent activity shows the latest 5 signups, purchases, and applications
- Quick links navigate to the correct admin pages
- Content moderation (ADMN-05) is covered by the archive/restore actions in Plan 07-02
</verification>

<success_criteria>
- Platform metrics are derived from real database aggregations, not hardcoded values
- Admin has a single-page overview of platform health
- Recent activity provides at-a-glance operational awareness
- Dashboard is the landing page for the admin panel with quick navigation to all admin functions
</success_criteria>

<output>
After completion, create `.planning/phases/07-admin-panel/07-04-SUMMARY.md`
</output>
