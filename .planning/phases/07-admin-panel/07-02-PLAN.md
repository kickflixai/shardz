---
phase: 07-admin-panel
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/modules/admin/queries/get-admin-entities.ts
  - src/modules/admin/actions/users.ts
  - src/modules/admin/actions/content.ts
  - src/app/(admin)/admin/creators/page.tsx
  - src/app/(admin)/admin/creators/[id]/page.tsx
  - src/app/(admin)/admin/content/page.tsx
  - src/app/(admin)/admin/content/[id]/page.tsx
  - src/app/(admin)/admin/users/page.tsx
  - src/app/(admin)/admin/users/[id]/page.tsx
  - src/app/(admin)/admin/revenue/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can browse all creators with search and see their series, revenue, and status"
    - "Admin can browse all series with search and view seasons and episodes"
    - "Admin can browse all users with search and see their role and account details"
    - "Admin can view a revenue overview with all completed purchases"
    - "Admin can edit a user's role (viewer, creator, admin)"
  artifacts:
    - path: "src/modules/admin/queries/get-admin-entities.ts"
      provides: "Admin data queries for all entity types"
      exports: ["getAdminCreators", "getAdminSeries", "getAdminUsers", "getAdminRevenue"]
    - path: "src/modules/admin/actions/users.ts"
      provides: "User management actions (role change)"
      exports: ["updateUserRole"]
    - path: "src/app/(admin)/admin/creators/page.tsx"
      provides: "Creators browse page with search"
      min_lines: 30
    - path: "src/app/(admin)/admin/content/page.tsx"
      provides: "Content (series) browse page with search"
      min_lines: 30
    - path: "src/app/(admin)/admin/users/page.tsx"
      provides: "Users browse page with search"
      min_lines: 30
    - path: "src/app/(admin)/admin/revenue/page.tsx"
      provides: "Revenue overview page with purchase list"
      min_lines: 30
  key_links:
    - from: "src/app/(admin)/admin/creators/page.tsx"
      to: "src/modules/admin/queries/get-admin-entities.ts"
      via: "getAdminCreators query"
      pattern: "getAdminCreators"
    - from: "src/app/(admin)/admin/users/[id]/page.tsx"
      to: "src/modules/admin/actions/users.ts"
      via: "updateUserRole action"
      pattern: "updateUserRole"
    - from: "src/modules/admin/queries/get-admin-entities.ts"
      to: "src/lib/supabase/admin.ts"
      via: "createAdminClient() for cross-user data access"
      pattern: "createAdminClient"
---

<objective>
Build the entity management pages for all platform data -- creators, content, users, and revenue (ADMN-02).

Purpose: Admin needs to browse, search, and manage all platform entities to operate the marketplace. This is the core admin CRUD capability.
Output: Four browse pages with search, four detail pages with entity info, and admin actions for user management.
</objective>

<execution_context>
@/Users/solofilms/.claude/get-shit-done/workflows/execute-plan.md
@/Users/solofilms/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-admin-panel/07-RESEARCH.md
@.planning/phases/07-admin-panel/07-01-SUMMARY.md

Reference patterns from:
@src/modules/creator/queries/get-creator-analytics.ts (query pattern with React.cache)
@src/app/(browse)/browse/page.tsx (browse page with search/filter pattern using nuqs)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin entity queries and user management actions</name>
  <files>
    src/modules/admin/queries/get-admin-entities.ts
    src/modules/admin/actions/users.ts
    src/modules/admin/actions/content.ts
  </files>
  <action>
    1. Create `src/modules/admin/queries/get-admin-entities.ts`:
       - Import `createAdminClient` from `@/lib/supabase/admin`

       - Export `getAdminCreators(search?: string)`:
         - Query `profiles` where `role = 'creator'`
         - Select: `id, username, display_name, avatar_url, bio, role, follower_count, created_at`
         - If search provided, use `.or(\`display_name.ilike.%${search}%,username.ilike.%${search}%\`)`
         - Order by `created_at` descending
         - Limit 50
         - For each creator, also fetch their series count and total view_count using a join or subquery:
           Use `.select('id, username, display_name, avatar_url, bio, role, follower_count, created_at, series(count)')` to get inline count
         - Return typed array

       - Export `getAdminSeries(search?: string)`:
         - Query `series` table
         - Select: `id, title, slug, genre, status, is_featured, view_count, thumbnail_url, created_at, profiles!creator_id(display_name, username)`
         - Also select season count inline: include `seasons(count)` in select
         - If search, use `.ilike('title', \`%${search}%\`)`
         - Order by `created_at` descending
         - Limit 50
         - Return typed array

       - Export `getAdminUsers(search?: string)`:
         - Query `profiles` table (all roles)
         - Select: `id, username, display_name, avatar_url, role, created_at`
         - If search, use `.or(\`display_name.ilike.%${search}%,username.ilike.%${search}%\`)`
         - Order by `created_at` descending
         - Limit 50
         - Return typed array

       - Export `getAdminRevenue()`:
         - Query `purchases` table
         - Select: `id, amount_cents, creator_share_cents, platform_fee_cents, status, created_at, season_id, user_id, creator_id, profiles!user_id(username), seasons!inner(title:series_id, series!inner(title))`
         - Filter `status = 'completed'`
         - Order by `created_at` descending
         - Limit 100
         - Return typed array

    2. Create `src/modules/admin/actions/users.ts`:
       - `"use server"` directive
       - Import `requireAdmin`, `createAdminClient`, `revalidatePath`
       - Export `updateUserRole(userId: string, newRole: "viewer" | "creator" | "admin")`:
         a. Call `requireAdmin()`
         b. Create admin client
         c. Update `profiles` where `id = userId`, set `role = newRole`
         d. `revalidatePath("/admin/users")`
         e. Return `{ success: true }`

    3. Create `src/modules/admin/actions/content.ts`:
       - `"use server"` directive
       - Import `requireAdmin`, `createAdminClient`, `revalidatePath`
       - Export `archiveSeries(seriesId: string)`:
         a. Call `requireAdmin()`
         b. Create admin client
         c. Update `series` where `id = seriesId`, set `status = 'archived'`
         d. `revalidatePath("/admin/content")`
         e. `revalidatePath("/browse")` (public page also affected)
         f. Return `{ success: true }`
       - Export `restoreSeries(seriesId: string)`:
         a. Same as archive but set `status = 'draft'`
         b. Revalidate same paths
  </action>
  <verify>
    - `npx biome check --no-errors-on-unmatched src/modules/admin/queries/get-admin-entities.ts src/modules/admin/actions/users.ts src/modules/admin/actions/content.ts` passes
    - `pnpm tsc --noEmit` passes
  </verify>
  <done>
    Admin entity queries return typed data for creators, series, users, and revenue. User role update and content archive/restore actions are functional.
  </done>
</task>

<task type="auto">
  <name>Task 2: Entity browse and detail pages (creators, content, users, revenue)</name>
  <files>
    src/app/(admin)/admin/creators/page.tsx
    src/app/(admin)/admin/creators/[id]/page.tsx
    src/app/(admin)/admin/content/page.tsx
    src/app/(admin)/admin/content/[id]/page.tsx
    src/app/(admin)/admin/users/page.tsx
    src/app/(admin)/admin/users/[id]/page.tsx
    src/app/(admin)/admin/revenue/page.tsx
  </files>
  <action>
    All pages follow the same pattern: server component, call `requireAdmin()`, read `searchParams` for search query, call appropriate query, render table/card list.

    **Search pattern for all browse pages:**
    - Read `searchParams.search` (await searchParams for Next.js 16)
    - Render a search input at the top (use a client component `AdminSearch` that updates URL via `router.push` with debounce or form submission)
    - Create a shared `AdminSearch` client component (can be in a shared file like `src/app/(admin)/admin/_components/admin-search.tsx`):
      - `"use client"`, takes current search value as prop
      - Input with onChange that updates `?search=` URL param via `useRouter` + `useSearchParams`
      - Use simple form submission pattern (not real-time debounce) to keep it simple: a form with input name="search" and submit button

    1. **Creators browse** (`/admin/creators/page.tsx`):
       - Call `getAdminCreators(search)`
       - Render table with columns: Avatar + Name, Username, Series Count, Followers, Joined
       - Each row links to `/admin/creators/[id]`
       - Empty state: "No creators found"

    2. **Creator detail** (`/admin/creators/[id]/page.tsx`):
       - Fetch profile by id via admin client: select `*, series(id, title, slug, status, view_count, created_at)`
       - If not found, `notFound()`
       - Show: avatar, display_name, username, bio, social_links, role, follower_count, created_at
       - Show their series as a list (title, status, views, created date)
       - Link to each series at `/admin/content/[seriesId]`
       - Back link to `/admin/creators`

    3. **Content browse** (`/admin/content/page.tsx`):
       - Call `getAdminSeries(search)`
       - Render table with columns: Thumbnail + Title, Creator, Genre, Status, Views, Featured, Created
       - Status badge colors: published (green), draft (gray), archived (red)
       - Featured indicator: star icon if `is_featured`
       - Each row links to `/admin/content/[id]`

    4. **Content detail** (`/admin/content/[id]/page.tsx`):
       - Fetch series by id via admin client with joins: `*, profiles!creator_id(display_name, username), seasons(*, episodes(id, title, status, sort_order))`
       - Show: title, slug, genre, status, description, view_count, is_featured, created_at, creator info
       - List seasons with their episodes inline
       - Action buttons:
         - If status is "published" or "draft": "Archive" button calling `archiveSeries` action
         - If status is "archived": "Restore" button calling `restoreSeries` action
       - Use a small client component for the archive/restore button with form action
       - Back link to `/admin/content`

    5. **Users browse** (`/admin/users/page.tsx`):
       - Call `getAdminUsers(search)`
       - Render table with columns: Avatar + Name, Username, Role, Joined
       - Role badge colors: viewer (gray), creator (blue), admin (yellow/primary)
       - Each row links to `/admin/users/[id]`

    6. **User detail** (`/admin/users/[id]/page.tsx`):
       - Fetch profile by id via admin client
       - Show: avatar, display_name, username, bio, role, created_at
       - Role management: a select dropdown (viewer, creator, admin) with a "Save" button
       - Use a client component for the role change form with `updateUserRole` action
       - Show user's purchases (if any) via admin client query on `purchases` table
       - Back link to `/admin/users`

    7. **Revenue page** (`/admin/revenue/page.tsx`):
       - Call `getAdminRevenue()`
       - At top: summary cards showing total revenue, platform fees, creator payouts (computed from query results)
       - Below: table of recent purchases with columns: Date, User, Series, Amount, Platform Fee, Creator Share, Status
       - Format cents as dollars: `(cents / 100).toFixed(2)`
       - No detail page needed for revenue (it's read-only)
  </action>
  <verify>
    - `npx biome check --no-errors-on-unmatched "src/app/(admin)/admin/creators/**/*.tsx" "src/app/(admin)/admin/content/**/*.tsx" "src/app/(admin)/admin/users/**/*.tsx" "src/app/(admin)/admin/revenue/**/*.tsx"` passes
    - `pnpm tsc --noEmit` passes
    - All pages render without errors when navigated to as admin
  </verify>
  <done>
    Admin can browse and search creators, content (series), and users. Admin can view detail pages for each entity. Admin can change user roles. Admin can archive and restore series. Revenue page shows purchase history with summary metrics.
  </done>
</task>

</tasks>

<verification>
- All entity browse pages load and display data from the database
- Search filtering works on creators, content, and users pages
- Creator detail page shows the creator's series list
- Content detail page shows seasons and episodes, with archive/restore actions
- User detail page allows role changes (viewer, creator, admin)
- Revenue page shows purchase history and summary totals
</verification>

<success_criteria>
- Admin can browse, search, and view details for creators, series, users, and revenue
- Admin can edit user roles
- Admin can archive and restore series for moderation
- All pages use requireAdmin() for role gating
- All data queries use createAdminClient() for cross-user access
</success_criteria>

<output>
After completion, create `.planning/phases/07-admin-panel/07-02-SUMMARY.md`
</output>
