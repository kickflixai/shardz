---
phase: 07-admin-panel
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/admin/require-admin.ts
  - src/app/(admin)/forbidden.tsx
  - next.config.ts
  - src/components/layout/sidebar.tsx
  - supabase/migrations/00000000000005_admin_panel.sql
  - src/db/schema.sql
  - src/modules/admin/actions/applications.ts
  - src/app/(admin)/admin/applications/page.tsx
  - src/app/(admin)/admin/applications/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Non-admin users see a 403 Forbidden page when navigating to /admin routes"
    - "Admin can view a list of pending creator applications at /admin/applications"
    - "Admin can approve a creator application, promoting the user to creator role"
    - "Admin can reject a creator application with feedback notes"
    - "Admin sidebar shows Applications, Revenue, and Homepage nav items"
  artifacts:
    - path: "src/lib/admin/require-admin.ts"
      provides: "Shared admin role guard utility"
      exports: ["requireAdmin"]
    - path: "src/app/(admin)/forbidden.tsx"
      provides: "403 Forbidden page for non-admin users"
      min_lines: 10
    - path: "supabase/migrations/00000000000005_admin_panel.sql"
      provides: "DB migration for featured_sort_order, editorial_picks table, admin RLS policies"
      contains: "editorial_picks"
    - path: "src/modules/admin/actions/applications.ts"
      provides: "Server actions for reviewing creator applications"
      exports: ["reviewApplication"]
    - path: "src/app/(admin)/admin/applications/page.tsx"
      provides: "Pending applications list page"
      min_lines: 20
    - path: "src/app/(admin)/admin/applications/[id]/page.tsx"
      provides: "Application detail with approve/reject form"
      min_lines: 30
  key_links:
    - from: "src/app/(admin)/admin/applications/[id]/page.tsx"
      to: "src/modules/admin/actions/applications.ts"
      via: "form action calling reviewApplication"
      pattern: "reviewApplication"
    - from: "src/modules/admin/actions/applications.ts"
      to: "src/lib/admin/require-admin.ts"
      via: "requireAdmin() call at top of action"
      pattern: "requireAdmin"
    - from: "src/modules/admin/actions/applications.ts"
      to: "src/lib/supabase/admin.ts"
      via: "createAdminClient() for cross-user data operations"
      pattern: "createAdminClient"
---

<objective>
Set up the admin panel infrastructure and implement the creator application review workflow (ADMN-01).

Purpose: All admin pages depend on the role guard, forbidden page, and DB migration. Application review is the highest-priority admin workflow since creators cannot be onboarded without it.
Output: Working admin role gating, updated sidebar navigation, DB migration for Phase 7 tables/columns, and complete application review workflow.
</objective>

<execution_context>
@/Users/solofilms/.claude/get-shit-done/workflows/execute-plan.md
@/Users/solofilms/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-admin-panel/07-RESEARCH.md

Reference patterns from:
@src/lib/supabase/admin.ts (existing admin client)
@src/lib/supabase/middleware.ts (existing auth-only middleware)
@src/components/layout/sidebar.tsx (existing sidebar with admin nav items)
@src/app/(admin)/layout.tsx (existing admin layout)
@src/modules/creator/actions/apply.ts (creator application submission pattern)
@next.config.ts (needs authInterrupts experimental config)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin role guard, forbidden page, Next.js config, sidebar update, and DB migration</name>
  <files>
    src/lib/admin/require-admin.ts
    src/app/(admin)/forbidden.tsx
    next.config.ts
    src/components/layout/sidebar.tsx
    supabase/migrations/00000000000005_admin_panel.sql
    src/db/schema.sql
  </files>
  <action>
    1. Create `src/lib/admin/require-admin.ts`:
       - Export async function `requireAdmin()` that:
         a. Creates Supabase server client via `createClient()` from `@/lib/supabase/server`
         b. Gets current user via `supabase.auth.getUser()`
         c. If no user, `redirect("/login?next=/admin")`
         d. Queries `profiles` table for `role, display_name` where `id = user.id`
         e. If no profile or `role !== 'admin'`, call `forbidden()` from `next/navigation`
         f. Returns `{ user, profile, supabase }`
       - Import `forbidden` and `redirect` from `next/navigation`

    2. Create `src/app/(admin)/forbidden.tsx`:
       - Default export a React component (NOT "use client" -- server component)
       - Renders a centered card with:
         - "403 Forbidden" heading
         - "You don't have permission to access the admin panel." description
         - A Link back to "/" ("Return to Home")
       - Use existing Tailwind classes matching the error page pattern

    3. Update `next.config.ts`:
       - Add `experimental: { authInterrupts: true }` to the config object passed to `withSerwist`
       - This enables `forbidden()` to render the `forbidden.tsx` page automatically

    4. Update `src/components/layout/sidebar.tsx`:
       - Replace the existing `adminNavItems` array with updated nav items:
         - "Dashboard" -> `/admin` (keep existing icon)
         - "Applications" -> `/admin/applications` (new -- use clipboard/document icon path: `M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 0-.231-.035-.454-.1-.664M6.75 7.5H4.875c-.621 0-1.125.504-1.125 1.125v12c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V16.5a9 9 0 00-9-9z`)
         - "Creators" -> `/admin/creators` (keep existing icon)
         - "Content" -> `/admin/content` (keep existing icon)
         - "Users" -> `/admin/users` (keep existing icon)
         - "Revenue" -> `/admin/revenue` (use dollar/currency icon: `M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z`)
         - "Homepage" -> `/admin/homepage` (use star/sparkle icon: `M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z`)
       - Remove the "Settings" nav item (not needed for admin v1)

    5. Create `supabase/migrations/00000000000005_admin_panel.sql`:
       - Add `featured_sort_order INTEGER DEFAULT 0` column to `series` table
       - Create `editorial_picks` table:
         - `id UUID PRIMARY KEY DEFAULT gen_random_uuid()`
         - `series_id UUID NOT NULL REFERENCES public.series(id) ON DELETE CASCADE`
         - `section TEXT NOT NULL DEFAULT 'featured' CHECK (section IN ('featured', 'trending', 'new_releases', 'staff_picks'))`
         - `sort_order INTEGER NOT NULL DEFAULT 0`
         - `added_by UUID REFERENCES public.profiles(id)`
         - `created_at TIMESTAMPTZ NOT NULL DEFAULT now()`
         - `UNIQUE (series_id, section)`
       - Enable RLS on `editorial_picks`
       - Create SELECT policy: "Editorial picks are publicly readable" with `USING (true)`
       - Create ALL policy: "Admins can manage editorial picks" with `USING (EXISTS (SELECT 1 FROM public.profiles WHERE id = (SELECT auth.uid()) AND role = 'admin'))`
       - Create index: `idx_editorial_picks_section ON public.editorial_picks(section, sort_order)`
       - Add admin RLS policies for: series (ALL), seasons (ALL), episodes (ALL), profiles (ALL), purchases (SELECT), community_posts (ALL) -- each using the `EXISTS admin role check` subquery pattern
       - Note: These admin policies are defense-in-depth; the admin panel primarily uses `createAdminClient()` which bypasses RLS

    6. Update `src/db/schema.sql` to mirror migration changes:
       - Add `featured_sort_order` column to series table definition
       - Add `editorial_picks` table definition
       - Add admin RLS policy comments
  </action>
  <verify>
    - `npx biome check --no-errors-on-unmatched src/lib/admin/require-admin.ts src/app/\(admin\)/forbidden.tsx next.config.ts src/components/layout/sidebar.tsx` passes
    - `pnpm build` succeeds (or at least `pnpm tsc --noEmit` for type checking)
    - Migration SQL is syntactically valid (review manually since Docker is unavailable)
  </verify>
  <done>
    requireAdmin() utility exists and exports correctly. forbidden.tsx renders a 403 page. next.config.ts has authInterrupts: true. Sidebar shows Applications, Creators, Content, Users, Revenue, Homepage. Migration adds featured_sort_order column, editorial_picks table, and admin RLS policies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Creator application review workflow (list + detail pages + server actions)</name>
  <files>
    src/modules/admin/actions/applications.ts
    src/app/(admin)/admin/applications/page.tsx
    src/app/(admin)/admin/applications/[id]/page.tsx
  </files>
  <action>
    1. Create `src/modules/admin/actions/applications.ts`:
       - Add `"use server"` directive
       - Import `requireAdmin` from `@/lib/admin/require-admin`
       - Import `createAdminClient` from `@/lib/supabase/admin`
       - Import `revalidatePath` from `next/cache`

       - Export async function `reviewApplication(applicationId: string, decision: "approved" | "rejected", reviewerNotes?: string)`:
         a. Call `requireAdmin()` to verify admin role (gets `{ user }`)
         b. Create admin client via `createAdminClient()`
         c. Fetch application from `creator_applications` where `id = applicationId` AND `status = 'pending'`; select `user_id, display_name, bio`
         d. If not found, return `{ success: false, message: "Application not found or already reviewed" }`
         e. Update application: set `status = decision`, `reviewer_notes = reviewerNotes || null`, `reviewed_by = user.id`, `reviewed_at = new Date().toISOString()`
         f. If decision is `"approved"`: update `profiles` where `id = app.user_id`, set `role = 'creator'`, `display_name = app.display_name`, `bio = app.bio`
         g. Call `revalidatePath("/admin/applications")`
         h. Return `{ success: true, message: \`Application ${decision}\` }`

    2. Create `src/app/(admin)/admin/applications/page.tsx`:
       - Server component (no "use client")
       - Call `requireAdmin()` at top
       - Create admin client, query `creator_applications` table:
         - Select: `id, display_name, bio, portfolio_url, social_links, status, created_at, profiles!user_id(email:id, username, avatar_url)`
         - Order by `created_at` descending
       - Render page with:
         - Heading: "Creator Applications"
         - Tab-like filter: "Pending" (default), "Approved", "Rejected", "All" -- use query params or simple conditional rendering
         - For each application: card showing display_name, bio preview (truncated to ~100 chars), status badge, created_at (formatted), portfolio_url link
         - Each card links to `/admin/applications/[id]` for detail view
         - Empty state: "No pending applications" when filtered list is empty
       - Status badges: pending (yellow), approved (green), rejected (red) using Tailwind bg colors

    3. Create `src/app/(admin)/admin/applications/[id]/page.tsx`:
       - Server component
       - Call `requireAdmin()` at top
       - Extract `id` from params (await params for Next.js 16 pattern)
       - Create admin client, fetch single application by id with full details:
         - Select: `*, profiles!user_id(username, avatar_url, role, created_at)`
       - If not found, call `notFound()`
       - Render detail page:
         - Back link to `/admin/applications`
         - Applicant info card: display_name, bio (full), portfolio_url (clickable), social_links (parsed and displayed)
         - User info: username, account created date
         - Current status badge
         - If status is "pending": show approve/reject form
           - Textarea for reviewer notes (optional)
           - Two submit buttons: "Approve" (green) and "Reject" (red)
           - Use a client component `ApplicationReviewForm` for the form with useActionState
           - Form calls `reviewApplication` server action with the application id, decision, and notes
         - If already reviewed: show reviewer_notes and reviewed_at, no action buttons
       - Create the `ApplicationReviewForm` client component inline or as a separate component in the same file:
         - `"use client"` directive
         - Props: `applicationId: string`
         - Two form submissions for approve/reject (can use hidden input for decision or two separate form actions via `.bind()`)
         - Show toast via sonner on success/failure
         - After success, redirect to `/admin/applications` via `useRouter`
  </action>
  <verify>
    - `npx biome check --no-errors-on-unmatched src/modules/admin/actions/applications.ts "src/app/(admin)/admin/applications/**/*.tsx"` passes
    - `pnpm tsc --noEmit` passes
    - Navigate to `/admin/applications` as admin user shows application list (manual verification)
  </verify>
  <done>
    Admin can view all creator applications at /admin/applications, filter by status, open any application to see full details, and approve or reject pending applications with optional feedback notes. Approved users are automatically promoted to creator role.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` completes without errors
- Navigating to `/admin` as a non-admin user shows the 403 Forbidden page
- Navigating to `/admin/applications` as an admin user shows pending applications
- Approving an application changes application status to "approved" and user role to "creator"
- Rejecting an application changes application status to "rejected" with reviewer notes
- Admin sidebar shows: Dashboard, Applications, Creators, Content, Users, Revenue, Homepage
</verification>

<success_criteria>
- requireAdmin() utility is used by all admin pages and actions for role gating
- forbidden.tsx renders when non-admin users access admin routes
- DB migration adds featured_sort_order, editorial_picks table, and admin RLS policies
- Application review workflow is fully functional (list, detail, approve, reject)
- Sidebar navigation is updated with all Phase 7 nav items
</success_criteria>

<output>
After completion, create `.planning/phases/07-admin-panel/07-01-SUMMARY.md`
</output>
