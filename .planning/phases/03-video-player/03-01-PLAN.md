---
phase: 03-video-player
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/mux/client.ts
  - src/lib/mux/tokens.ts
  - src/lib/mux/webhooks.ts
  - src/app/api/webhooks/mux/route.ts
  - src/config/env.ts
  - .env.example
autonomous: true
user_setup:
  - service: mux
    why: "Video hosting, transcoding, and streaming"
    env_vars:
      - name: MUX_TOKEN_ID
        source: "Mux Dashboard -> Settings -> API Access Tokens -> Token ID"
      - name: MUX_TOKEN_SECRET
        source: "Mux Dashboard -> Settings -> API Access Tokens -> Token Secret"
      - name: MUX_SIGNING_KEY
        source: "Mux Dashboard -> Settings -> Signing Keys -> Key ID"
      - name: MUX_PRIVATE_KEY
        source: "Mux Dashboard -> Settings -> Signing Keys -> Private Key (base64-encode for .env.local)"
      - name: MUX_WEBHOOK_SECRET
        source: "Mux Dashboard -> Settings -> Webhooks -> Create endpoint -> Signing Secret"
    dashboard_config:
      - task: "Create a Mux environment (Development)"
        location: "Mux Dashboard -> Settings -> Environments"
      - task: "Create API Access Token with Mux Video read/write permissions"
        location: "Mux Dashboard -> Settings -> API Access Tokens"
      - task: "Create a Signing Key for secure playback"
        location: "Mux Dashboard -> Settings -> Signing Keys"
      - task: "Create webhook endpoint pointing to {SITE_URL}/api/webhooks/mux"
        location: "Mux Dashboard -> Settings -> Webhooks"

must_haves:
  truths:
    - "Mux SDK client can authenticate with the Mux API using environment credentials"
    - "Signed playback tokens can be generated server-side for any playback ID"
    - "Webhook endpoint receives and verifies Mux event signatures"
    - "Episode records in Supabase are updated when Mux asset processing completes"
  artifacts:
    - path: "src/lib/mux/client.ts"
      provides: "Mux SDK singleton client"
      exports: ["mux"]
    - path: "src/lib/mux/tokens.ts"
      provides: "JWT signing helpers for playback, thumbnail, and storyboard tokens"
      exports: ["signPlaybackToken"]
    - path: "src/lib/mux/webhooks.ts"
      provides: "Webhook signature verification and event type constants"
      exports: ["verifyWebhookSignature"]
    - path: "src/app/api/webhooks/mux/route.ts"
      provides: "POST handler for Mux webhook events"
      exports: ["POST"]
    - path: "src/config/env.ts"
      provides: "Mux environment variable validation alongside existing Supabase vars"
      contains: "MUX_TOKEN_ID"
  key_links:
    - from: "src/lib/mux/tokens.ts"
      to: "src/lib/mux/client.ts"
      via: "imports mux client for jwt.signPlaybackId()"
      pattern: "import.*from.*./client"
    - from: "src/app/api/webhooks/mux/route.ts"
      to: "src/lib/mux/webhooks.ts"
      via: "imports verification helper"
      pattern: "import.*from.*@/lib/mux/webhooks"
    - from: "src/app/api/webhooks/mux/route.ts"
      to: "supabase"
      via: "updates episode records on video.asset.ready"
      pattern: "supabase.*from.*episodes.*update"
---

<objective>
Set up the Mux video infrastructure: SDK client initialization, signed playback token generation, and webhook handler for asset lifecycle events.

Purpose: Provides the server-side foundation for all video playback. Without Mux client + token signing, the video player cannot load signed HLS streams. Without webhooks, uploaded videos cannot transition from "processing" to "ready" in the database.

Output: Mux client library (`src/lib/mux/`), webhook API route, and updated environment configuration.
</objective>

<execution_context>
@/Users/solofilms/.claude/get-shit-done/workflows/execute-plan.md
@/Users/solofilms/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-video-player/03-RESEARCH.md
@src/config/env.ts
@src/db/types.ts
@src/lib/supabase/server.ts
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Mux packages and create SDK client + token signing helpers</name>
  <files>
    src/lib/mux/client.ts
    src/lib/mux/tokens.ts
    src/config/env.ts
    .env.example
    package.json
  </files>
  <action>
    1. Install Mux packages:
       ```bash
       pnpm add @mux/mux-player-react @mux/mux-node @mux/mux-uploader-react
       ```

    2. Update `src/config/env.ts` to add Mux environment variables alongside existing Supabase vars:
       - Add to requiredEnvVars: "MUX_TOKEN_ID", "MUX_TOKEN_SECRET"
       - Add a separate server-only section (not NEXT_PUBLIC_) for MUX_SIGNING_KEY and MUX_PRIVATE_KEY
       - MUX_PRIVATE_KEY is stored base64-encoded in .env.local; decode at runtime with `Buffer.from(value, "base64").toString("utf-8")`
       - Add MUX_WEBHOOK_SECRET for webhook signature verification
       - Export env.mux object with: tokenId, tokenSecret, signingKey, privateKey, webhookSecret

    3. Update `.env.example` to include all new Mux env vars with descriptive placeholders:
       ```
       MUX_TOKEN_ID=your-mux-token-id
       MUX_TOKEN_SECRET=your-mux-token-secret
       MUX_SIGNING_KEY=your-mux-signing-key-id
       MUX_PRIVATE_KEY=base64-encoded-private-key
       MUX_WEBHOOK_SECRET=your-mux-webhook-secret
       ```

    4. Create `src/lib/mux/client.ts`:
       - Import Mux from "@mux/mux-node"
       - Create singleton: `export const mux = new Mux({ tokenId: process.env.MUX_TOKEN_ID!, tokenSecret: process.env.MUX_TOKEN_SECRET! })`
       - Use ! assertions (same pattern as Supabase clients per 01-01 decision)

    5. Create `src/lib/mux/tokens.ts`:
       - Import { mux } from "./client"
       - Export `signPlaybackToken(playbackId: string, options?: { type?: "video" | "thumbnail" | "gif" | "storyboard", expiration?: string }): string`
       - Default type: "video", default expiration: "2h" (per research: at least 2 hours to cover binge sessions, Mux validates on every HLS segment request)
       - Use `mux.jwt.signPlaybackId(playbackId, { type, expiration })` internally
       - Note: Requires MUX_SIGNING_KEY and MUX_PRIVATE_KEY env vars to be set (these are read automatically by the Mux SDK)
  </action>
  <verify>
    - `pnpm build` passes (TypeScript compilation, no import errors)
    - `src/lib/mux/client.ts` exports `mux` constant
    - `src/lib/mux/tokens.ts` exports `signPlaybackToken` function
    - `.env.example` contains all 5 Mux env var placeholders
  </verify>
  <done>
    Mux SDK client is initialized with environment credentials, and playback token signing helper is available for server-side use. Environment configuration documents all required Mux variables.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Mux webhook handler with signature verification</name>
  <files>
    src/lib/mux/webhooks.ts
    src/app/api/webhooks/mux/route.ts
  </files>
  <action>
    1. Create `src/lib/mux/webhooks.ts`:
       - Export webhook event type constants: "video.asset.ready", "video.asset.errored", "video.asset.track.ready"
       - Export `verifyWebhookSignature(body: string, signature: string, secret: string): boolean` helper
       - Mux webhook signatures use HMAC-SHA256: the `mux-signature` header contains `t=timestamp,v1=signature`
       - Parse the header to extract timestamp and signature, compute HMAC-SHA256 of `timestamp.body` with the secret, compare with timing-safe equality
       - Also export TypeScript types for webhook event payloads (MuxWebhookEvent with data.id, data.playback_ids, data.duration, data.passthrough, data.tracks)

    2. Create `src/app/api/webhooks/mux/route.ts`:
       - Export async POST handler
       - Read raw body with `request.text()`
       - Get `mux-signature` header from `headers()` (use `await headers()` per Next.js 16 async headers)
       - Return 401 if signature header missing
       - Verify signature using `verifyWebhookSignature(body, signature, process.env.MUX_WEBHOOK_SECRET!)`
       - Return 401 if verification fails
       - Parse body as JSON
       - Handle event types:
         - `video.asset.ready`: Extract assetId, playbackId (from playback_ids[0].id), duration, passthrough (episode ID). Update episode in Supabase: set mux_asset_id, mux_playback_id, duration_seconds (Math.round), status to "ready"
         - `video.asset.errored`: Log error, optionally update episode status to "draft" or a failure state
         - `video.asset.track.ready`: Log that captions are available (no DB update needed for v1 since Mux serves captions directly from the asset)
       - Return 200 "OK" for all handled events
       - Use `createClient` from `@/lib/supabase/server` for Supabase operations
       - Note: Webhook routes should NOT be behind auth middleware. They are authenticated via signature verification.
  </action>
  <verify>
    - `pnpm build` passes
    - `src/app/api/webhooks/mux/route.ts` exports POST function
    - `src/lib/mux/webhooks.ts` exports verifyWebhookSignature function
    - Webhook route is accessible at /api/webhooks/mux (verify with build output showing the route)
  </verify>
  <done>
    Mux webhook endpoint receives asset lifecycle events, verifies signatures, and updates episode records in Supabase when video processing completes. The video.asset.ready handler links Mux playback IDs to episodes via the passthrough field.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds with no TypeScript errors
2. All 5 Mux-related files exist: client.ts, tokens.ts, webhooks.ts, route.ts, updated env.ts
3. `.env.example` documents all required Mux environment variables
4. Mux client, token signing, and webhook verification are importable from `@/lib/mux/*`
</verification>

<success_criteria>
- Mux SDK is installed and client initializes with environment credentials
- Playback token signing generates valid JWTs with configurable type and expiration
- Webhook route at /api/webhooks/mux verifies Mux signatures and handles video.asset.ready events
- Episode records in Supabase are updated with mux_asset_id, mux_playback_id, and duration when asset processing completes
- All Mux environment variables are documented in .env.example
</success_criteria>

<output>
After completion, create `.planning/phases/03-video-player/03-01-SUMMARY.md`
</output>
