---
phase: 03-video-player
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/player/video-player.tsx
  - src/components/player/video-player-shell.tsx
  - src/components/player/ios-pwa-fix.ts
  - src/components/player/player-layout.tsx
  - src/app/(browse)/series/[slug]/episode/[episodeNumber]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User on mobile sees a vertical-first (9:16) video player that fills the viewport"
    - "User on desktop sees a theater-mode player centered with dark backdrop"
    - "Video player renders Mux HLS stream using signed playback tokens"
    - "iOS PWA users can resume playback after backgrounding the app"
  artifacts:
    - path: "src/components/player/video-player.tsx"
      provides: "MuxPlayer client component wrapper with cinematic theming"
      exports: ["VideoPlayer"]
    - path: "src/components/player/video-player-shell.tsx"
      provides: "Server component that fetches episode data and signs playback tokens"
      exports: ["VideoPlayerShell"]
    - path: "src/components/player/ios-pwa-fix.ts"
      provides: "useIOSPWAVideoFix hook for visibilitychange-based video resume"
      exports: ["useIOSPWAVideoFix"]
    - path: "src/components/player/player-layout.tsx"
      provides: "Responsive container for vertical mobile and theater desktop modes"
      exports: ["PlayerLayout"]
    - path: "src/app/(browse)/series/[slug]/episode/[episodeNumber]/page.tsx"
      provides: "Episode page integrating VideoPlayerShell with access gating"
      contains: "VideoPlayerShell"
  key_links:
    - from: "src/components/player/video-player-shell.tsx"
      to: "src/lib/mux/tokens.ts"
      via: "signs playback tokens server-side"
      pattern: "signPlaybackToken"
    - from: "src/components/player/video-player-shell.tsx"
      to: "src/lib/supabase/server.ts"
      via: "fetches episode data from Supabase"
      pattern: "createClient.*from.*episodes"
    - from: "src/components/player/video-player.tsx"
      to: "@mux/mux-player-react"
      via: "renders MuxPlayer with signed tokens"
      pattern: "import MuxPlayer"
    - from: "src/app/(browse)/series/[slug]/episode/[episodeNumber]/page.tsx"
      to: "src/components/player/video-player-shell.tsx"
      via: "renders player inside access-granted state"
      pattern: "VideoPlayerShell"
---

<objective>
Build the core video player component with vertical-first mobile layout, desktop theater mode, and integrate it into the episode page with the existing access gating system.

Purpose: This is the central viewing experience -- the thing users came to do. A vertical 9:16 player on mobile that fills the screen, and a cinematic theater-mode player on desktop, powered by Mux's signed HLS streams.

Output: Player component suite (`src/components/player/`), updated episode page with live video playback.
</objective>

<execution_context>
@/Users/solofilms/.claude/get-shit-done/workflows/execute-plan.md
@/Users/solofilms/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-video-player/03-RESEARCH.md
@.planning/phases/03-video-player/03-01-SUMMARY.md
@src/lib/mux/client.ts
@src/lib/mux/tokens.ts
@src/db/types.ts
@src/lib/access.ts
@src/app/(browse)/series/[slug]/episode/[episodeNumber]/page.tsx
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VideoPlayer client component, VideoPlayerShell server component, and iOS PWA fix hook</name>
  <files>
    src/components/player/video-player.tsx
    src/components/player/video-player-shell.tsx
    src/components/player/ios-pwa-fix.ts
  </files>
  <action>
    1. Create `src/components/player/ios-pwa-fix.ts` (NOT .tsx -- it's a hook, no JSX):
       - "use client" directive (hooks are client-side)
       - Export `useIOSPWAVideoFix(playerRef: React.RefObject<MuxPlayerRefAttributes | null>)` hook
       - Detect iOS PWA: `"standalone" in navigator && (navigator as any).standalone === true`
       - On visibilitychange, if document was hidden and becomes visible again:
         - Access underlying media element via `playerRef.current?.media?.nativeEl`
         - Save currentTime, call `mediaEl.load()`, restore currentTime, call `mediaEl.play().catch(() => {})`
         - The .catch() is for autoplay policy -- if play() is rejected, the user will need to tap (handled by MuxPlayer's built-in play button)
       - If `playerRef.current?.media?.nativeEl` is not accessible (Mux web component wrapping), try fallback: `playerRef.current?.pause()` then `playerRef.current?.play()` after a short setTimeout
       - Clean up event listener on unmount
       - See Pattern 4 in 03-RESEARCH.md for reference implementation

    2. Create `src/components/player/video-player.tsx` (Client Component):
       - "use client" directive
       - Import MuxPlayer from "@mux/mux-player-react"
       - Import type MuxPlayerRefAttributes from "@mux/mux-player-react"
       - Import useIOSPWAVideoFix from "./ios-pwa-fix"
       - Props interface:
         ```typescript
         interface VideoPlayerProps {
           playbackId: string;
           playbackToken: string;
           thumbnailToken: string;
           title: string;
           episodeId: string;
           nextEpisodeUrl?: string;
           autoPlay?: boolean;
         }
         ```
       - Create playerRef with useRef<MuxPlayerRefAttributes>(null)
       - Call useIOSPWAVideoFix(playerRef)
       - Render MuxPlayer with:
         - ref={playerRef}
         - playbackId, tokens={{ playback: playbackToken, thumbnail: thumbnailToken }}
         - streamType="on-demand"
         - metadata={{ video_id: episodeId, video_title: title, player_name: "MicroShort Player" }}
         - Cinematic theming: primaryColor="#facc15" (brand-yellow), secondaryColor="rgba(0,0,0,0.7)", accentColor="#facc15"
         - style={{ "--media-object-fit": "contain" as any, width: "100%", height: "100%" }}
         - onContextMenu={(e: React.MouseEvent) => e.preventDefault()} for basic content protection
         - autoPlay={autoPlay ? "any" : undefined} -- "any" tries unmuted then falls back to muted
         - onEnded callback: if nextEpisodeUrl exists, dispatch a custom event or call an onEnded prop (auto-continue logic lives in Plan 03-03)
         - For now, export onEnded as a prop: `onEnded?: () => void`
       - Do NOT set aspect-ratio on MuxPlayer itself -- the container handles this (per research anti-pattern warning)

    3. Create `src/components/player/video-player-shell.tsx` (Server Component):
       - NO "use client" directive (this is a Server Component)
       - Import createClient from "@/lib/supabase/server"
       - Import signPlaybackToken from "@/lib/mux/tokens"
       - Import VideoPlayer from "./video-player"
       - Props interface:
         ```typescript
         interface VideoPlayerShellProps {
           episodeId: string;
           nextEpisodeUrl?: string;
         }
         ```
       - Fetch episode from Supabase: select mux_playback_id, title, duration_seconds from episodes where id = episodeId
       - If no episode or no mux_playback_id, return a styled placeholder div: "Video not available" (handles the case where video hasn't been uploaded/processed yet)
       - Generate signed tokens server-side:
         - playbackToken = signPlaybackToken(mux_playback_id, { type: "video", expiration: "2h" })
         - thumbnailToken = signPlaybackToken(mux_playback_id, { type: "thumbnail", expiration: "2h" })
       - Render <VideoPlayer> with all signed props
  </action>
  <verify>
    - `pnpm build` passes with no TypeScript errors
    - `src/components/player/video-player.tsx` exports VideoPlayer component
    - `src/components/player/video-player-shell.tsx` exports VideoPlayerShell component
    - `src/components/player/ios-pwa-fix.ts` exports useIOSPWAVideoFix hook
  </verify>
  <done>
    VideoPlayer renders MuxPlayer with signed tokens and cinematic theming. VideoPlayerShell fetches episode data server-side and signs tokens without exposing keys to the client. iOS PWA fix is wired into the player for backgrounding recovery.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create responsive player layout and integrate into episode page</name>
  <files>
    src/components/player/player-layout.tsx
    src/app/(browse)/series/[slug]/episode/[episodeNumber]/page.tsx
  </files>
  <action>
    1. Create `src/components/player/player-layout.tsx` (Client Component for viewport detection):
       - "use client" directive
       - Props: { children: React.ReactNode }
       - This component provides the responsive container that switches between vertical-first mobile and theater-mode desktop
       - Mobile layout (< 768px / md breakpoint):
         - Full-width container with aspect-ratio 9/16
         - max-height: 100dvh to prevent overflow
         - Background: black (cinema-black)
         - The player fills this vertical container
       - Desktop layout (>= 768px):
         - Theater backdrop: full-width dark background (cinema-black or darker), min-height: 80vh
         - Centered player container: max-width 480px, aspect-ratio 9/16, border-radius 8px, overflow hidden
         - Surrounding area is the dark "theater" backdrop
       - Use Tailwind classes for responsiveness (not JS media queries):
         - Container: `w-full aspect-[9/16] max-h-dvh bg-black md:max-w-[480px] md:max-h-[80vh] md:mx-auto md:rounded-lg md:overflow-hidden`
         - Wrapper for desktop theater: `bg-cinema-black md:min-h-[80vh] md:flex md:flex-col md:items-center md:pt-8`
       - Add `onContextMenu={(e) => e.preventDefault()}` and `style={{ userSelect: "none", WebkitUserSelect: "none" }}` to the container for content protection
       - Export PlayerLayout component

    2. Update `src/app/(browse)/series/[slug]/episode/[episodeNumber]/page.tsx`:
       - Keep the existing access gating logic (checkEpisodeAccess) exactly as-is
       - In the "access granted" section (where it currently shows "Video player coming in Phase 3"):
         - Import VideoPlayerShell from "@/components/player/video-player-shell"
         - Import PlayerLayout from "@/components/player/player-layout"
         - Fetch the episode record from Supabase to get the episode ID and determine the next episode:
           - Query: select id, episode_number, season_id from episodes, joined with seasons and series to match the slug and episode_number
           - Query next episode: select the episode with episode_number + 1 in the same season
           - Build nextEpisodeUrl: `/series/${slug}/episode/${episodeNumber + 1}` if next episode exists
         - Replace the placeholder div with:
           ```tsx
           <PlayerLayout>
             <VideoPlayerShell episodeId={episode.id} nextEpisodeUrl={nextEpisodeUrl} />
           </PlayerLayout>
           ```
       - Keep the "Back to series" link above the player
       - Keep the episode title and series info below the player
       - Keep the free episode indicator below
       - Update the page structure: the player should be the prominent element, with episode info below
       - The page should feel cinematic: dark background, player as the hero element
  </action>
  <verify>
    - `pnpm build` passes with no TypeScript errors
    - Episode page at /series/[slug]/episode/[episodeNumber] renders the player layout
    - On narrow viewport (< 768px): player container has 9:16 aspect ratio, full width
    - On wide viewport (>= 768px): player is centered with max-width 480px in a dark theater backdrop
    - Right-click is disabled on the player area
  </verify>
  <done>
    Episode page renders a responsive video player: vertical-first on mobile filling the viewport, theater-mode on desktop with dark backdrop and centered 480px player. The player loads signed Mux HLS streams via VideoPlayerShell. Access gating from Phase 2 remains intact.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds with no TypeScript errors
2. Episode page renders VideoPlayerShell inside PlayerLayout when access is granted
3. Mobile viewport shows 9:16 vertical player filling width
4. Desktop viewport shows centered theater-mode player with dark backdrop
5. Right-click is disabled on the player container
6. Player loads MuxPlayer with signed tokens (video plays if valid Mux credentials are configured)
7. iOS PWA fix hook is active in the player component
</verification>

<success_criteria>
- VideoPlayer client component renders MuxPlayer with signed playback and thumbnail tokens
- VideoPlayerShell server component fetches episode data and signs tokens without client exposure
- PlayerLayout provides responsive vertical-first (mobile) and theater-mode (desktop) containers
- Episode page integrates player within existing access gating (free/auth/payment states preserved)
- iOS PWA visibilitychange handler is wired into player for backgrounding recovery
- Content protection: right-click disabled, user-select none on player area
</success_criteria>

<output>
After completion, create `.planning/phases/03-video-player/03-02-SUMMARY.md`
</output>
