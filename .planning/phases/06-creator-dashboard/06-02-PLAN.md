---
phase: 06-creator-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/lib/mux/uploads.ts
  - src/app/api/upload/route.ts
  - src/components/creator/thumbnail-upload.tsx
  - src/components/creator/episode-upload-form.tsx
  - src/app/(creator)/dashboard/series/[seriesId]/seasons/[seasonId]/episodes/new/page.tsx
autonomous: true

must_haves:
  truths:
    - "Creator can upload a video file for an episode via Mux Direct Upload with progress feedback"
    - "Uploaded video is automatically linked to the correct episode via passthrough ID"
    - "Creator can upload a thumbnail image to Supabase Storage"
    - "Only the episode's owning creator can trigger an upload"
  artifacts:
    - path: "src/lib/mux/uploads.ts"
      provides: "createDirectUpload helper for Mux Direct Upload URL generation"
      exports: ["createDirectUpload"]
    - path: "src/app/api/upload/route.ts"
      provides: "POST endpoint returning Mux Direct Upload URL"
      exports: ["POST"]
    - path: "src/components/creator/thumbnail-upload.tsx"
      provides: "Thumbnail upload component using Supabase Storage"
      exports: ["ThumbnailUpload"]
    - path: "src/components/creator/episode-upload-form.tsx"
      provides: "Episode creation form with MuxUploader and metadata fields"
      exports: ["EpisodeUploadForm"]
  key_links:
    - from: "src/components/creator/episode-upload-form.tsx"
      to: "src/app/api/upload/route.ts"
      via: "MuxUploader endpoint async function"
      pattern: "fetch.*api/upload"
    - from: "src/app/api/upload/route.ts"
      to: "src/lib/mux/uploads.ts"
      via: "createDirectUpload call"
      pattern: "createDirectUpload"
    - from: "src/components/creator/thumbnail-upload.tsx"
      to: "supabase:storage.thumbnails"
      via: "Supabase Storage upload"
      pattern: "supabase.storage.*from.*thumbnails.*upload"
---

<objective>
Build the content upload pipeline: Mux Direct Upload for video files (server-side URL generation, browser-side chunked upload via MuxUploader) and Supabase Storage for thumbnail images. Create the episode upload form combining video upload with metadata entry.

Purpose: This is the core creator capability -- getting video content onto the platform. Without this, creators cannot publish episodes.
Output: Mux upload helper, upload API route, episode upload form with MuxUploader, and thumbnail upload component.
</objective>

<execution_context>
@/Users/solofilms/.claude/get-shit-done/workflows/execute-plan.md
@/Users/solofilms/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-creator-dashboard/06-RESEARCH.md
@.planning/phases/06-creator-dashboard/06-01-SUMMARY.md
@src/lib/mux/client.ts
@src/app/api/webhooks/mux/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Mux Direct Upload helper and API route</name>
  <files>
    src/lib/mux/uploads.ts
    src/app/api/upload/route.ts
  </files>
  <action>
    1. Create `src/lib/mux/uploads.ts`:
       - Import `mux` from `./client` (existing singleton)
       - `createDirectUpload({ episodeId: string, corsOrigin?: string }): Promise<string>`
       - Call `mux.video.uploads.create()` with:
         - `cors_origin`: use param or `process.env.NEXT_PUBLIC_APP_URL` or `"*"`
         - `new_asset_settings.playback_policy`: `["signed"]`
         - `new_asset_settings.passthrough`: the episodeId (webhook reads this to update the episode)
         - `new_asset_settings.video_quality`: `"basic"`
       - Return `directUpload.url` (the string URL, not the full object)

    2. Create `src/app/api/upload/route.ts` with POST handler:
       - Authenticate user via `createClient()` + `getUser()`. Return 401 if no user.
       - Read `{ episodeId }` from request JSON body.
       - Verify ownership: query episodes with join through seasons!inner -> series!inner, check `series.creator_id === user.id`. Return 403 if not owner.
       - Update episode status to `"processing"` via supabase update.
       - Call `createDirectUpload({ episodeId })` to get the upload URL.
       - Return `NextResponse.json({ url: uploadUrl })`.

    **IMPORTANT (Pitfall 1):** The MuxUploader endpoint function must receive the raw URL string. The API returns `{ url }` -- the client-side endpoint function must extract `.url` from the response.

    **IMPORTANT (Pitfall 2):** Passthrough is limited to 255 chars. We only pass a UUID (36 chars), so this is safe.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `src/lib/mux/uploads.ts` exports createDirectUpload
    - `src/app/api/upload/route.ts` exports POST
    - Upload route checks auth and ownership before creating upload URL
  </verify>
  <done>Mux Direct Upload URL generation works server-side with auth + ownership checks. The existing Mux webhook handler already processes the uploaded asset and writes mux_asset_id/mux_playback_id/duration to the episode.</done>
</task>

<task type="auto">
  <name>Task 2: Episode upload form and thumbnail upload component</name>
  <files>
    src/components/creator/thumbnail-upload.tsx
    src/components/creator/episode-upload-form.tsx
    src/app/(creator)/dashboard/series/[seriesId]/seasons/[seasonId]/episodes/new/page.tsx
  </files>
  <action>
    1. Create `src/components/creator/thumbnail-upload.tsx` (client component):
       - Props: `entityId: string`, `currentUrl: string | null`, `onUpload: (url: string) => void`
       - On file select: validate image type (startsWith "image/") and size (< 5MB)
       - Get user via `supabase.auth.getUser()`
       - Upload to Supabase Storage "thumbnails" bucket at path `{user.id}/{entityId}/{Date.now()}.{ext}`
       - On success, get public URL via `supabase.storage.from("thumbnails").getPublicUrl(data.path)`
       - Call `onUpload(publicUrl)` and show success toast
       - Display current thumbnail preview using Next.js Image if currentUrl exists
       - Show uploading state and disabled input during upload

    2. Create `src/components/creator/episode-upload-form.tsx` (client component):
       - Props: `seasonId: string`, `seriesId: string`, `nextEpisodeNumber: number`
       - Two-step form flow:
         **Step 1 - Metadata:** Form fields for title (required), description (optional), contentWarnings (optional), thumbnail upload. Uses episodeSchema from validations/creator.ts for client-side validation.
         **Step 2 - Video Upload:** After metadata is saved, show MuxUploader component.
       - On metadata submit:
         - Call a server action (or direct Supabase insert as creator) to create the episode row with status "draft" and the next episode_number and sort_order
         - Store the returned episode ID
       - MuxUploader integration:
         - `endpoint` prop as async function: `fetch("/api/upload", { method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ episodeId }) }).then(res => res.json()).then(data => data.url)`
         - `onSuccess` handler: show toast "Upload complete! Processing video..." and redirect to season management page
         - `onUploadError` handler: show error toast
       - Include a "create episode" server action inline (or import from modules/creator/actions/episodes.ts -- create the action that inserts the episode with status "draft", episode_number, sort_order matching nextEpisodeNumber)

    3. Create the episode upload page at `src/app/(creator)/dashboard/series/[seriesId]/seasons/[seasonId]/episodes/new/page.tsx`:
       - Server component that:
         - Authenticates user and verifies creator role
         - Verifies the creator owns the series (series.creator_id === user.id)
         - Fetches the season and computes nextEpisodeNumber from existing episodes count + 1
         - Renders EpisodeUploadForm with seriesId, seasonId, nextEpisodeNumber

    **IMPORTANT:** Import MuxUploader from `@mux/mux-uploader-react` (already installed at v1.4.1).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - ThumbnailUpload component handles file validation and Supabase Storage upload
    - EpisodeUploadForm renders MuxUploader with correct endpoint function
    - Episode upload page checks auth and ownership
  </verify>
  <done>Creators can upload episode videos through MuxUploader with metadata entry and thumbnail upload. The upload pipeline is end-to-end: form creates episode row, MuxUploader sends video directly to Mux CDN, existing webhook updates episode when processing completes.</done>
</task>

</tasks>

<verification>
- `src/lib/mux/uploads.ts` creates Mux Direct Upload URLs with episodeId passthrough
- `src/app/api/upload/route.ts` authenticates and authorizes before generating upload URL
- `src/components/creator/thumbnail-upload.tsx` uploads to Supabase Storage thumbnails bucket
- `src/components/creator/episode-upload-form.tsx` uses MuxUploader with endpoint function
- `/dashboard/series/[seriesId]/seasons/[seasonId]/episodes/new` page renders the upload form
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
- Video upload creates a Mux Direct Upload URL server-side and browser uploads directly to Mux
- Episode ID is passed via passthrough so the existing webhook automatically links the asset
- Thumbnail images upload to Supabase Storage with creator-scoped folder paths
- Only the owning creator can trigger uploads for their episodes
- Episode metadata (title, description, content warnings) is captured before video upload
</success_criteria>

<output>
After completion, create `.planning/phases/06-creator-dashboard/06-02-SUMMARY.md`
</output>
