---
phase: 06-creator-dashboard
plan: 05
type: execute
wave: 3
depends_on: ["06-01", "06-02"]
files_modified:
  - src/modules/creator/actions/community.ts
  - src/modules/creator/queries/get-community-posts.ts
  - src/components/creator/community-feed.tsx
  - src/components/creator/poll-creator.tsx
  - src/app/(creator)/dashboard/series/[seriesId]/community/page.tsx
  - src/app/api/upload/trailer/route.ts
autonomous: true

must_haves:
  truths:
    - "Creator can create discussion posts and announcements in their series community"
    - "Creator can create polls with multiple options that users can vote on"
    - "Community posts appear in real-time via Supabase Realtime subscription"
    - "Creator can pin and delete posts in their series community"
    - "Creator can upload an optional trailer for their series"
  artifacts:
    - path: "src/modules/creator/actions/community.ts"
      provides: "Server Actions for creating posts, polls, and managing community"
      exports: ["createPost", "createPoll", "deletePost", "pinPost", "votePoll"]
    - path: "src/components/creator/community-feed.tsx"
      provides: "Real-time community discussion feed component"
      exports: ["CommunityFeed"]
    - path: "src/app/(creator)/dashboard/series/[seriesId]/community/page.tsx"
      provides: "Community management page for a series"
    - path: "src/app/api/upload/trailer/route.ts"
      provides: "POST endpoint for trailer Direct Upload URL (public playback)"
  key_links:
    - from: "src/components/creator/community-feed.tsx"
      to: "supabase:realtime"
      via: "Supabase Realtime postgres_changes subscription"
      pattern: "supabase.*channel.*on.*postgres_changes.*community_posts"
    - from: "src/modules/creator/actions/community.ts"
      to: "supabase:community_posts,poll_votes"
      via: "Supabase insert/update/delete"
      pattern: "supabase.*from.*(community_posts|poll_votes)"
    - from: "src/app/api/upload/trailer/route.ts"
      to: "src/lib/mux/uploads.ts"
      via: "Mux Direct Upload with public playback"
      pattern: "mux.video.uploads.create"
---

<objective>
Build community spaces per series (discussion feed, polls/voting with Supabase Realtime) and the optional trailer upload feature.

Purpose: Community engagement drives retention and gives creators a direct connection with their audience. Trailers serve as promotional content that can be shared freely.
Output: Community feed with real-time updates, poll creation and voting, post management, and trailer upload via Mux Direct Upload with public playback.
</objective>

<execution_context>
@/Users/solofilms/.claude/get-shit-done/workflows/execute-plan.md
@/Users/solofilms/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-creator-dashboard/06-RESEARCH.md
@.planning/phases/06-creator-dashboard/06-01-SUMMARY.md
@.planning/phases/06-creator-dashboard/06-02-SUMMARY.md
@src/lib/mux/uploads.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Community server actions and real-time feed</name>
  <files>
    src/modules/creator/actions/community.ts
    src/modules/creator/queries/get-community-posts.ts
    src/components/creator/community-feed.tsx
    src/components/creator/poll-creator.tsx
    src/app/(creator)/dashboard/series/[seriesId]/community/page.tsx
  </files>
  <action>
    1. **src/modules/creator/actions/community.ts** ("use server"):
       - `createPost(seriesId, prevState, formData)`: Auth check, validate content (1-1000 chars), insert into community_posts with post_type='discussion' and author_id=user.id. RevalidatePath.
       - `createPoll(seriesId, prevState, formData)`: Auth check, validate content/question, parse poll_options from formData (array of strings, min 2, max 6), insert with post_type='poll', poll_options as JSONB array of `{text: string, votes: 0}`. RevalidatePath.
       - `deletePost(postId)`: Auth check, verify user is author OR series creator (series.creator_id = user.id). Delete from community_posts. RevalidatePath.
       - `pinPost(postId, isPinned: boolean)`: Auth check, verify user is series creator. Update is_pinned. RevalidatePath.
       - `votePoll(postId, optionIndex: number)`: Auth check, insert into poll_votes (user_id, post_id, option_index). ON CONFLICT (post_id, user_id) do nothing (one vote per user). Increment the vote count in poll_options JSONB. RevalidatePath.

    2. **src/modules/creator/queries/get-community-posts.ts:**
       - `getCommunityPosts(seriesId, limit=50)`: Fetch posts with author join (profiles: display_name, avatar_url), ordered by is_pinned desc, created_at desc. Include poll_votes count per option if post_type='poll'.
       - Return typed array of CommunityPost with author info.

    3. **src/components/creator/community-feed.tsx** (client component):
       - Props: `seriesId: string`, `initialPosts: CommunityPostWithAuthor[]`, `currentUserId: string | null`, `isCreator: boolean`
       - State: posts array initialized from initialPosts
       - Supabase Realtime subscription on `community_posts` table filtered by `series_id=eq.${seriesId}`:
         - On INSERT: prepend new post to array (fetch author info for display)
         - On DELETE: remove post from array
         - On UPDATE: update post in array (for pin status changes)
       - Cleanup: `supabase.removeChannel(channel)` on unmount
       - Display: scrollable feed with each post showing author avatar+name, content, timestamp, post type badge
       - For polls: show options with vote counts and a "Vote" button (disabled if already voted)
       - Creator controls: pin/unpin toggle, delete button on any post
       - Author controls: delete button on own posts
       - New post form at top: textarea + "Post" button, with toggle to switch to poll creation mode

    4. **src/components/creator/poll-creator.tsx** (client component):
       - Props: `seriesId: string`
       - Form with: question textarea, dynamic option inputs (2-6), "Add Option" button, "Create Poll" button
       - Calls createPoll server action on submit
       - Uses useActionState pattern

    5. **src/app/(creator)/dashboard/series/[seriesId]/community/page.tsx:**
       - Server component: auth check, verify creator owns series
       - Fetch initial posts via getCommunityPosts
       - Render CommunityFeed with isCreator=true
       - Note: This same CommunityFeed component will later be used in the public series page for viewers (isCreator=false)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Community actions have auth checks
    - CommunityFeed subscribes to Supabase Realtime for live updates
    - Poll voting respects one-vote-per-user constraint
    - Creator can pin/delete any post; regular users can only delete own
  </verify>
  <done>Community feed shows posts in real-time, creators can create discussions/announcements/polls, pin posts, and moderate content. Poll voting with one-vote-per-user enforcement.</done>
</task>

<task type="auto">
  <name>Task 2: Optional trailer upload via Mux Direct Upload</name>
  <files>
    src/app/api/upload/trailer/route.ts
  </files>
  <action>
    Create `src/app/api/upload/trailer/route.ts` with a POST handler for trailer uploads:

    1. Auth check: `createClient()` + `getUser()`, return 401 if unauthenticated.
    2. Read `{ seriesId }` from request JSON body.
    3. Verify ownership: query series where id=seriesId and creator_id=user.id. Return 403 if not owner.
    4. Create Mux Direct Upload with **public playback** (not signed):
       ```typescript
       const directUpload = await mux.video.uploads.create({
         cors_origin: process.env.NEXT_PUBLIC_APP_URL || "*",
         new_asset_settings: {
           playback_policy: ["public"],  // Trailers are promotional -- no signing needed
           passthrough: `trailer_${seriesId}`,  // Prefix to distinguish from episode uploads in webhook
           video_quality: "basic",
         },
       });
       ```
    5. Return `NextResponse.json({ url: directUpload.url })`.
    6. Update the existing Mux webhook handler (`src/app/api/webhooks/mux/route.ts`) to handle trailer passthrough:
       - In the `VIDEO_ASSET_READY` case, check if `episodeId` starts with `trailer_`:
         - If yes: extract seriesId from `trailer_{seriesId}`, update `series.trailer_url` with the playback ID (format: `mux:{playbackId}`)
         - If no: existing episode update logic (unchanged)

    **Per research Open Question 1:** Trailers use `playback_policy: ["public"]` so they can be embedded and shared without signed tokens. The passthrough uses a `trailer_` prefix so the webhook can distinguish trailer vs episode uploads.

    The trailer upload UI will be integrated into the series edit page (06-03 SeriesForm) as an optional section with a MuxUploader. Add a small note in the action for 06-03 to add a "Upload Trailer" section to the series detail page that uses this API route. However, the basic trailer MuxUploader can be added directly in this task to the series detail page if it already exists from 06-03. Since 06-05 runs in Wave 3 (after 06-03), the series detail page WILL exist. Add a TrailerUpload client component section to `src/app/(creator)/dashboard/series/[seriesId]/page.tsx` that shows MuxUploader pointed at `/api/upload/trailer`.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Trailer upload API route uses public playback policy
    - Mux webhook handler distinguishes trailer vs episode passthrough
    - Trailer section appears on series edit page
  </verify>
  <done>Creators can upload optional trailers for their series via Mux Direct Upload with public playback. The webhook automatically stores the trailer playback ID on the series record.</done>
</task>

</tasks>

<verification>
- Community posts create, display, and update in real-time via Supabase Realtime
- Polls support creation with 2-6 options and one-vote-per-user voting
- Creator can pin and delete posts in their series community
- Trailer upload creates Mux Direct Upload with public playback policy
- Mux webhook distinguishes trailer uploads via `trailer_` passthrough prefix
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
- Community feed updates live without page refresh when new posts are created
- Poll voting is enforced to one vote per user via DB unique constraint
- Series creator can moderate community (pin/delete any post)
- Trailer upload works end-to-end: API route -> Mux CDN -> webhook updates series.trailer_url
- Trailers have public playback (no signed tokens needed for promotional content)
</success_criteria>

<output>
After completion, create `.planning/phases/06-creator-dashboard/06-05-SUMMARY.md`
</output>
