---
phase: 06-creator-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00000000000004_creator_dashboard.sql
  - src/db/types.ts
  - src/db/schema.sql
  - src/lib/validations/creator.ts
  - src/modules/creator/actions/apply.ts
  - src/app/(creator)/dashboard/apply/page.tsx
autonomous: true

must_haves:
  truths:
    - "Database has creator_applications, community_posts, poll_votes, and followers tables with RLS"
    - "Seasons have release_strategy and sort_order columns; episodes have sort_order, content_warnings, and release_date"
    - "Profiles have social_links and follower_count columns"
    - "Thumbnails storage bucket exists with creator-scoped RLS"
    - "A viewer can submit a creator application with portfolio info"
    - "Zod validation schemas exist for all creator forms"
  artifacts:
    - path: "supabase/migrations/00000000000004_creator_dashboard.sql"
      provides: "All Phase 6 database tables and schema alterations"
      contains: "creator_applications"
    - path: "src/db/types.ts"
      provides: "TypeScript types for new tables and altered columns"
      contains: "CreatorApplication"
    - path: "src/lib/validations/creator.ts"
      provides: "Zod schemas for application, series, season, episode forms"
      exports: ["applicationSchema", "seriesSchema", "seasonSchema", "episodeSchema"]
    - path: "src/modules/creator/actions/apply.ts"
      provides: "Server Action for submitting creator application"
      exports: ["submitApplication"]
    - path: "src/app/(creator)/dashboard/apply/page.tsx"
      provides: "Creator application form page"
  key_links:
    - from: "src/modules/creator/actions/apply.ts"
      to: "supabase:creator_applications"
      via: "Supabase insert"
      pattern: "supabase.*from.*creator_applications.*insert"
    - from: "src/app/(creator)/dashboard/apply/page.tsx"
      to: "src/modules/creator/actions/apply.ts"
      via: "useActionState form binding"
      pattern: "useActionState.*submitApplication"
---

<objective>
Create the Phase 6 database migration (all new tables, altered columns, storage bucket, RLS policies), update TypeScript types, create Zod validation schemas for all creator forms, and build the creator application form and submission flow.

Purpose: This plan establishes the data foundation for the entire Creator Dashboard phase and delivers the first user-facing feature: the creator application form.
Output: Migration SQL, updated TypeScript types, validation schemas, and a working application form.
</objective>

<execution_context>
@/Users/solofilms/.claude/get-shit-done/workflows/execute-plan.md
@/Users/solofilms/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-creator-dashboard/06-RESEARCH.md
@.planning/phases/01-foundation-app-shell/01-02-SUMMARY.md
@supabase/migrations/00000000000001_create_content_schema.sql
@src/db/types.ts
@src/lib/validations/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration and TypeScript types for Phase 6</name>
  <files>
    supabase/migrations/00000000000004_creator_dashboard.sql
    src/db/types.ts
    src/db/schema.sql
  </files>
  <action>
    Create migration `00000000000004_creator_dashboard.sql` with ALL Phase 6 database changes. Follow the exact SQL from the research file's "Database Migration: New Tables and Columns" section:

    1. **creator_applications** table: id, user_id (UNIQUE FK to profiles), display_name, bio, portfolio_url, portfolio_description, sample_video_urls (TEXT[]), social_links (JSONB), status (CHECK: pending/approved/rejected), reviewer_notes, reviewed_at, reviewed_by, timestamps. Enable RLS with policies: users view/insert own, admins manage all. Add updated_at trigger, indexes on status and user_id.

    2. **ALTER seasons**: Add `release_strategy TEXT NOT NULL DEFAULT 'all_at_once' CHECK (release_strategy IN ('all_at_once', 'drip'))`, `drip_interval_days INTEGER DEFAULT 7 CHECK (drip_interval_days IS NULL OR (drip_interval_days >= 1 AND drip_interval_days <= 30))`, `sort_order INTEGER NOT NULL DEFAULT 0`.

    3. **ALTER episodes**: Add `sort_order INTEGER NOT NULL DEFAULT 0`, `content_warnings TEXT`, `release_date TIMESTAMPTZ`.

    4. **ALTER profiles**: Add `social_links JSONB DEFAULT '{}'`, `follower_count INTEGER NOT NULL DEFAULT 0`.

    5. **community_posts** table: id, series_id (FK cascade), author_id (FK), content (CHECK <= 1000 chars), post_type (CHECK: discussion/poll/announcement), poll_options (JSONB), is_pinned, timestamps. Enable RLS: public read, authenticated insert, author update, author+series-creator delete. Indexes on series_id and author_id. updated_at trigger.

    6. **poll_votes** table: id, post_id (FK cascade), user_id (FK), option_index (CHECK >= 0), created_at. UNIQUE (post_id, user_id). Enable RLS: public read, authenticated insert (own user_id). Index on post_id.

    7. **followers** table: id, follower_id (FK cascade), creator_id (FK cascade), created_at. UNIQUE (follower_id, creator_id). Enable RLS: public read, insert own follower_id, delete own follower_id. Indexes on creator_id and follower_id.

    8. **Follower count trigger**: Create trigger on followers table that increments profiles.follower_count on INSERT and decrements on DELETE.

    9. **Storage bucket**: `INSERT INTO storage.buckets (id, name, public) VALUES ('thumbnails', 'thumbnails', true)` with RLS policies for creator upload (folder path matches auth.uid), update/delete own, and public read.

    Then update `src/db/types.ts`:
    - Add `CreatorApplication` interface with all columns
    - Add `CommunityPost` interface
    - Add `PollVote` interface
    - Add `Follower` interface
    - Update `Season` interface: add `release_strategy`, `drip_interval_days`, `sort_order`
    - Update `Episode` interface: add `sort_order`, `content_warnings`, `release_date`
    - Update `Profile` interface: add `social_links`, `follower_count`
    - Add `ApplicationStatus` type: 'pending' | 'approved' | 'rejected'
    - Add `ReleaseStrategy` type: 'all_at_once' | 'drip'
    - Add `PostType` type: 'discussion' | 'poll' | 'announcement'
    - Add Insert/Update type aliases for new interfaces
    - Update existing Season/Episode/Profile Insert/Update types for new columns

    Update `src/db/schema.sql` reference copy with the new migration content appended.
  </action>
  <verify>
    - File exists: `supabase/migrations/00000000000004_creator_dashboard.sql`
    - SQL syntax is valid (no obvious errors)
    - `src/db/types.ts` exports all new types
    - `npx tsc --noEmit` passes
  </verify>
  <done>Migration file covers all Phase 6 tables and alterations. TypeScript types reflect the full updated schema. No type errors.</done>
</task>

<task type="auto">
  <name>Task 2: Validation schemas and creator application form</name>
  <files>
    src/lib/validations/creator.ts
    src/modules/creator/actions/apply.ts
    src/app/(creator)/dashboard/apply/page.tsx
  </files>
  <action>
    1. Create `src/lib/validations/creator.ts` with Zod v4 schemas following the auth.ts pattern (import from "zod/v4"):
       - `applicationSchema`: displayName (2-50 chars), bio (20-500 chars), portfolioUrl (optional z.url() or empty string), portfolioDescription (20-1000 chars), socialLinks (optional string)
       - `seriesSchema`: title (2-100 chars), description (optional, max 2000), genre (z.enum with all Genre values)
       - `seasonSchema`: title (optional, max 100), description (optional, max 2000), priceTierId (z.string().uuid()), releaseStrategy (z.enum ['all_at_once', 'drip'])
       - `episodeSchema`: title (1-100 chars), description (optional, max 2000), contentWarnings (optional string)
       - Export all schemas and inferred types (ApplicationInput, SeriesInput, SeasonInput, EpisodeInput)
       - Export `CreatorFormState` type matching `AuthFormState` pattern: { values?, errors, success, message? }

    2. Create `src/modules/creator/actions/apply.ts` as a Server Action:
       - `"use server"` directive
       - `submitApplication(prevState: CreatorFormState, formData: FormData)` function
       - Authenticate with Supabase (getUser), return error if not authenticated
       - Check if user already has a pending/approved application (select from creator_applications where user_id = user.id)
       - Parse formData with applicationSchema.safeParse, return fieldErrors on failure
       - Insert into creator_applications: user_id, display_name, bio, portfolio_url, portfolio_description, social_links (parse as JSON if provided)
       - On success, revalidatePath("/dashboard") and return { success: true, message: "Application submitted successfully" }

    3. Create `src/app/(creator)/dashboard/apply/page.tsx`:
       - Server component wrapper that checks auth and existing application status
       - If user already has role="creator", redirect to /dashboard
       - If pending application exists, show "application pending" status card
       - If rejected, show "application rejected" with option to reapply (delete old, create new)
       - Otherwise render the ApplicationForm client component
       - ApplicationForm: useActionState with submitApplication, form fields for displayName, bio, portfolioUrl, portfolioDescription, socialLinks (textarea for JSON or comma-separated links)
       - Use shadcn Input, Button, Card components
       - Show loading state with isPending, display success toast via sonner
       - Use FieldError pattern from auth forms for validation errors
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Validation schemas export correctly
    - Server action has "use server" directive
    - Form page renders within (creator) layout
  </verify>
  <done>Creator application form is functional with Zod validation, server-side auth checks, duplicate application prevention, and status display for pending/rejected applications. All validation schemas for Phase 6 forms are ready for use by subsequent plans.</done>
</task>

</tasks>

<verification>
- `supabase/migrations/00000000000004_creator_dashboard.sql` exists with all tables and alterations
- `src/db/types.ts` has CreatorApplication, CommunityPost, PollVote, Follower interfaces
- Season/Episode/Profile types include new columns
- `src/lib/validations/creator.ts` exports applicationSchema, seriesSchema, seasonSchema, episodeSchema
- `src/modules/creator/actions/apply.ts` exports submitApplication server action
- `/dashboard/apply` page renders application form
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
- All Phase 6 database changes are in a single migration file
- TypeScript types match the full updated schema
- Validation schemas cover all creator form types needed by subsequent plans
- Creator application form submits and stores data correctly
- Application status (pending/rejected) prevents duplicate submissions
</success_criteria>

<output>
After completion, create `.planning/phases/06-creator-dashboard/06-01-SUMMARY.md`
</output>
