---
phase: 06-creator-dashboard
plan: 04
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/modules/creator/queries/get-creator-analytics.ts
  - src/app/(creator)/dashboard/analytics/page.tsx
  - src/app/(creator)/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "Creator can view total views, total revenue, creator earnings, and total unlocks"
    - "Creator can see per-series breakdown of views and revenue"
    - "Creator can see recent purchase activity"
    - "Dashboard overview shows key metrics at a glance"
  artifacts:
    - path: "src/modules/creator/queries/get-creator-analytics.ts"
      provides: "Analytics aggregation queries over existing tables"
      exports: ["getCreatorAnalytics", "getCreatorOverview"]
    - path: "src/app/(creator)/dashboard/analytics/page.tsx"
      provides: "Full analytics dashboard page"
    - path: "src/app/(creator)/dashboard/page.tsx"
      provides: "Dashboard home with overview metrics"
  key_links:
    - from: "src/app/(creator)/dashboard/analytics/page.tsx"
      to: "src/modules/creator/queries/get-creator-analytics.ts"
      via: "Server component data fetch"
      pattern: "getCreatorAnalytics"
    - from: "src/modules/creator/queries/get-creator-analytics.ts"
      to: "supabase:series,purchases"
      via: "Supabase aggregate queries"
      pattern: "supabase.*from.*(series|purchases)"
---

<objective>
Build the creator analytics dashboard with full-funnel metrics computed from existing tables (series.view_count, purchases), and update the dashboard home page with an overview of key stats.

Purpose: Creators need visibility into how their content is performing to make informed pricing and content decisions.
Output: Analytics query utilities and a dashboard showing views, revenue, unlocks, per-series breakdown, and recent activity.
</objective>

<execution_context>
@/Users/solofilms/.claude/get-shit-done/workflows/execute-plan.md
@/Users/solofilms/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-creator-dashboard/06-RESEARCH.md
@.planning/phases/06-creator-dashboard/06-01-SUMMARY.md
@.planning/phases/05-payments-monetization/05-03-SUMMARY.md
@src/lib/stripe/transfers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analytics queries and dashboard pages</name>
  <files>
    src/modules/creator/queries/get-creator-analytics.ts
    src/app/(creator)/dashboard/analytics/page.tsx
    src/app/(creator)/dashboard/page.tsx
  </files>
  <action>
    1. **src/modules/creator/queries/get-creator-analytics.ts:**
       - Import createClient from supabase/server, wrap in React.cache

       - `getCreatorAnalytics(creatorId: string)`:
         - Fetch all creator's series: `series` table where creator_id matches, select id, title, slug, view_count, thumbnail_url, status
         - Fetch all completed purchases: `purchases` table where creator_id matches and status='completed', select amount_cents, creator_share_cents, transferred, created_at, season_id
         - Compute in application code (per research recommendation -- no separate analytics tables):
           - `totalViews`: sum of series.view_count across all series
           - `totalRevenue`: sum of purchases.amount_cents
           - `creatorEarnings`: sum of purchases.creator_share_cents
           - `totalUnlocks`: count of purchases
           - `pendingEarnings`: sum of creator_share_cents where transferred=false
           - `transferredEarnings`: sum of creator_share_cents where transferred=true
         - Per-series breakdown: for each series, aggregate purchases by joining on season_id -> seasons.series_id. Return { seriesId, title, views, unlocks, revenue }
         - Recent purchases: last 20 purchases with created_at, amount_cents, season_id (join season -> series title for display)
         - Return typed analytics object

       - `getCreatorOverview(creatorId: string)`:
         - Lightweight version: just total views, total earnings, total unlocks, and series count
         - Used by dashboard home page (not the full analytics page)

    2. **src/app/(creator)/dashboard/analytics/page.tsx:**
       - Server component: auth check, verify creator role, call getCreatorAnalytics
       - Page title "Analytics"
       - Top row: 4 metric cards in a responsive grid:
         - Total Views (formatted with K/M suffixes -- reuse the pattern from 04-02)
         - Total Revenue (formatted as dollars: `$${(amount/100).toFixed(2)}`)
         - Creator Earnings (your share after platform fee)
         - Total Unlocks (season purchases count)
       - Middle section: Per-series breakdown table
         - Columns: Series, Views, Unlocks, Revenue
         - Each row links to the series management page
         - Sort by revenue descending
       - Bottom section: Recent Activity
         - List of last 20 purchases: date, series name, amount, your share
         - Use `toLocaleDateString()` for date formatting (established pattern from payouts dashboard)
       - Empty state: "No analytics yet. Upload and publish content to start tracking performance."

    3. **src/app/(creator)/dashboard/page.tsx** (update existing placeholder):
       - Server component: auth check, verify creator role
       - If role is "viewer", show CTA to apply (link to /dashboard/apply)
       - If role is "creator":
         - Call getCreatorOverview for lightweight stats
         - Display overview cards: Total Views, Earnings, Unlocks, Series Count
         - Quick links section: "Manage Series", "Upload Episode", "View Analytics", "Payouts"
         - Recent activity snippet (last 5 purchases)
       - Use the cinematic card style (bg-card, border-border) matching existing dashboard aesthetic
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Analytics queries compute aggregates from series.view_count and purchases tables
    - `/dashboard/analytics` displays metrics, per-series breakdown, and recent activity
    - `/dashboard` home page shows overview stats and quick links
    - Both pages check auth and creator role
  </verify>
  <done>Creator analytics dashboard shows full-funnel metrics (views, revenue, earnings, unlocks) with per-series breakdown and recent purchase activity. Dashboard home page provides overview stats and quick navigation to all creator tools.</done>
</task>

</tasks>

<verification>
- `src/modules/creator/queries/get-creator-analytics.ts` exports getCreatorAnalytics and getCreatorOverview
- `/dashboard/analytics` page renders with metric cards, series table, and activity list
- `/dashboard` home page shows overview cards for creators or apply CTA for viewers
- Analytics computed from existing series.view_count and purchases tables (no new analytics tables)
- Revenue displayed in dollars, views formatted with K/M suffixes
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
- Creator sees accurate total views, revenue, earnings, and unlock counts
- Per-series breakdown shows which series are performing best
- Recent activity shows the last 20 purchases with dates and amounts
- Dashboard home provides a useful overview without requiring navigation to analytics
- Viewer users see the apply CTA instead of creator dashboard content
</success_criteria>

<output>
After completion, create `.planning/phases/06-creator-dashboard/06-04-SUMMARY.md`
</output>
