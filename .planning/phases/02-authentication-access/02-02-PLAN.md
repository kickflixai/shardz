---
phase: 02-authentication-access
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/lib/supabase/middleware.ts
  - src/lib/access.ts
  - src/app/(browse)/series/[slug]/episode/[episodeNumber]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can watch episodes 1-3 of any series without creating an account or seeing a login prompt"
    - "User visiting /dashboard without being logged in is redirected to /login"
    - "User visiting /admin without being logged in is redirected to /login"
    - "User visiting /login while already logged in is redirected to /"
    - "User visiting episode 4+ without being logged in sees a prompt to sign up (not a blank page)"
  artifacts:
    - path: "src/lib/supabase/middleware.ts"
      provides: "Route protection logic for protected and auth routes"
      contains: "protectedPrefixes"
    - path: "src/lib/access.ts"
      provides: "Episode access check utility"
      exports: ["checkEpisodeAccess"]
    - path: "src/app/(browse)/series/[slug]/episode/[episodeNumber]/page.tsx"
      provides: "Episode page with access gating"
      contains: "checkEpisodeAccess"
  key_links:
    - from: "src/middleware.ts"
      to: "src/lib/supabase/middleware.ts"
      via: "updateSession call"
      pattern: "updateSession"
    - from: "src/lib/supabase/middleware.ts"
      to: "supabase.auth.getUser"
      via: "user check for route protection"
      pattern: "getUser.*protectedPrefixes"
    - from: "src/app/(browse)/series/[slug]/episode/[episodeNumber]/page.tsx"
      to: "src/lib/access.ts"
      via: "access check before rendering content"
      pattern: "checkEpisodeAccess"
---

<objective>
Add middleware-level route protection for authenticated routes and build the free episode access gate. Unauthenticated users can freely watch episodes 1-3 of any series. Episodes 4+ prompt for signup. Protected routes (/dashboard, /admin) redirect to login.

Purpose: Enforce the zero-friction free viewing model (ACCS-01) while protecting routes that require authentication (ACCS-02). This is the access control layer that all content and admin features depend on.
Output: Extended middleware with route protection, episode access utility function, and episode page with access gating.
</objective>

<execution_context>
@/Users/solofilms/.claude/get-shit-done/workflows/execute-plan.md
@/Users/solofilms/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-access/02-RESEARCH.md
@.planning/phases/02-authentication-access/02-01-SUMMARY.md
@src/lib/supabase/middleware.ts
@src/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend middleware with route protection and create episode access utility</name>
  <files>
    src/lib/supabase/middleware.ts
    src/lib/access.ts
  </files>
  <action>
**Step 1: Extend the Supabase middleware at `src/lib/supabase/middleware.ts`.**

The existing middleware only refreshes the session. Add route protection AFTER the session refresh and `getUser()` call (which already exists).

After the existing `await supabase.auth.getUser()` line, capture the user:
```typescript
const { data: { user } } = await supabase.auth.getUser();
```

Add route protection logic:

```typescript
const path = request.nextUrl.pathname;

// Protected routes: redirect to login if not authenticated
const protectedPrefixes = ["/dashboard", "/admin"];
const isProtected = protectedPrefixes.some((prefix) => path.startsWith(prefix));
if (isProtected && !user) {
  const loginUrl = new URL("/login", request.url);
  loginUrl.searchParams.set("next", path);
  return NextResponse.redirect(loginUrl);
}

// Auth routes: redirect to home if already authenticated
const authPaths = ["/login", "/signup"];
const isAuthPage = authPaths.includes(path);
if (isAuthPage && user) {
  return NextResponse.redirect(new URL("/", request.url));
}
```

Important details:
- The redirect to `/login` includes a `next` query param so the login action can redirect back after authentication (future enhancement -- for now the login action redirects to `/`)
- Do NOT redirect `/forgot-password` or `/reset-password` for authenticated users -- a logged-in user might still need to reset their password
- Do NOT protect `/auth/confirm` -- that's the PKCE callback route and must be accessible without auth
- The existing middleware matcher already excludes static files and images, so the route protection only runs on page/API routes

**Step 2: Create the episode access utility at `src/lib/access.ts`.**

This is a pure function (no side effects) that determines whether a user can access a specific episode. It implements the free-tier access policy.

```typescript
export type EpisodeAccessResult =
  | { allowed: true; reason: "free" }
  | { allowed: true; reason: "purchased" }
  | { allowed: false; reason: "auth_required" }
  | { allowed: false; reason: "payment_required" };

const FREE_EPISODE_LIMIT = 3;

export function checkEpisodeAccess(
  episodeNumber: number,
  user: { id: string } | null,
  hasPurchased?: boolean,
): EpisodeAccessResult {
  // First 3 episodes are always free -- no auth, no payment
  if (episodeNumber <= FREE_EPISODE_LIMIT) {
    return { allowed: true, reason: "free" };
  }

  // Episodes 4+ require authentication
  if (!user) {
    return { allowed: false, reason: "auth_required" };
  }

  // Payment check -- deferred to Phase 5
  // For now, all authenticated users are blocked from 4+ (no payment system yet)
  if (hasPurchased) {
    return { allowed: true, reason: "purchased" };
  }

  return { allowed: false, reason: "payment_required" };
}
```

Key details:
- `FREE_EPISODE_LIMIT = 3` is a named constant, not magic number
- The function is synchronous and pure -- easy to test later with TDD
- `hasPurchased` is optional (defaults to undefined/falsy) -- Phase 5 will pass actual purchase status
- Returns discriminated union for type-safe handling in components
  </action>
  <verify>
- `pnpm build` compiles without errors
- `src/lib/supabase/middleware.ts` contains `protectedPrefixes` and redirect logic
- `src/lib/access.ts` exports `checkEpisodeAccess` and `EpisodeAccessResult`
- TypeScript compiles the access utility types correctly
  </verify>
  <done>Middleware redirects unauthenticated users from /dashboard and /admin to /login, redirects authenticated users from /login and /signup to /, and the episode access utility correctly identifies free (1-3) vs auth-required (4+) episodes.</done>
</task>

<task type="auto">
  <name>Task 2: Create episode page with access gating</name>
  <files>
    src/app/(browse)/series/[slug]/episode/[episodeNumber]/page.tsx
  </files>
  <action>
**Create the episode detail page at `src/app/(browse)/series/[slug]/episode/[episodeNumber]/page.tsx`.**

This is a new route within the existing `(browse)` route group. The `(browse)` route group already has a layout with Header + Footer from Phase 1.

This page demonstrates the free episode access gate. Since there's no video player yet (Phase 3) and no real content (Phase 8), this is a structural page that:
1. Parses the episode number from the URL
2. Checks access using `checkEpisodeAccess`
3. Renders appropriate content based on access result

```typescript
import { createClient } from "@/lib/supabase/server";
import { checkEpisodeAccess } from "@/lib/access";
import Link from "next/link";

interface EpisodePageProps {
  params: Promise<{ slug: string; episodeNumber: string }>;
}

export default async function EpisodePage({ params }: EpisodePageProps) {
  const { slug, episodeNumber: episodeNumberStr } = await params;
  const episodeNumber = Number.parseInt(episodeNumberStr, 10);

  if (Number.isNaN(episodeNumber) || episodeNumber < 1) {
    // Invalid episode number
    return (
      <div className="mx-auto max-w-2xl px-4 py-16 text-center">
        <h1 className="text-2xl font-bold text-foreground">Invalid Episode</h1>
        <p className="mt-2 text-muted-foreground">
          The episode number is invalid.
        </p>
      </div>
    );
  }

  // Check auth state
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  // Check access (hasPurchased = false for now, Phase 5 will add purchase checks)
  const access = checkEpisodeAccess(episodeNumber, user, false);

  if (!access.allowed && access.reason === "auth_required") {
    return (
      <div className="mx-auto max-w-2xl px-4 py-16 text-center">
        <h1 className="text-2xl font-bold text-foreground">Sign Up to Continue Watching</h1>
        <p className="mt-4 text-muted-foreground">
          Episodes 1-3 are free. Create an account to unlock more episodes.
        </p>
        <div className="mt-8 flex justify-center gap-4">
          <Link
            href="/signup"
            className="rounded-md bg-primary px-6 py-3 text-sm font-medium text-primary-foreground transition-colors hover:bg-primary/90"
          >
            Create Account
          </Link>
          <Link
            href="/login"
            className="rounded-md border border-border px-6 py-3 text-sm font-medium text-foreground transition-colors hover:bg-muted"
          >
            Sign In
          </Link>
        </div>
      </div>
    );
  }

  if (!access.allowed && access.reason === "payment_required") {
    return (
      <div className="mx-auto max-w-2xl px-4 py-16 text-center">
        <h1 className="text-2xl font-bold text-foreground">Unlock This Season</h1>
        <p className="mt-4 text-muted-foreground">
          This episode requires a season unlock. Payments coming soon.
        </p>
        <p className="mt-2 text-sm text-muted-foreground">
          Coming in Phase 5.
        </p>
      </div>
    );
  }

  // Access granted (free or purchased)
  return (
    <div className="mx-auto max-w-4xl px-4 py-8">
      <div className="mb-4">
        <Link
          href={`/series/${slug}`}
          className="text-sm text-muted-foreground transition-colors hover:text-primary"
        >
          &larr; Back to series
        </Link>
      </div>
      <h1 className="text-2xl font-bold text-foreground">
        Episode {episodeNumber}
      </h1>
      <p className="mt-2 text-sm text-muted-foreground">
        Series: {slug}
      </p>
      <div className="mt-8 aspect-video rounded-lg border border-border bg-cinema-surface flex items-center justify-center">
        <p className="text-muted-foreground">
          Video player coming in Phase 3
        </p>
      </div>
      {access.reason === "free" && (
        <p className="mt-4 text-sm text-muted-foreground">
          Free episode ({episodeNumber} of 3 free)
        </p>
      )}
    </div>
  );
}
```

Important details:
- This is a Server Component (no "use client") -- it uses the server Supabase client for auth checks
- `params` is a Promise in Next.js 16 App Router -- must await it
- The page does NOT query the database for actual episode data yet (no real content exists). It uses the URL params to demonstrate the access gate
- The access check is application-level, not RLS-level. RLS policies from Phase 1 already make published episodes visible to everyone. The access gate is about what UI to show, not what data to return
- No login prompt, modal, or barrier appears for episodes 1-3 (satisfies ACCS-01)
- Episodes 4+ without auth show a friendly signup prompt (not a redirect -- user chose to navigate here)
- Uses existing design tokens: `bg-cinema-surface`, `border-border`, `text-muted-foreground`, `bg-primary`

Create necessary parent directories if they don't exist (`series/[slug]/episode/[episodeNumber]/`).
  </action>
  <verify>
- `pnpm build` compiles without errors
- Navigating to `/series/test-series/episode/1` shows the episode content (free access)
- Navigating to `/series/test-series/episode/4` while not logged in shows "Sign Up to Continue Watching"
- Navigating to `/series/test-series/episode/abc` shows "Invalid Episode"
- The page imports and uses `checkEpisodeAccess` from `@/lib/access`
  </verify>
  <done>Episode pages render with access gating: episodes 1-3 show content freely, episode 4+ shows signup prompt for unauthenticated users, and authenticated users see a payment-required placeholder. Middleware protects /dashboard and /admin routes.</done>
</task>

</tasks>

<verification>
1. Visit `/dashboard` while logged out -- redirected to `/login?next=/dashboard`
2. Visit `/admin` while logged out -- redirected to `/login?next=/admin`
3. Visit `/login` while logged in -- redirected to `/`
4. Visit `/signup` while logged in -- redirected to `/`
5. Visit `/forgot-password` while logged in -- NOT redirected (still accessible)
6. Visit `/series/any-series/episode/1` while logged out -- content renders (free)
7. Visit `/series/any-series/episode/3` while logged out -- content renders (free)
8. Visit `/series/any-series/episode/4` while logged out -- signup prompt renders
9. Visit `/series/any-series/episode/4` while logged in -- payment-required placeholder renders
10. `pnpm build` passes with no errors
</verification>

<success_criteria>
- Middleware protects /dashboard and /admin by redirecting to /login
- Middleware redirects authenticated users away from /login and /signup
- Episodes 1-3 are freely accessible without any auth barrier
- Episodes 4+ show a signup prompt for unauthenticated users
- Episode access utility is a pure function ready for TDD testing
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-access/02-02-SUMMARY.md`
</output>
