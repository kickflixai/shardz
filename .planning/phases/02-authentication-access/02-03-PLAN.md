---
phase: 02-authentication-access
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/(auth)/forgot-password/page.tsx
  - src/app/(auth)/forgot-password/actions.ts
  - src/app/(auth)/reset-password/page.tsx
  - src/app/(auth)/reset-password/actions.ts
  - src/app/(auth)/auth-code-error/page.tsx
  - supabase/templates/confirmation.html
  - supabase/templates/recovery.html
  - supabase/config.toml
autonomous: true

must_haves:
  truths:
    - "User can request a password reset by entering their email on the forgot-password page"
    - "User sees a success message after requesting reset (regardless of whether email exists -- prevents enumeration)"
    - "User clicking the reset link in email lands on the reset-password form (via /auth/confirm token exchange)"
    - "User can set a new password on the reset-password page and is redirected to home"
    - "User who clicks an expired or invalid email link sees a helpful error page with a retry option"
    - "Signup confirmation and password reset emails use PKCE-compatible templates with token_hash"
  artifacts:
    - path: "src/app/(auth)/forgot-password/page.tsx"
      provides: "Password reset request form"
      contains: "useActionState"
    - path: "src/app/(auth)/forgot-password/actions.ts"
      provides: "Password reset request server action"
      exports: ["requestPasswordReset"]
    - path: "src/app/(auth)/reset-password/page.tsx"
      provides: "New password form (after email link)"
      contains: "useActionState"
    - path: "src/app/(auth)/reset-password/actions.ts"
      provides: "Password update server action"
      exports: ["updatePassword"]
    - path: "src/app/(auth)/auth-code-error/page.tsx"
      provides: "Error page for failed token exchange"
      contains: "request a new link"
    - path: "supabase/templates/confirmation.html"
      provides: "PKCE-compatible signup confirmation email"
      contains: "token_hash"
    - path: "supabase/templates/recovery.html"
      provides: "PKCE-compatible password reset email"
      contains: "token_hash"
  key_links:
    - from: "src/app/(auth)/forgot-password/page.tsx"
      to: "src/app/(auth)/forgot-password/actions.ts"
      via: "useActionState + form action"
      pattern: "useActionState.*requestPasswordReset"
    - from: "src/app/(auth)/forgot-password/actions.ts"
      to: "supabase.auth.resetPasswordForEmail"
      via: "server action calling Supabase Auth"
      pattern: "resetPasswordForEmail"
    - from: "src/app/(auth)/reset-password/page.tsx"
      to: "src/app/(auth)/reset-password/actions.ts"
      via: "useActionState + form action"
      pattern: "useActionState.*updatePassword"
    - from: "src/app/(auth)/reset-password/actions.ts"
      to: "supabase.auth.updateUser"
      via: "server action updating password"
      pattern: "updateUser.*password"
    - from: "supabase/templates/confirmation.html"
      to: "src/app/auth/confirm/route.ts"
      via: "email link URL with token_hash"
      pattern: "/auth/confirm\\?token_hash="
    - from: "supabase/templates/recovery.html"
      to: "src/app/auth/confirm/route.ts"
      via: "email link URL with token_hash and recovery type"
      pattern: "/auth/confirm\\?token_hash=.*type=recovery"
---

<objective>
Implement the complete password reset flow and configure transactional email templates for PKCE compatibility. Users can request a password reset, receive a branded email, click through to set a new password, and handle error cases gracefully.

Purpose: Completes the auth lifecycle (ACCS-05) and ensures transactional emails work with the server-side PKCE auth flow (PLAT-03). Users who forget their password can recover their account without support intervention.
Output: Forgot-password page, reset-password page, auth-code-error page, branded email templates for confirmation and recovery, and config.toml email template configuration.
</objective>

<execution_context>
@/Users/solofilms/.claude/get-shit-done/workflows/execute-plan.md
@/Users/solofilms/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-access/02-RESEARCH.md
@.planning/phases/02-authentication-access/02-01-SUMMARY.md
@src/lib/validations/auth.ts
@src/app/(auth)/layout.tsx
@src/app/auth/confirm/route.ts
@supabase/config.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build forgot-password and reset-password pages with server actions</name>
  <files>
    src/app/(auth)/forgot-password/page.tsx
    src/app/(auth)/forgot-password/actions.ts
    src/app/(auth)/reset-password/page.tsx
    src/app/(auth)/reset-password/actions.ts
    src/app/(auth)/auth-code-error/page.tsx
  </files>
  <action>
**Step 1: Create the forgot-password server action at `src/app/(auth)/forgot-password/actions.ts`.**

```typescript
"use server";

import { createClient } from "@/lib/supabase/server";
import { forgotPasswordSchema, type AuthFormState } from "@/lib/validations/auth";
```

The `requestPasswordReset` function:
- Signature: `async function requestPasswordReset(_prevState: AuthFormState, formData: FormData): Promise<AuthFormState>`
- Extract `email` from formData
- Validate with `forgotPasswordSchema.safeParse()`
- On validation failure: return errors
- On pass: call `supabase.auth.resetPasswordForEmail(email, { redirectTo: \`\${process.env.NEXT_PUBLIC_SITE_URL}/auth/confirm?next=/reset-password\` })`
- CRITICAL: Always return success regardless of whether the email exists. This prevents email enumeration attacks:
  ```typescript
  return {
    errors: null,
    success: true,
    message: "If an account exists with this email, you will receive a password reset link.",
  };
  ```
- If Supabase returns an error (rate limit, etc.), still show the same success message to the user. Only log the error server-side if needed for debugging.

**Step 2: Create the forgot-password page at `src/app/(auth)/forgot-password/page.tsx`.**

`"use client"` component using `useActionState(requestPasswordReset, initialState)`.

Structure:
- `<Card>` with title "Forgot Password", description "Enter your email to receive a password reset link"
- Form with single email field
- When `state.success` is true: show the success message in a green-tinted div and hide the form. Include a link back to `/login` ("Back to sign in")
- When not submitted yet: show the form with email input and submit button ("Send Reset Link")
- Below the form: link to `/login` ("Remember your password? Sign in")

**Step 3: Create the reset-password server action at `src/app/(auth)/reset-password/actions.ts`.**

```typescript
"use server";

import { revalidatePath } from "next/cache";
import { redirect } from "next/navigation";
import { createClient } from "@/lib/supabase/server";
import { resetPasswordSchema, type AuthFormState } from "@/lib/validations/auth";
```

The `updatePassword` function:
- Signature: `async function updatePassword(_prevState: AuthFormState, formData: FormData): Promise<AuthFormState>`
- Extract `password` and `confirmPassword` from formData
- Validate with `resetPasswordSchema.safeParse()` -- this includes the `.refine()` that checks passwords match
- On validation failure: return errors (including "Passwords do not match" on confirmPassword field)
- On pass: call `supabase.auth.updateUser({ password })`
- On auth error: return with `error.message` (e.g., "Auth session missing!" if user navigated here without a valid recovery session)
- On success: `revalidatePath("/", "layout")` then `redirect("/")`

Note: `updateUser` works because the auth callback (`/auth/confirm`) already exchanged the recovery token for a session. The user has a valid auth session when they land on `/reset-password`.

**Step 4: Create the reset-password page at `src/app/(auth)/reset-password/page.tsx`.**

`"use client"` component using `useActionState(updatePassword, initialState)`.

Structure:
- `<Card>` with title "Reset Password", description "Enter your new password"
- Form with two fields:
  - Password: `<Input type="password" name="password" required>` (min 6 chars)
  - Confirm Password: `<Input type="password" name="confirmPassword" required>`
- Show field errors (including "Passwords do not match" on confirmPassword)
- Show general error (state.message) for auth errors like missing session
- Submit button: "Update Password"

**Step 5: Create the auth-code-error page at `src/app/(auth)/auth-code-error/page.tsx`.**

This is a simple informational page shown when the auth callback token exchange fails (expired link, invalid token, etc.).

```typescript
import Link from "next/link";

export default function AuthCodeErrorPage() {
  return (
    <div className="rounded-lg border border-border bg-card p-8 text-center">
      <h1 className="text-2xl font-bold text-foreground">
        Link Expired or Invalid
      </h1>
      <p className="mt-4 text-muted-foreground">
        The link you clicked has expired or is invalid. This can happen if:
      </p>
      <ul className="mt-4 space-y-2 text-sm text-muted-foreground text-left">
        <li>The link is more than 1 hour old</li>
        <li>The link has already been used</li>
        <li>The link was copied incorrectly</li>
      </ul>
      <div className="mt-8 flex flex-col gap-3">
        <Link
          href="/forgot-password"
          className="rounded-md bg-primary px-6 py-3 text-sm font-medium text-primary-foreground transition-colors hover:bg-primary/90"
        >
          Request a New Link
        </Link>
        <Link
          href="/login"
          className="text-sm text-muted-foreground transition-colors hover:text-primary"
        >
          Back to Sign In
        </Link>
      </div>
    </div>
  );
}
```

This is a Server Component (no "use client" needed -- purely static content).
  </action>
  <verify>
- `pnpm build` compiles without errors
- `/forgot-password` renders a form with email field and "Send Reset Link" button
- `/reset-password` renders a form with password and confirm password fields
- `/auth-code-error` renders an informational page with "Request a New Link" button
- `src/app/(auth)/forgot-password/actions.ts` exports `requestPasswordReset`
- `src/app/(auth)/reset-password/actions.ts` exports `updatePassword`
  </verify>
  <done>Users can request a password reset via email, set a new password after clicking the email link, and see a helpful error page if the link is expired or invalid. All forms use server actions with Zod validation.</done>
</task>

<task type="auto">
  <name>Task 2: Configure PKCE-compatible email templates and update config.toml</name>
  <files>
    supabase/templates/confirmation.html
    supabase/templates/recovery.html
    supabase/config.toml
  </files>
  <action>
**Step 1: Create the signup confirmation email template at `supabase/templates/confirmation.html`.**

This template uses `{{ .TokenHash }}` instead of `{{ .ConfirmationURL }}` for PKCE compatibility. The link points to the auth callback route handler.

```html
<!DOCTYPE html>
<html>
  <body style="background-color: #141414; color: #f2f2f2; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 40px 20px; margin: 0;">
    <div style="max-width: 480px; margin: 0 auto;">
      <h1 style="color: #E0B800; font-size: 24px; margin-bottom: 24px;">Welcome to MicroShort</h1>
      <p style="font-size: 16px; line-height: 1.6; margin-bottom: 24px;">
        Confirm your email address to start watching premium microshort series.
      </p>
      <a href="{{ .SiteURL }}/auth/confirm?token_hash={{ .TokenHash }}&type=email"
         style="display: inline-block; background-color: #E0B800; color: #141414; padding: 12px 32px; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 16px;">
        Confirm Email
      </a>
      <p style="font-size: 13px; color: #999; margin-top: 32px;">
        If you didn't create a MicroShort account, you can safely ignore this email.
      </p>
    </div>
  </body>
</html>
```

Design notes:
- Background: `#141414` (cinema-black from the brand)
- Accent: `#E0B800` (brand-yellow)
- Text: `#f2f2f2` (light text for dark background)
- Muted text: `#999`
- System font stack for cross-platform rendering
- Inline styles only (email clients strip <style> tags)

**Step 2: Create the password recovery email template at `supabase/templates/recovery.html`.**

```html
<!DOCTYPE html>
<html>
  <body style="background-color: #141414; color: #f2f2f2; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 40px 20px; margin: 0;">
    <div style="max-width: 480px; margin: 0 auto;">
      <h1 style="color: #E0B800; font-size: 24px; margin-bottom: 24px;">Reset Your Password</h1>
      <p style="font-size: 16px; line-height: 1.6; margin-bottom: 24px;">
        Click the button below to reset your MicroShort password.
        This link expires in 1 hour.
      </p>
      <a href="{{ .SiteURL }}/auth/confirm?token_hash={{ .TokenHash }}&type=recovery&next=/reset-password"
         style="display: inline-block; background-color: #E0B800; color: #141414; padding: 12px 32px; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 16px;">
        Reset Password
      </a>
      <p style="font-size: 13px; color: #999; margin-top: 32px;">
        If you didn't request a password reset, you can safely ignore this email.
      </p>
    </div>
  </body>
</html>
```

Key difference from confirmation template: the link includes `type=recovery` and `next=/reset-password` so the auth callback route handler redirects to the password update form instead of home.

**Step 3: Update `supabase/config.toml` to use custom email templates.**

Find the commented-out email template section and add the following configuration (uncommented):

```toml
[auth.email.template.confirmation]
subject = "Confirm your MicroShort account"
content_path = "./supabase/templates/confirmation.html"

[auth.email.template.recovery]
subject = "Reset your MicroShort password"
content_path = "./supabase/templates/recovery.html"
```

Add these AFTER the existing `[auth.email]` section but BEFORE the `[auth.email.smtp]` commented section. The `content_path` is relative to the project root.

Also, while in config.toml, add the auth redirect URL for localhost:3000 to the `additional_redirect_urls` list to ensure the PKCE callback URL is allowed:

```toml
additional_redirect_urls = ["https://127.0.0.1:3000", "http://localhost:3000"]
```

This ensures `http://localhost:3000/auth/confirm` is an allowed redirect target for email links.
  </action>
  <verify>
- `supabase/templates/confirmation.html` exists and contains `token_hash={{ .TokenHash }}&type=email`
- `supabase/templates/recovery.html` exists and contains `token_hash={{ .TokenHash }}&type=recovery`
- `supabase/config.toml` contains `[auth.email.template.confirmation]` and `[auth.email.template.recovery]` sections
- Both templates use MicroShort branding (dark background, yellow accent)
- Both template URLs point to `/auth/confirm` (the PKCE callback route from 02-01)
- `pnpm build` passes with no errors
  </verify>
  <done>Email templates use PKCE-compatible token_hash URLs, are branded with MicroShort's cinematic dark + yellow theme, and config.toml is updated to load them. The complete password reset flow works: request reset -> receive branded email -> click link -> auth callback exchanges token -> user lands on reset-password form.</done>
</task>

</tasks>

<verification>
1. Navigate to `/forgot-password` -- form renders with email field
2. Submit with invalid email -- validation error appears
3. Submit with any email -- "If an account exists..." success message appears
4. Navigate to `/reset-password` -- form renders with password and confirm password fields
5. Submit with mismatched passwords -- "Passwords do not match" error appears
6. Navigate to `/auth-code-error` -- error page with "Request a New Link" button renders
7. `supabase/templates/confirmation.html` contains PKCE-compatible link
8. `supabase/templates/recovery.html` contains PKCE-compatible link with recovery type
9. `supabase/config.toml` references both templates
10. `pnpm build` passes with no errors
</verification>

<success_criteria>
- Forgot-password page sends reset email via Supabase Auth (always shows success message)
- Reset-password page updates password with Zod validation (passwords must match)
- Auth-code-error page guides users to request a new link
- Email templates are PKCE-compatible (use token_hash, not ConfirmationURL)
- Email templates match MicroShort branding (dark + yellow)
- Config.toml loads custom templates for local development
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-access/02-03-SUMMARY.md`
</output>
