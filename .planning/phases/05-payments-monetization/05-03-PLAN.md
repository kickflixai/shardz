---
phase: 05-payments-monetization
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/lib/stripe/connect.ts
  - src/lib/stripe/transfers.ts
  - src/app/api/connect/route.ts
  - src/app/api/connect/onboarding/route.ts
  - src/app/api/connect/webhook/route.ts
  - src/app/(creator)/dashboard/payouts/page.tsx
autonomous: true

must_haves:
  truths:
    - "Creator can initiate Stripe Connect onboarding from their dashboard"
    - "Creator's 80% revenue share is transferred to their Connect account when they complete onboarding"
    - "Creator can see completed payouts in their dashboard"
    - "Revenue accumulates on the platform when creator has not connected Stripe"
    - "Payout records are stored for audit trail"
  artifacts:
    - path: "src/lib/stripe/connect.ts"
      provides: "Connect account creation, account links, onboarding status"
      contains: "stripe.accounts.create"
    - path: "src/lib/stripe/transfers.ts"
      provides: "Transfer execution logic"
      contains: "stripe.transfers.create"
    - path: "src/app/api/connect/route.ts"
      provides: "Connect onboarding initiation"
      exports: ["POST"]
    - path: "src/app/(creator)/dashboard/payouts/page.tsx"
      provides: "Creator payout dashboard page"
      contains: "payout"
  key_links:
    - from: "src/app/api/connect/onboarding/route.ts"
      to: "src/lib/stripe/transfers.ts"
      via: "trigger batch transfer after onboarding completes"
      pattern: "batchTransfer"
    - from: "src/lib/stripe/transfers.ts"
      to: "supabase purchases table"
      via: "query untransferred purchases and mark as transferred"
      pattern: "transferred.*false"
    - from: "src/app/(creator)/dashboard/payouts/page.tsx"
      to: "supabase payout_records table"
      via: "query completed payouts for display"
      pattern: "from.*payout_records"
---

<objective>
Implement Stripe Connect for creator payouts: Express account onboarding, batch transfers of accumulated revenue, and a basic payout dashboard showing completed payouts.

Purpose: This plan completes the monetization loop -- revenue collected from users reaches creators. Without it, the platform collects money but creators have no way to receive their share.

Output: Connect onboarding flow, automatic batch transfers on onboarding completion, account.updated webhook for status tracking, and a creator dashboard payouts page.
</objective>

<execution_context>
@/Users/solofilms/.claude/get-shit-done/workflows/execute-plan.md
@/Users/solofilms/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-payments-monetization/05-RESEARCH.md
@.planning/phases/05-payments-monetization/05-01-SUMMARY.md

# Existing patterns:
@src/lib/stripe/client.ts
@src/lib/supabase/admin.ts
@src/app/api/webhooks/stripe/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Stripe Connect helpers and transfer logic</name>
  <files>
    src/lib/stripe/connect.ts
    src/lib/stripe/transfers.ts
  </files>
  <action>
    1. Create `src/lib/stripe/connect.ts`:
       - Import `stripe` from `@/lib/stripe/client`.
       - Export `createConnectAccount(params: { email: string, creatorUsername: string | null }): Promise<string>`:
         Creates a Stripe Express account with `type: 'express'`, `country: 'US'`, `email`, `capabilities: { transfers: { requested: true } }`, and `business_profile.url` linking to the creator's profile page. Returns `account.id`.
       - Export `createAccountLink(params: { accountId: string, returnPath: string, refreshPath: string }): Promise<string>`:
         Creates an Account Link for onboarding with `type: 'account_onboarding'`, `return_url` and `refresh_url` using NEXT_PUBLIC_APP_URL. Returns `accountLink.url`.
       - Export `getAccountStatus(accountId: string): Promise<{ chargesEnabled: boolean, payoutsEnabled: boolean, detailsSubmitted: boolean }>`:
         Retrieves the account and returns the relevant status fields.

    2. Create `src/lib/stripe/transfers.ts`:
       - Import `stripe` from `@/lib/stripe/client`.
       - Import `createAdminClient` from `@/lib/supabase/admin`.
       - Export `batchTransferToCreator(creatorId: string, stripeAccountId: string): Promise<{ transferred: number, totalCents: number }>`:
         a. Query all purchases where `creator_id = creatorId`, `transferred = false`, `status = 'completed'`, and `stripe_charge_id IS NOT NULL`.
         b. For each untransferred purchase:
            - Create transfer: `stripe.transfers.create({ amount: purchase.creator_share_cents, currency: 'usd', destination: stripeAccountId, source_transaction: purchase.stripe_charge_id, transfer_group: 'season_' + purchase.season_id })`.
            - Update purchase: set `transferred = true`, `stripe_transfer_id = transfer.id`.
            - Insert payout_record: `{ creator_id, purchase_id, stripe_transfer_id, amount_cents, status: 'completed' }`.
         c. Wrap each transfer in try/catch -- if one fails, log the error, insert a payout_record with `status: 'failed'`, and continue with the next.
         d. Return count of successful transfers and total cents transferred.
       - Export `getCreatorEarnings(creatorId: string): Promise<{ totalEarnedCents: number, pendingTransferCents: number, transferredCents: number }>`:
         a. Query all completed purchases for this creator.
         b. Sum `creator_share_cents` for total earned.
         c. Sum where `transferred = false` for pending.
         d. Sum where `transferred = true` for transferred.
         e. Return the three values.
  </action>
  <verify>
    - `pnpm build` succeeds
    - `connect.ts` exports `createConnectAccount`, `createAccountLink`, `getAccountStatus`
    - `transfers.ts` exports `batchTransferToCreator`, `getCreatorEarnings`
    - No TypeScript errors
  </verify>
  <done>
    Connect helper functions create Express accounts, generate onboarding links, and check account status. Transfer logic iterates untransferred purchases, creates Stripe transfers with source_transaction linking, records each transfer in payout_records, and handles individual failures gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Connect API routes, account.updated webhook, and payouts dashboard page</name>
  <files>
    src/app/api/connect/route.ts
    src/app/api/connect/onboarding/route.ts
    src/app/api/connect/webhook/route.ts
    src/app/(creator)/dashboard/payouts/page.tsx
    src/app/api/webhooks/stripe/route.ts
  </files>
  <action>
    1. Create `src/app/api/connect/route.ts` (POST):
       - Authenticate user via `createClient()` + `getUser()`. Return 401 if not authenticated.
       - Fetch user's profile to check:
         a. If `stripe_account_id` already exists, skip account creation.
         b. If not, call `createConnectAccount(...)` and update profile with new `stripe_account_id`.
       - Call `createAccountLink(...)` with the account ID.
       - Return `{ url: accountLink.url }` for client-side redirect.

    2. Create `src/app/api/connect/onboarding/route.ts` (GET):
       - This is the return URL after Stripe Connect onboarding completes.
       - Authenticate user.
       - Fetch user's profile to get `stripe_account_id`.
       - Call `getAccountStatus(stripeAccountId)`.
       - If `detailsSubmitted && chargesEnabled`:
         a. Update profile: `stripe_onboarding_complete = true`.
         b. Trigger `batchTransferToCreator(userId, stripeAccountId)` to transfer all accumulated revenue.
       - Redirect to `/dashboard/payouts?onboarding=complete` (or `?onboarding=incomplete` if not ready).

    3. Update `src/app/api/webhooks/stripe/route.ts`:
       - Add handler for `account.updated` event:
         a. Extract `account.id` from event data.
         b. Check `charges_enabled` and `payouts_enabled` status.
         c. If both are enabled, query profiles for matching `stripe_account_id`.
         d. Update `stripe_onboarding_complete = true`.
         e. Trigger `batchTransferToCreator` for the creator.
       - This provides a reliable backup path -- the return URL (onboarding route) may fail if the user navigates away, but the webhook will still fire.
       - Note: this handles the same Stripe webhook endpoint. Add the new case to the existing switch statement.

    4. Create `src/app/(creator)/dashboard/payouts/page.tsx`:
       - Server component. Authenticate user, redirect to /login if not authenticated.
       - Fetch creator's profile to get `stripe_account_id` and `stripe_onboarding_complete`.
       - Call `getCreatorEarnings(userId)` for summary stats.
       - Fetch completed payout_records for this creator, ordered by created_at desc.
       - Layout:
         a. **Earnings Summary Card**: Total earned, amount pending transfer, amount transferred. Use `formatPrice` for display.
         b. **Connect Stripe section**:
            - If `stripe_onboarding_complete`: show green "Connected" status.
            - If `stripe_account_id` but NOT onboarding_complete: show "Onboarding incomplete" with a "Complete Setup" button that calls `/api/connect` to generate a new account link.
            - If NO `stripe_account_id`: show "Connect your Stripe account to withdraw earnings" with a "Connect Stripe" button that calls `/api/connect`.
            - Per user decision: "Completed payouts only -- no pending/in-transit pipeline visibility."
         c. **Payout History**: Table/list of completed payouts with date, amount, and status. If no payouts yet, show empty state "No payouts yet."
       - Styling: Dark cards with cinema-surface background, brand-yellow accents on amounts.
  </action>
  <verify>
    - `pnpm build` succeeds
    - Connect route exports POST
    - Onboarding return route exports GET
    - Webhook handler handles account.updated event
    - Payouts page renders with earnings summary and connect button
    - No TypeScript errors
  </verify>
  <done>
    Connect API creates Express accounts and generates onboarding links. Onboarding return route checks account status and triggers batch transfers. account.updated webhook provides reliable backup for status changes. Creator payouts dashboard shows earnings summary (total, pending, transferred), Connect status with onboarding CTA, and completed payout history.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` passes with no errors
- Connect API creates Express accounts and returns onboarding URLs
- After onboarding completes, batch transfer processes all untransferred purchases
- Webhook handles account.updated as backup for onboarding completion
- Payouts dashboard shows earnings breakdown and Connect status
- Payout records are created for each successful transfer
- Failed transfers are logged and recorded without stopping the batch
</verification>

<success_criteria>
- Creator can click "Connect Stripe" to initiate Express account onboarding
- After completing onboarding, all accumulated revenue (80% share) is automatically transferred
- Creator sees earnings summary: total earned, pending, transferred
- Creator sees a list of completed payouts
- Revenue accumulates safely when creator has not connected Stripe
- Payout records provide an audit trail of all transfers
</success_criteria>

<output>
After completion, create `.planning/phases/05-payments-monetization/05-03-SUMMARY.md`
</output>
