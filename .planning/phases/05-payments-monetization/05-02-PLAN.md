---
phase: 05-payments-monetization
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/paywall/season-paywall.tsx
  - src/components/paywall/unlock-button.tsx
  - src/app/checkout/success/page.tsx
  - src/app/checkout/cancel/page.tsx
  - src/app/(browse)/series/[slug]/episode/[episodeNumber]/page.tsx
  - src/components/series/season-tabs.tsx
  - src/components/series/episode-list-item.tsx
  - src/components/series/series-detail.tsx
  - src/app/(browse)/series/[slug]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User navigating to episode 4+ sees a paywall with season info, price, and unlock CTA"
    - "Unauthenticated users see the paywall first, then are prompted to log in when they click unlock"
    - "Clicking the unlock button redirects to Stripe Checkout"
    - "After successful payment, user sees a 'Season unlocked!' confirmation with episode list"
    - "Purchased seasons show a 'Purchased' badge on the series page instead of the price/unlock CTA"
    - "Lock icons show on locked episodes, unlocked/free episodes look normal"
    - "All-seasons bundle option shows on the series page when multiple seasons exist"
  artifacts:
    - path: "src/components/paywall/season-paywall.tsx"
      provides: "Inline overlay paywall for locked episodes"
      contains: "Unlock all"
    - path: "src/components/paywall/unlock-button.tsx"
      provides: "CTA button that triggers checkout"
      contains: "checkout"
    - path: "src/app/checkout/success/page.tsx"
      provides: "Post-purchase confirmation page"
      contains: "Season unlocked"
    - path: "src/app/(browse)/series/[slug]/episode/[episodeNumber]/page.tsx"
      provides: "Episode page with real purchase checks"
      contains: "hasUserPurchasedSeason"
  key_links:
    - from: "src/components/paywall/unlock-button.tsx"
      to: "/api/checkout"
      via: "fetch POST to create checkout session"
      pattern: "fetch.*api/checkout"
    - from: "src/app/(browse)/series/[slug]/episode/[episodeNumber]/page.tsx"
      to: "src/modules/purchases/queries/get-user-purchases.ts"
      via: "hasUserPurchasedSeason check before access gate"
      pattern: "hasUserPurchasedSeason"
    - from: "src/app/(browse)/series/[slug]/page.tsx"
      to: "src/modules/purchases/queries/get-user-purchases.ts"
      via: "getUserSeasonPurchases for badge display"
      pattern: "getUserSeasonPurchases"
    - from: "src/app/checkout/success/page.tsx"
      to: "stripe.checkout.sessions.retrieve"
      via: "verify payment via Stripe API on success page"
      pattern: "sessions.retrieve"
---

<objective>
Build the paywall UI, post-purchase flow, and integrate real purchase checks into the episode and series pages. Users see a compelling paywall on locked episodes, can unlock via Stripe Checkout, see confirmation after purchase, and the series page reflects ownership state.

Purpose: This plan delivers the user-facing purchase experience -- from discovery of a locked episode to successful unlock. Without it, the payment backend (Plan 01) has no frontend.

Output: Paywall overlay component, unlock button, checkout success/cancel pages, updated episode page with real purchase checks, and series page with purchased badges and bundle pricing.
</objective>

<execution_context>
@/Users/solofilms/.claude/get-shit-done/workflows/execute-plan.md
@/Users/solofilms/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-payments-monetization/05-RESEARCH.md
@.planning/phases/05-payments-monetization/05-01-SUMMARY.md

# Files being modified:
@src/app/(browse)/series/[slug]/episode/[episodeNumber]/page.tsx
@src/app/(browse)/series/[slug]/page.tsx
@src/components/series/season-tabs.tsx
@src/components/series/episode-list-item.tsx
@src/components/series/series-detail.tsx
@src/lib/access.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Paywall component, unlock button, and checkout success/cancel pages</name>
  <files>
    src/components/paywall/season-paywall.tsx
    src/components/paywall/unlock-button.tsx
    src/app/checkout/success/page.tsx
    src/app/checkout/cancel/page.tsx
  </files>
  <action>
    1. Create `src/components/paywall/unlock-button.tsx` (client component):
       - Props: `{ seasonId: string, seriesSlug: string, priceCents: number, purchaseType: 'single' | 'bundle', label?: string }`
       - On click: if `purchaseType === 'single'`, POST to `/api/checkout` with `{ seasonId, seriesSlug, purchaseType: 'single' }`.
       - On click: if `purchaseType === 'bundle'`, POST to `/api/checkout` with `{ seriesSlug, purchaseType: 'bundle' }`.
       - Handle response: redirect to `response.url` (Stripe Checkout URL) using `window.location.href`.
       - Handle 401: redirect to `/login?next=/series/${seriesSlug}` (per "value before account" -- unauthenticated users see paywall, login prompted on click).
       - Handle 409 (already purchased): show toast "You already own this!" via sonner.
       - Show loading state while request is in flight (spinner, disabled button).
       - Style: prominent CTA button with brand-yellow bg, black text, large padding, rounded-lg. Display price using `formatPrice` from `@/lib/stripe/prices`.
       - Default label: "Unlock Season - {price}" for single, "Unlock All Seasons - {price}" for bundle.

    2. Create `src/components/paywall/season-paywall.tsx` (server component):
       - Props: `{ seasonId: string, seriesSlug: string, seriesTitle: string, seasonTitle: string | null, seasonNumber: number, priceCents: number, totalEpisodes: number, episodeNumber: number, thumbnailUrl: string | null }`
       - GATE STYLE (Claude's discretion): **Inline overlay with preview teaser** as recommended in research.
       - Layout: Full-width container with the series thumbnail/artwork as a blurred background (filter: blur + brightness-50). Over the blur, a centered card/panel with:
         a. Episode title at top: "Episode {episodeNumber}" in smaller text
         b. Main heading: "Unlock all {totalEpisodes} episodes of {seasonTitle || Season N}"
         c. Series title below heading
         d. Price display: formatted price
         e. UnlockButton component for single-season unlock
         f. Small text below: "Instant access to all episodes after purchase"
       - The paywall should feel premium and cinematic (dark card with subtle border, brand-yellow accents).
       - Use Image component for thumbnail background if thumbnailUrl exists.

    3. Create `src/app/checkout/success/page.tsx`:
       - This is a server component page.
       - Read `searchParams.session_id` from URL.
       - Retrieve the Checkout Session from Stripe directly (using the stripe client from `@/lib/stripe/client`) with `stripe.checkout.sessions.retrieve(sessionId)` to handle the fulfillment race condition (webhook may not have fired yet).
       - If `session.payment_status === 'paid'`:
         a. Also do backup fulfillment: check if purchase exists in DB. If not, insert it (same logic as webhook but via admin client). This handles the race condition per research Pitfall 2.
         b. Display "Season Unlocked!" confirmation screen.
         c. Show the season/series info from session metadata.
         d. Show a link to the series page: "Start Watching" button.
       - If session not found or not paid, show an error state with a link back to browse.
       - Design: centered card on dark background, checkmark icon, brand-yellow accent on "Unlocked!" text.

    4. Create `src/app/checkout/cancel/page.tsx`:
       - Simple page showing "Checkout Cancelled" with a message and a "Back to Browsing" link.
       - Also include a "Try Again" link back to the series page if `seriesSlug` is available via searchParams.
  </action>
  <verify>
    - `pnpm build` succeeds
    - `season-paywall.tsx` renders paywall with episode info, price, and unlock button
    - `unlock-button.tsx` handles click -> fetch -> redirect flow with loading state
    - `success/page.tsx` retrieves session from Stripe and shows confirmation
    - `cancel/page.tsx` renders with appropriate messaging
  </verify>
  <done>
    Paywall shows as an inline overlay with blurred thumbnail background, displaying episode context, season value proposition, price, and a prominent unlock CTA. Unlock button handles auth redirect for unauthenticated users and checkout redirect for authenticated users. Success page shows "Season Unlocked!" confirmation with backup fulfillment for the webhook race condition. Cancel page provides a graceful return path.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate purchase checks into episode page and update series page with pricing</name>
  <files>
    src/app/(browse)/series/[slug]/episode/[episodeNumber]/page.tsx
    src/app/(browse)/series/[slug]/page.tsx
    src/components/series/series-detail.tsx
    src/components/series/season-tabs.tsx
    src/components/series/episode-list-item.tsx
  </files>
  <action>
    1. Update `src/app/(browse)/series/[slug]/episode/[episodeNumber]/page.tsx`:
       - Import `hasUserPurchasedSeason` from `@/modules/purchases/queries/get-user-purchases`.
       - Import `SeasonPaywall` from `@/components/paywall/season-paywall`.
       - Change the `payment_required` block: Instead of the placeholder "Coming in Phase 5" message, now:
         a. Fetch the season data for this episode (season_id is already available from the episode query).
         b. Query season details: price_cents, title, season_number, plus the total published episode count for that season, plus the series thumbnail_url.
         c. Render the `<SeasonPaywall>` component with all necessary props.
       - Change the access check: Replace `checkEpisodeAccess(episodeNumber, user, false)` with:
         ```
         const hasPurchased = user
           ? await hasUserPurchasedSeason(user.id, episode.season_id)
           : false;
         const access = checkEpisodeAccess(episodeNumber, user, hasPurchased);
         ```
       - Note: The episode query happens AFTER the access check (for the player), but the paywall needs season data BEFORE rendering. Restructure: first fetch the episode metadata (to get season_id), then check access, then either render paywall or player.
       - Move the episode data fetch to happen BEFORE the access check so we have `season_id` available. Only the VideoPlayerShell rendering needs to stay after the access check.
       - For the `auth_required` block: Keep the existing signup/login redirect, but also show the paywall behind it (or just keep the current clean signup prompt -- the user decision says "unauthenticated users see the paywall first, then login/signup prompted when they click unlock"). So actually for auth_required, render the full SeasonPaywall component. The UnlockButton inside it will handle the login redirect when clicked.
       - UPDATE the auth_required flow: For episodes 4+, when user is not logged in, show the SeasonPaywall (not the current "Sign Up to Continue" message). The paywall shows the value proposition. The UnlockButton handles redirect to login when clicked by an unauthenticated user. This implements "value before account."

    2. Update `src/app/(browse)/series/[slug]/page.tsx` (server component):
       - Import `getUserSeasonPurchases` from `@/modules/purchases/queries/get-user-purchases`.
       - After fetching series data, check auth: get user from supabase.
       - If user exists, call `getUserSeasonPurchases(user.id, seasonIds)` to get a Set of purchased season IDs.
       - Pass `purchasedSeasonIds` set to `SeriesDetail` component (or empty Set if no user).

    3. Update `src/components/series/series-detail.tsx`:
       - Add to props: `purchasedSeasonIds: Set<string>`, `bundleDiscountPercent: number | null`.
       - Pass `purchasedSeasonIds` to `SeasonTabs`.
       - If multiple seasons exist AND there are unpurchased seasons: show an "Unlock All Seasons" section below the share button with:
         a. Calculate bundle price from season prices minus discount.
         b. Show original total (crossed out) and discounted bundle price.
         c. Render an `UnlockButton` with `purchaseType='bundle'`.
       - If all seasons are already purchased, don't show the bundle section.
       - Add `price_cents` to the season data interface used by this component.

    4. Update `src/components/series/season-tabs.tsx`:
       - Add to props: `purchasedSeasonIds: Set<string>`.
       - For each season tab/section, show pricing info:
         a. If season is in `purchasedSeasonIds`: show a "Purchased" badge (brand-yellow bg, black text) instead of any price or unlock CTA.
         b. If season is NOT purchased and has a price: show the price and a small "Unlock" button/link.
       - Pass `isPurchased` boolean to each `EpisodeListItem`.

    5. Update `src/components/series/episode-list-item.tsx`:
       - Add optional prop: `isPurchased?: boolean`.
       - Modify the lock/badge logic:
         a. If `isFree` -> show green "Free" badge (unchanged).
         b. If `isPurchased` -> show no badge, no lock icon (normal appearance per user decision: "unlocked episodes look normal").
         c. If NOT free and NOT purchased -> show lock icon (unchanged).
  </action>
  <verify>
    - `pnpm build` succeeds
    - Episode page at episode 4+ shows paywall with season info and price (not "Coming in Phase 5")
    - Series page passes purchasedSeasonIds to detail component
    - Season tabs show "Purchased" badge for owned seasons
    - Episode list items show no lock for purchased episodes
    - Unauthenticated users see paywall (not signup prompt) for episodes 4+
  </verify>
  <done>
    Episode page integrates real purchase checks: episodes 1-3 are free, episodes 4+ show an inline paywall overlay for non-purchasers (including unauthenticated users who see value before being asked to log in). Series page shows "Purchased" badges on owned seasons, pricing and unlock buttons on unowned seasons, and an all-seasons bundle option at a discount. Episode list items show clean state for purchased content (no lock icon).
  </done>
</task>

</tasks>

<verification>
- `pnpm build` passes with no errors
- Episode page renders paywall for episode 4+ when season is not purchased
- Paywall shows episode context, season value, price, and unlock CTA
- Clicking unlock redirects to Stripe Checkout (or to login if unauthenticated)
- Success page retrieves Stripe session and shows "Season Unlocked!" confirmation
- Series page shows "Purchased" badge on owned seasons
- Bundle pricing shows on series page when multiple seasons exist
- Lock icons only appear on non-free, non-purchased episodes
</verification>

<success_criteria>
- User navigating to episode 4+ sees an inline paywall overlay with season info, episode count, price, and unlock CTA
- Unauthenticated users see the paywall with value proposition; login is prompted only when they click unlock
- After payment, success page confirms "Season Unlocked!" with link to start watching
- Series detail page shows "Purchased" badge on owned seasons, pricing on unowned, and bundle option
- Episode list items show no lock icon for purchased episodes
</success_criteria>

<output>
After completion, create `.planning/phases/05-payments-monetization/05-02-SUMMARY.md`
</output>
