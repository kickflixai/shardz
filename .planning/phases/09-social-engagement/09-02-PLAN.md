---
phase: 09-social-engagement
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/app/(profile)/layout.tsx
  - src/app/(profile)/profile/page.tsx
  - src/app/(profile)/profile/favorites/page.tsx
  - src/app/(profile)/profile/history/page.tsx
  - src/app/(profile)/profile/settings/page.tsx
  - src/app/(profile)/profile/settings/profile-settings-form.tsx
  - src/app/(public)/user/[username]/page.tsx
  - src/components/social/favorite-button.tsx
  - src/modules/social/hooks/use-watch-tracker.ts
  - src/app/(browse)/series/[slug]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can view their profile with favorites, followed creators, and recent activity tabs"
    - "User can view their private watch history and unlocked content"
    - "User can update display name, toggle watch history visibility, and upload avatar"
    - "User can save a series to favorites with a heart button and see it in their favorites list"
    - "Any user can view another user's public activity page showing favorites and followed creators"
  artifacts:
    - path: "src/app/(profile)/profile/page.tsx"
      provides: "User's own profile/activity page with tabs"
    - path: "src/app/(profile)/profile/favorites/page.tsx"
      provides: "User's favorited series list"
    - path: "src/app/(profile)/profile/history/page.tsx"
      provides: "Private watch history with unlocked content"
    - path: "src/app/(public)/user/[username]/page.tsx"
      provides: "Public activity page for any user"
    - path: "src/components/social/favorite-button.tsx"
      provides: "Heart toggle for favoriting series"
    - path: "src/modules/social/hooks/use-watch-tracker.ts"
      provides: "Hook that records watch progress during playback"
  key_links:
    - from: "src/components/social/favorite-button.tsx"
      to: "src/modules/social/actions/favorites.ts"
      via: "import toggleFavorite"
      pattern: "toggleFavorite"
    - from: "src/modules/social/hooks/use-watch-tracker.ts"
      to: "src/modules/social/actions/watch-history.ts"
      via: "import recordWatchProgress"
      pattern: "recordWatchProgress"
    - from: "src/app/(profile)/profile/favorites/page.tsx"
      to: "src/modules/social/queries/get-user-favorites.ts"
      via: "import getUserFavorites"
      pattern: "getUserFavorites"
---

<objective>
Build the viewer profile pages, favorites UI, watch history tracking, and public activity pages so users have a social identity on the platform.

Purpose: Users need to see their activity (favorites, history, followed creators), manage their profile (avatar, display name), and be discoverable by other users via public activity pages. The FavoriteButton appears throughout the browse experience.

Output: Profile route group with 4 pages, public user activity page, FavoriteButton component, watch history tracking hook, and series page integration.
</objective>

<execution_context>
@/Users/solofilms/.claude/get-shit-done/workflows/execute-plan.md
@/Users/solofilms/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-social-engagement/09-RESEARCH.md
@.planning/phases/09-social-engagement/09-01-SUMMARY.md
@src/components/profile/public-profile.tsx
@src/components/profile/follow-button.tsx
@src/modules/creator/queries/get-creator-profile.ts
@src/app/(browse)/series/[slug]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Profile route group with favorites, history, settings, and public activity page</name>
  <files>
    src/app/(profile)/layout.tsx
    src/app/(profile)/profile/page.tsx
    src/app/(profile)/profile/favorites/page.tsx
    src/app/(profile)/profile/history/page.tsx
    src/app/(profile)/profile/settings/page.tsx
    src/app/(profile)/profile/settings/profile-settings-form.tsx
    src/app/(public)/user/[username]/page.tsx
  </files>
  <action>
**Create `(profile)` route group:**

1. `src/app/(profile)/layout.tsx`:
   - Server component with auth check (redirect to /login if not authenticated)
   - Reuse existing Header component
   - Simple layout wrapper

2. `src/app/(profile)/profile/page.tsx` — User's own activity/profile page:
   - Server component, fetch current user's profile, favorites count, followers/following count
   - Display avatar (with AvatarUpload component from 09-01), display name, bio
   - Tabbed navigation: "Favorites" | "Activity" | "Following"
   - "Activity" tab shows recent comments and reactions from `getUserActivity()`
   - "Following" tab shows followed creators (from existing followers table query)
   - "Favorites" tab links to `/profile/favorites` for full list; shows count inline
   - Link to `/profile/settings` for editing
   - Link to `/profile/history` for watch history

3. `src/app/(profile)/profile/favorites/page.tsx`:
   - Server component, auth required
   - Call `getUserFavorites(user.id)`
   - Render grid of favorited series cards (thumbnail, title, genre, creator name)
   - Each card links to `/series/[slug]`
   - Empty state: "No favorites yet. Browse series to find content you love."

4. `src/app/(profile)/profile/history/page.tsx`:
   - Server component, auth required
   - Call `getWatchHistory(user.id)`
   - Two sections: "Continue Watching" (incomplete episodes) and "Completed"
   - Each entry shows series thumbnail, episode title, progress bar, last watched date
   - Links to episode page
   - Also show "Unlocked Content" section: query purchases table to list purchased seasons
   - Empty state: "No watch history yet. Start watching to track your progress."

5. `src/app/(profile)/profile/settings/page.tsx`:
   - Server component, auth required, fetch current profile
   - Render ProfileSettingsForm client component

6. `src/app/(profile)/profile/settings/profile-settings-form.tsx`:
   - Client component with `useActionState` and `updateViewerProfile` action from 09-01
   - Fields: display name (text input), watch history public toggle (checkbox/switch)
   - Avatar upload section using `AvatarUpload` component from 09-01
   - Toast feedback via sonner
   - Follow the existing `profile-settings-form.tsx` pattern from Phase 6 creator settings

7. `src/app/(public)/user/[username]/page.tsx` — Public activity page:
   - Server component, NO auth required (public page)
   - Look up user by username (or display_name slug) from profiles table
   - Show avatar, display name, follower count
   - Show public data: favorited series grid, followed creators list
   - Show recent activity (comments, reactions) if user has any
   - If user has `watch_history_public = true`, show watch history section
   - 404 if user not found
   - generateMetadata for SEO (Open Graph, title)
  </action>
  <verify>
Run `pnpm build` to confirm all pages compile. Navigate to /profile, /profile/favorites, /profile/history, /profile/settings, and /user/[username] routes.
  </verify>
  <done>
Profile route group renders user's own activity (favorites, following, recent activity), watch history with progress and unlocked content, profile settings with avatar upload. Public activity page at /user/[username] shows another user's public activity. All pages follow existing auth patterns and server component conventions.
  </done>
</task>

<task type="auto">
  <name>Task 2: FavoriteButton, watch history tracker, and series page integration</name>
  <files>
    src/components/social/favorite-button.tsx
    src/modules/social/hooks/use-watch-tracker.ts
    src/app/(browse)/series/[slug]/page.tsx
  </files>
  <action>
1. **`src/components/social/favorite-button.tsx`** — Heart toggle button:
   - Client component
   - Props: `seriesId: string`, `initialFavorited: boolean`, `className?: string`
   - Uses `useOptimistic` (React 19) for instant visual toggle (same pattern as FollowButton)
   - Uses `useTransition` to call `toggleFavorite` server action
   - Heart icon from lucide-react: filled red when favorited, outline when not
   - If user not authenticated: redirect to `/login?next=/series/[slug]` on click
   - Receives auth status via prop `isAuthenticated: boolean`
   - Accessible: aria-label "Add to favorites" / "Remove from favorites"

2. **`src/modules/social/hooks/use-watch-tracker.ts`** — Watch progress tracking hook:
   - Client-side hook: `useWatchTracker(episodeId: string, isAuthenticated: boolean)`
   - Accepts a `playerRef` (MuxPlayerRefAttributes ref) and reads `currentTime` during playback
   - Throttled recording: call `recordWatchProgress` server action every 15 seconds during playback
   - On video end: record with `completed: true`
   - Skip tracking if not authenticated (anonymous viewers don't get history)
   - Use `useRef` for throttle timer to avoid re-renders
   - Cleanup: clear interval on unmount

3. **Update `src/app/(browse)/series/[slug]/page.tsx`** — Add FavoriteButton to series detail page:
   - Import FavoriteButton
   - Check if current user has favorited this series (query favorites table)
   - Render FavoriteButton next to existing share/follow controls in the series header
   - Pass `initialFavorited` and `isAuthenticated` props

Note: The watch tracker hook will be wired into the VideoPlayer component in a later plan (09-03 or 09-04) when the episode page is updated for social overlays. For now, export the hook for downstream use.
  </action>
  <verify>
Run `pnpm build` to confirm all components compile. Verify FavoriteButton renders on the series detail page. Verify use-watch-tracker.ts exports the hook.
  </verify>
  <done>
FavoriteButton component with optimistic heart toggle appears on series detail pages. Watch tracker hook is ready for video player integration. Series page queries and displays favorite status for authenticated users.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds with no TypeScript errors
2. All 7 new page/layout files exist in the (profile) route group
3. Public activity page at /user/[username] renders for any user
4. FavoriteButton toggles visually with optimistic state
5. Series detail page shows FavoriteButton
6. Watch tracker hook exports correctly
</verification>

<success_criteria>
- Authenticated user can navigate to /profile and see their activity, favorites, and followed creators
- User can view watch history at /profile/history with progress bars and unlocked content
- User can update display name, watch history visibility, and avatar at /profile/settings
- FavoriteButton appears on series pages with instant visual toggle
- Public activity page at /user/[username] shows public data for any user
- All pages follow existing authentication and server component patterns
</success_criteria>

<output>
After completion, create `.planning/phases/09-social-engagement/09-02-SUMMARY.md`
</output>
