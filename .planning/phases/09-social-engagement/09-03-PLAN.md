---
phase: 09-social-engagement
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/modules/social/hooks/use-reactions.ts
  - src/components/player/reaction-overlay.tsx
  - src/components/player/reaction-picker.tsx
  - src/app/(browse)/series/[slug]/episode/[episodeNumber]/page.tsx
  - src/components/player/player-layout.tsx
  - src/components/player/video-player.tsx
  - src/app/globals.css
autonomous: true

must_haves:
  truths:
    - "User can see live emoji reactions from concurrent viewers popping on screen as floating bubbles during playback"
    - "User can send emoji reactions via a floating picker button that expands to show 7 curated emojis"
    - "User can see accumulated past reactions replay at their original timestamps as floating bubbles scaled by count"
    - "Reaction bubbles animate upward and fade out, capped at 20 simultaneous bubbles"
    - "Reactions work on both mobile (9:16) and desktop (theater mode)"
  artifacts:
    - path: "src/modules/social/hooks/use-reactions.ts"
      provides: "Supabase Realtime broadcast hook for live reactions"
      exports: ["useReactions"]
    - path: "src/components/player/reaction-overlay.tsx"
      provides: "Floating emoji bubbles layer with pool cap"
    - path: "src/components/player/reaction-picker.tsx"
      provides: "Floating button that expands into emoji picker"
    - path: "src/app/globals.css"
      provides: "CSS keyframe animation for float-up bubbles"
      contains: "@keyframes float-up"
  key_links:
    - from: "src/modules/social/hooks/use-reactions.ts"
      to: "supabase.channel('reactions:${episodeId}')"
      via: "Realtime broadcast subscription"
      pattern: "channel.*reactions"
    - from: "src/components/player/reaction-overlay.tsx"
      to: "src/modules/social/hooks/use-reactions.ts"
      via: "import useReactions"
      pattern: "useReactions"
    - from: "src/components/player/reaction-picker.tsx"
      to: "src/modules/social/actions/reactions.ts"
      via: "import recordReaction for persistence"
      pattern: "recordReaction"
    - from: "src/components/player/video-player.tsx"
      to: "src/components/player/reaction-overlay.tsx"
      via: "Renders overlay as sibling within player container"
---

<objective>
Implement live emoji reactions via Supabase Realtime broadcast and accumulated timestamp-synced reaction replay with floating bubble animations.

Purpose: Reactions create the "watching with a crowd" experience. Live reactions show real-time engagement, and accumulated replay makes popular moments feel alive even when watching alone. This is a core differentiator for the platform's social viewing experience.

Output: Realtime broadcast hook, reaction overlay with CSS keyframe animations, emoji picker, accumulated replay engine, and full integration into the video player.
</objective>

<execution_context>
@/Users/solofilms/.claude/get-shit-done/workflows/execute-plan.md
@/Users/solofilms/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-social-engagement/09-RESEARCH.md
@.planning/phases/09-social-engagement/09-01-SUMMARY.md
@src/components/player/video-player.tsx
@src/components/player/player-layout.tsx
@src/components/player/video-player-shell.tsx
@src/app/(browse)/series/[slug]/episode/[episodeNumber]/page.tsx
@src/components/creator/community-feed.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Realtime reactions hook, overlay component, picker, and CSS animations</name>
  <files>
    src/modules/social/hooks/use-reactions.ts
    src/components/player/reaction-overlay.tsx
    src/components/player/reaction-picker.tsx
    src/app/globals.css
  </files>
  <action>
**1. CSS keyframe animation in `src/app/globals.css`:**
Add to existing globals.css (do not replace existing content):
```css
/* Reaction bubble float-up animation */
@keyframes float-up {
  0% {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
  70% {
    opacity: 1;
    transform: translateY(-60vh) scale(1.1);
  }
  100% {
    opacity: 0;
    transform: translateY(-80vh) scale(0.8);
  }
}

.reaction-bubble {
  position: absolute;
  bottom: 10%;
  animation: float-up 3s ease-out forwards;
  pointer-events: none;
  font-size: 1.75rem;
  z-index: 30;
}

@media (min-width: 768px) {
  .reaction-bubble {
    font-size: 2rem;
  }
}
```

**2. `src/modules/social/hooks/use-reactions.ts`:**
```typescript
"use client";
import { useEffect, useRef, useCallback, useState } from "react";
import { createClient } from "@/lib/supabase/client";
import type { RealtimeChannel } from "@supabase/supabase-js";
import { REACTION_EMOJIS } from "@/modules/social/actions/reactions";

interface Bubble {
  id: string;
  emoji: string;
  left: number; // percentage 10-90
}

interface ReactionEvent {
  emoji: string;
  timestamp: number;
}

const MAX_BUBBLES = 20;

export function useReactions(episodeId: string) {
  const channelRef = useRef<RealtimeChannel | null>(null);
  const [bubbles, setBubbles] = useState<Bubble[]>([]);

  const addBubble = useCallback((emoji: string) => {
    setBubbles((prev) => {
      const next = [
        ...prev,
        {
          id: crypto.randomUUID(),
          emoji,
          left: Math.random() * 80 + 10,
        },
      ];
      return next.length > MAX_BUBBLES
        ? next.slice(next.length - MAX_BUBBLES)
        : next;
    });
  }, []);

  const removeBubble = useCallback((id: string) => {
    setBubbles((prev) => prev.filter((b) => b.id !== id));
  }, []);

  // Live reactions via Supabase Realtime broadcast
  useEffect(() => {
    const supabase = createClient();
    const channel = supabase.channel(`reactions:${episodeId}`, {
      config: { broadcast: { self: true } },
    });

    channel.on("broadcast", { event: "reaction" }, (payload) => {
      const { emoji } = payload.payload as ReactionEvent;
      if (REACTION_EMOJIS.includes(emoji)) {
        addBubble(emoji);
      }
    });

    channel.subscribe();
    channelRef.current = channel;

    return () => {
      supabase.removeChannel(channel);
    };
  }, [episodeId, addBubble]);

  const sendReaction = useCallback(
    async (emoji: string, timestamp: number) => {
      await channelRef.current?.send({
        type: "broadcast",
        event: "reaction",
        payload: { emoji, timestamp },
      });
    },
    [],
  );

  return { bubbles, addBubble, removeBubble, sendReaction };
}
```

**3. `src/components/player/reaction-overlay.tsx`:**
- Client component
- Receives `bubbles` array and `removeBubble` callback from useReactions
- Also receives `accumulatedReactions` (Map<number, Array<{emoji, count}>>) and `currentTime` (number) for replay
- Replay logic: when `currentTime` changes, check `accumulatedReactions.get(currentTime)`. For each entry, stagger-add bubbles based on count (e.g., if count=10, add 10 bubbles with 100ms stagger using setTimeout, capped by pool)
- Use a `processedSeconds` ref (Set<number>) to avoid replaying the same second multiple times. Clear on seek.
- Renders bubbles as absolutely-positioned spans with `.reaction-bubble` class and inline `style={{ left: '${b.left}%' }}`
- `onAnimationEnd` calls `removeBubble(b.id)` for cleanup
- Positioned as `absolute inset-0 overflow-hidden pointer-events-none` layer within the player container
- Per user decision: "Must work on both mobile (9:16 vertical player) and desktop (theater mode)" â€” the overlay fills the player container which is already responsive via PlayerLayout

**4. `src/components/player/reaction-picker.tsx`:**
- Client component
- Props: `onReact: (emoji: string) => void`, `disabled?: boolean` (disabled when not authenticated)
- Floating circular button (bottom-right of player, position absolute) showing a flame emoji (ðŸ”¥) as default
- On tap/click: expands to show all 7 curated emojis in a vertical column or arc above the button
- Uses `useState` for open/closed state
- Each emoji button calls `onReact(emoji)` and closes the picker
- Animation: scale-in transition on open/close using Tailwind `transition-all duration-200`
- Per user decision: "Account required to react" â€” if `disabled`, show toast "Sign in to react" on tap
- Per user decision: "Just emoji in bubbles â€” no username or avatar attached" â€” no user info in picker UI either
- Responsive sizing: slightly smaller on mobile (w-10 h-10 button) vs desktop (w-12 h-12)
- z-index above overlay but below any modals
  </action>
  <verify>
Run `pnpm build` to confirm all components compile. Verify globals.css contains the float-up keyframes. Verify useReactions hook creates a broadcast channel. Verify reaction-overlay renders bubbles with animation. Verify reaction-picker renders floating button with emoji grid.
  </verify>
  <done>
Live reactions flow: user taps emoji in picker -> broadcast sent to channel -> all connected clients receive -> floating bubble appears and animates upward -> removed from DOM on animationEnd. Accumulated reactions replay at original timestamps during playback with staggered bubble spawning. All capped at 20 simultaneous bubbles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate reactions into video player and episode page</name>
  <files>
    src/components/player/video-player.tsx
    src/components/player/player-layout.tsx
    src/app/(browse)/series/[slug]/episode/[episodeNumber]/page.tsx
  </files>
  <action>
**1. Update `src/components/player/video-player.tsx`:**
- Add new props: `episodeId` (already exists), `isAuthenticated: boolean`, `accumulatedReactions?: Map<number, Array<{emoji: string; count: number}>>` (optional, loaded from server)
- Import and use `useReactions(episodeId)` hook
- Track `currentTime` via `onTimeUpdate` callback on MuxPlayer (fires ~4x/sec, use `Math.floor()` for integer seconds)
- Render `ReactionOverlay` as a sibling to MuxPlayer inside the existing relative container div
- Render `ReactionPicker` positioned absolute bottom-right within the container
- Pass overlay props: bubbles, removeBubble, accumulatedReactions, currentTime
- Pass picker props: `onReact` callback that calls both `sendReaction(emoji, currentTime)` (broadcast) and `recordReaction(episodeId, currentTime, emoji)` (persist to DB)
- The picker's `onReact` should be wrapped in `startTransition` for the server action call
- If not authenticated, pass `disabled={true}` to ReactionPicker
- Import `recordReaction` from `src/modules/social/actions/reactions.ts`
- Also import and use `useWatchTracker` hook from 09-02 if it exists, otherwise skip (it can be wired in 09-04)

**2. Update `src/components/player/player-layout.tsx`:**
- No structural changes needed â€” the overlay and picker are rendered INSIDE VideoPlayer's container div, which is already inside PlayerLayout's responsive container
- Ensure the inner container div has `position: relative` and `overflow: hidden` for bubble containment (already has relative via className)

**3. Update `src/app/(browse)/series/[slug]/episode/[episodeNumber]/page.tsx`:**
- Import `getEpisodeReactions` from `src/modules/social/queries/get-episode-reactions.ts`
- In both the free and paid episode rendering branches:
  - Call `getEpisodeReactions(episodeId)` to get accumulated reactions
  - Pass `accumulatedReactions` to `VideoPlayerShell` (which passes to `VideoPlayer`)
  - Pass `isAuthenticated: !!user` to `VideoPlayerShell`
- Update `VideoPlayerShell` to accept and forward these new props to `VideoPlayer`

**Important:** The `accumulatedReactions` Map is created server-side in the query but must be serialized for the client component boundary. Since Maps are not serializable as props, convert to a plain object `Record<number, Array<{emoji: string; count: number}>>` in the query output and reconstruct as a Map in the client component (or use the plain object with bracket access in the overlay).
  </action>
  <verify>
Run `pnpm build` to confirm everything compiles. Verify the episode page passes accumulated reactions to the player. Verify VideoPlayer renders ReactionOverlay and ReactionPicker. Verify the broadcast channel connects on mount and disconnects on unmount.
  </verify>
  <done>
Full reaction system is wired end-to-end: episode page loads accumulated reactions from DB, passes to VideoPlayer, which renders overlay (showing both live broadcast bubbles and accumulated replay bubbles) and picker (sending to broadcast channel + persisting to DB). Works on both mobile and desktop via PlayerLayout's responsive container.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds with no TypeScript errors
2. Episode page loads accumulated reactions from database
3. ReactionPicker shows 7 curated emojis on tap
4. Tapping an emoji sends a broadcast message and persists via RPC
5. Floating bubbles animate upward and disappear after 3 seconds
6. Maximum 20 simultaneous bubbles enforced
7. Accumulated reactions replay at their original timestamps during playback
8. Unauthenticated users see picker but get "Sign in to react" on tap
</verification>

<success_criteria>
- Live emoji reactions pop on screen from concurrent viewers via Supabase Realtime broadcast
- Accumulated past reactions replay at original timestamps as floating bubbles
- Popular moments get more bubbles (replay volume scales with count)
- Curated set of 7 emojis (fire, heart, laugh, cry, shocked, clap, 100)
- Float-up-from-bottom CSS animation with 3s duration
- Pool cap of 20 simultaneous bubbles prevents lag
- Floating button expands into emoji picker on tap
- Account required to react; picker button stays visible for everyone
- Works on both mobile (9:16) and desktop (theater mode)
</success_criteria>

<output>
After completion, create `.planning/phases/09-social-engagement/09-03-SUMMARY.md`
</output>
