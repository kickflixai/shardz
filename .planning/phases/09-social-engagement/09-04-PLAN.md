---
phase: 09-social-engagement
plan: 04
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/modules/social/hooks/use-comments.ts
  - src/modules/social/hooks/use-cinematic-mode.ts
  - src/components/player/comment-overlay.tsx
  - src/components/player/comment-input.tsx
  - src/components/player/cinematic-toggle.tsx
  - src/components/social/report-button.tsx
  - src/components/player/video-player.tsx
  - src/components/player/video-player-shell.tsx
  - src/app/(browse)/series/[slug]/episode/[episodeNumber]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can see scrolling comments at bottom ~25% of video replaying at the timestamp they were posted"
    - "User can post a comment that pauses the video, captures the timestamp, and resumes after sending"
    - "Comments are filtered for profanity and spam before posting"
    - "User can toggle cinematic mode to hide comments overlay and reaction bubbles"
    - "Cinematic mode preference persists across sessions via localStorage"
    - "Reaction picker button stays visible even in cinematic mode"
  artifacts:
    - path: "src/modules/social/hooks/use-comments.ts"
      provides: "Hook managing visible comments based on current playback time"
      exports: ["useComments"]
    - path: "src/modules/social/hooks/use-cinematic-mode.ts"
      provides: "localStorage-backed cinematic mode toggle"
      exports: ["useCinematicMode"]
    - path: "src/components/player/comment-overlay.tsx"
      provides: "Scrolling comments at bottom 25% of player"
    - path: "src/components/player/comment-input.tsx"
      provides: "Pause-to-comment input with timestamp capture"
    - path: "src/components/player/cinematic-toggle.tsx"
      provides: "Toggle button in player controls area"
  key_links:
    - from: "src/modules/social/hooks/use-comments.ts"
      to: "src/modules/social/queries/get-episode-comments.ts"
      via: "Receives pre-bucketed comments as prop"
      pattern: "commentBuckets"
    - from: "src/components/player/comment-input.tsx"
      to: "src/modules/social/actions/comments.ts"
      via: "import postComment"
      pattern: "postComment"
    - from: "src/components/player/cinematic-toggle.tsx"
      to: "src/modules/social/hooks/use-cinematic-mode.ts"
      via: "import useCinematicMode"
      pattern: "useCinematicMode"
    - from: "src/components/player/video-player.tsx"
      to: "src/components/player/comment-overlay.tsx"
      via: "Renders overlay conditionally based on cinematic mode"
---

<objective>
Implement timestamp-synced scrolling comments overlay with pause-to-comment input and cinematic mode toggle that hides all social overlays.

Purpose: Comments create a shared viewing experience where users see what others thought at specific moments. Cinematic mode is the escape hatch for users who want distraction-free viewing. Together they complete the social engagement layer of the platform.

Output: Comments hook, comment overlay, comment input, cinematic mode hook, cinematic toggle, report button, and full integration into the video player.
</objective>

<execution_context>
@/Users/solofilms/.claude/get-shit-done/workflows/execute-plan.md
@/Users/solofilms/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-social-engagement/09-RESEARCH.md
@.planning/phases/09-social-engagement/09-01-SUMMARY.md
@.planning/phases/09-social-engagement/09-03-SUMMARY.md
@src/components/player/video-player.tsx
@src/components/player/video-player-shell.tsx
@src/app/(browse)/series/[slug]/episode/[episodeNumber]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Comments hooks, overlay, input, cinematic mode, and report button</name>
  <files>
    src/modules/social/hooks/use-comments.ts
    src/modules/social/hooks/use-cinematic-mode.ts
    src/components/player/comment-overlay.tsx
    src/components/player/comment-input.tsx
    src/components/player/cinematic-toggle.tsx
    src/components/social/report-button.tsx
  </files>
  <action>
**1. `src/modules/social/hooks/use-comments.ts`:**
- Hook: `useComments(commentBuckets: Record<number, CommentWithProfile[]>)`
- `CommentWithProfile` type: `{ id: string; content: string; timestamp_seconds: number; display_name: string; avatar_url: string | null; user_id: string }`
- Accepts `currentTime: number` (integer seconds from player)
- Returns `visibleComments: CommentWithProfile[]` — comments where `timestamp_seconds` falls in `[currentTime - 1, currentTime]`
- Uses Map internally: on init, build `Map<number, CommentWithProfile[]>` from the Record prop
- On each currentTime change, do `Map.get(currentTime)` and `Map.get(currentTime - 1)`, merge and dedupe by id
- Returns max 5 visible comments at once (latest 5 if more exist)
- Also returns `totalComments: number` (sum of all comments in all buckets)

**2. `src/modules/social/hooks/use-cinematic-mode.ts`:**
```typescript
"use client";
import { useState, useCallback, useEffect } from "react";

const STORAGE_KEY = "microshort:cinematic-mode";

export function useCinematicMode() {
  const [enabled, setEnabled] = useState(false);

  useEffect(() => {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored === "true") setEnabled(true);
  }, []);

  const toggle = useCallback(() => {
    setEnabled((prev) => {
      const next = !prev;
      localStorage.setItem(STORAGE_KEY, String(next));
      return next;
    });
  }, []);

  return { cinematicMode: enabled, toggleCinematicMode: toggle };
}
```

**3. `src/components/player/comment-overlay.tsx`:**
- Client component
- Props: `comments: CommentWithProfile[]` (visible comments from useComments), `visible: boolean` (false in cinematic mode)
- Positioned absolute at the bottom 25% of the player container
- Semi-transparent dark gradient background at bottom: `bg-gradient-to-t from-black/60 via-black/30 to-transparent`
- Comments appear at bottom and scroll upward within the overlay zone
- Each comment shows: display name (small, muted) + content (white text)
- Font size: 0.8125rem (13px) on mobile, 0.875rem (14px) on desktop
- Opacity: comment bubbles at 0.85 background, 1.0 text
- Transition: fade in from bottom, slide upward
- CSS animation for individual comments: `@keyframes comment-slide-up` (add to globals.css) — translate from bottom to top of overlay zone over 6 seconds, then fade out
- `onAnimationEnd` removes comment from visible list (or let useComments manage visibility window)
- Hidden when `visible={false}` (cinematic mode): `opacity-0 pointer-events-none transition-opacity duration-300`
- Report button (small flag icon) appears on hover/long-press on each comment

**4. `src/components/player/comment-input.tsx`:**
- Client component
- Props: `episodeId: string`, `onPause: () => void`, `onResume: () => void`, `capturedTimestamp: number`, `isAuthenticated: boolean`
- Floating comment button (bottom-left of player, speech bubble icon from lucide-react)
- On tap: calls `onPause()` to pause video, opens text input
- **Per user decision: "Pause-to-comment — posting a comment pauses the video, resumes after sending"**
- **Per pitfall: capture `currentTime` at the moment input opens, store in state, use THAT timestamp for the comment**
- Input field: max 300 chars, char counter shown
- Submit button sends to `postComment` server action with episodeId, content, capturedTimestamp
- On success: close input, call `onResume()` to resume playback, show toast "Comment posted"
- On error (profanity/spam): show error message inline, keep input open, video stays paused
- If not authenticated: redirect to login on tap (same pattern as FavoriteButton)
- Uses `useActionState` for form submission following existing patterns
- Accessible: aria-label "Post a comment"

**5. `src/components/player/cinematic-toggle.tsx`:**
- Client component
- Props: `cinematicMode: boolean`, `onToggle: () => void`
- Renders as an absolutely-positioned button overlaid on the player, visually aligned with the bottom control bar area
- **Per user decision: "Toggle lives in the player controls bar alongside play/pause, volume, fullscreen"**
- **Per research pitfall: Place outside MuxPlayer shadow DOM, position absolutely to appear integrated**
- Position: absolute bottom-right area of player, above the reaction picker, `bottom-12 right-3` (above MuxPlayer's own controls)
- Icon: `Eye` (lucide-react) when social is on, `EyeOff` when cinematic mode is active
- Tooltip: "Cinematic mode" / "Show social"
- Small button: `w-8 h-8` with semi-transparent background `bg-black/50 hover:bg-black/70`
- **Per user decision: "Default state: social on"** — initial state from useCinematicMode (defaults to false = social on)
- **Per user decision: "Hides both comments overlay and floating reaction bubbles (reaction picker button stays visible)"**

**6. `src/components/social/report-button.tsx`:**
- Client component
- Props: `contentType: "comment" | "series" | "episode"`, `contentId: string`
- Small flag icon button (lucide-react Flag icon)
- On click: calls `reportContent` server action
- Shows toast "Reported. We'll review this content."
- Uses `useTransition` for pending state
  </action>
  <verify>
Run `pnpm build` to confirm all components compile. Verify comment-overlay renders with gradient background. Verify comment-input calls postComment action. Verify cinematic-toggle reads/writes localStorage. Verify report-button calls reportContent action.
  </verify>
  <done>
Comment overlay displays timestamp-synced comments scrolling upward in the bottom 25% of the player. Comment input pauses video, captures timestamp, validates with profanity filter, and resumes on send. Cinematic toggle hides comments and reaction bubbles with persisted preference. Report button flags content for moderation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate comments and cinematic mode into video player and episode page</name>
  <files>
    src/components/player/video-player.tsx
    src/components/player/video-player-shell.tsx
    src/app/(browse)/series/[slug]/episode/[episodeNumber]/page.tsx
  </files>
  <action>
**1. Update `src/components/player/video-player.tsx`:**
- Import `useCinematicMode` from `src/modules/social/hooks/use-cinematic-mode.ts`
- Import `useComments` from `src/modules/social/hooks/use-comments.ts`
- Import `CommentOverlay` from `./comment-overlay`
- Import `CommentInput` from `./comment-input`
- Import `CinematicToggle` from `./cinematic-toggle`
- Add new props: `comments?: Record<number, CommentWithProfile[]>` (pre-bucketed comments from server)
- Initialize `useCinematicMode()` → `{ cinematicMode, toggleCinematicMode }`
- Initialize `useComments(comments ?? {})` with `currentTime` state (already tracked for reactions from 09-03)
- Track `currentTime` state via MuxPlayer `onTimeUpdate` (may already be in place from 09-03 — reuse the same state, do not duplicate)
- Render `CommentOverlay` with `visible={!cinematicMode}` and `comments={visibleComments}`
- Render `CommentInput` with:
  - `episodeId`
  - `onPause`: `() => playerRef.current?.pause()`
  - `onResume`: `() => playerRef.current?.play()`
  - `capturedTimestamp`: pass a callback that reads `Math.floor(playerRef.current?.currentTime ?? 0)` at the moment input opens
  - `isAuthenticated`
- Render `CinematicToggle` with `cinematicMode` and `onToggle={toggleCinematicMode}`
- **Per user decision:** Reaction overlay and comment overlay both respect cinematic mode: pass `visible={!cinematicMode}` to ReactionOverlay (update the prop from 09-03 if it doesn't already exist). Reaction picker stays visible regardless.
- Also integrate `useWatchTracker` from 09-02 if available: call with `episodeId`, `isAuthenticated`, and `playerRef` to record watch progress every 15 seconds during playback

**Layering order within the player container div (bottom to top z-index):**
1. MuxPlayer (base)
2. CommentOverlay (z-10, bottom 25%)
3. ReactionOverlay (z-20, full height for floating bubbles)
4. CinematicToggle (z-30, bottom-right above controls)
5. ReactionPicker (z-30, bottom-right below cinematic toggle)
6. CommentInput button (z-30, bottom-left)
7. AutoContinue overlay (z-40, when shown)

**2. Update `src/components/player/video-player-shell.tsx`:**
- Accept new props: `comments?: Record<number, CommentWithProfile[]>`, `isAuthenticated: boolean`
- Forward these to `VideoPlayer`

**3. Update `src/app/(browse)/series/[slug]/episode/[episodeNumber]/page.tsx`:**
- Import `getEpisodeComments` from `src/modules/social/queries/get-episode-comments.ts`
- In both rendering branches (free and paid episodes):
  - Call `getEpisodeComments(episodeId)` to load pre-bucketed comments
  - Pass `comments` to `VideoPlayerShell`
  - Ensure `isAuthenticated` is already being passed (from 09-03, or add if not)
- The comments are loaded server-side and passed as serializable Record<number, CommentWithProfile[]> to the client component

**Handle potential conflicts with 09-03:**
- 09-03 adds `accumulatedReactions` and `isAuthenticated` props to VideoPlayer/Shell/page
- 09-04 adds `comments` prop to the same files
- If 09-03 has already modified these files, merge carefully:
  - VideoPlayer already has `useReactions`, `onTimeUpdate` with currentTime state, ReactionOverlay, ReactionPicker
  - 09-04 adds `useComments`, `useCinematicMode`, CommentOverlay, CommentInput, CinematicToggle
  - Combine into same component — they share `currentTime` state and the same container div
- If 09-03 has NOT run yet (this plan runs first), add all integration points including placeholder comments for where reactions will go
  </action>
  <verify>
Run `pnpm build` to confirm everything compiles. Verify episode page loads both comments and reactions. Verify VideoPlayer renders all overlay components. Verify cinematic mode toggle hides comments and reaction bubbles but not the reaction picker. Verify comment input pauses video and captures timestamp.
  </verify>
  <done>
Complete social engagement layer integrated into the video player: timestamp-synced scrolling comments, pause-to-comment with profanity filter, cinematic mode toggle hiding overlays with persisted preference, watch progress tracking. All social features work together in the same player container on both mobile and desktop viewports.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds with no TypeScript errors
2. Episode page loads pre-bucketed comments from database
3. Comments appear at bottom 25% of player at their original timestamps
4. Comment input pauses video, captures timestamp, resumes after posting
5. Profanity filter blocks inappropriate comments
6. Cinematic mode toggle hides comments and reaction bubbles
7. Cinematic mode preference persists across page reloads (localStorage)
8. Reaction picker stays visible in cinematic mode
9. Report button flags comments for moderation
10. All overlays render correctly on both mobile (9:16) and desktop (theater mode)
</verification>

<success_criteria>
- Comments scroll upward in bottom 25% of video, semi-transparent, synced to timestamps
- Posting a comment pauses the video and resumes after sending with accurate timestamp
- Comments rejected if they contain profanity, are all-caps > 10 chars, or have 3+ repeated chars
- Cinematic mode toggle hides comments and reaction bubbles but keeps picker visible
- Default state is social on; preference persists via localStorage
- Toggle is visually positioned near the player controls area
- Report/flag button available on comments for after-the-fact moderation
- Works properly on both mobile and desktop player layouts
</success_criteria>

<output>
After completion, create `.planning/phases/09-social-engagement/09-04-SUMMARY.md`
</output>
